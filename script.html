<script>
        // URL do Google Apps Script - ATUALIZE COM SUA URL
        const SCRIPT_URL = 'https://script.google.com/a/macros/isgh.org.br/s/AKfycbzbGb6sQR1auYsyTB-kwPos7Cd7swLuTUDiAzzpwTPW2cj76ykYzKYgBDXA-g5ef7pbpw/exec';
        const DESCARTE_HABILITADO = false;
        // Estado da aplica칞칚o
        function criarEstadoLiberacaoInicial() {
            return {
                colunas: [],
                linhas: [],
                filtros: {
                    dataInicio: '',
                    dataFim: '',
                    paciente: '',
                    prontuario: ''
                },
                chaveFiltrosAplicados: '',
                totalPlanilha: 0,
                totalFiltrado: 0,
                carregando: false,
                ultimaAtualizacao: null,
                linhasCarregadas: false,
                erro: ''
            };
        }
        function criarEstadoOcupacaoAcompanhantesInicial() {
            return {
                filtro: '',
                armarioSelecionado: '',
                rascunhos: {}
            };
        }
        function criarEstadoDescarteInicial() {
            return {
                itens: [],
                resumo: {
                    noPrazo: 0,
                    alerta: 0,
                    vencido: 0,
                    pendenteAlta: 0,
                    descartado: 0
                }
            };
        }
        function criarEstadoInicial() {
            return {
                perfilAtual: 'geral',
                unidadeAtual: 'todas',
                filtrosSelecionados: ['todos'],
                buscaDashboard: '',
                ocultarDadosDashboard: false,
                paginaAtual: 'dashboard',
                armarios: [],
                armariosCarregados: false,
                cadastroArmarios: [],
                unidades: [],
                setores: [],
                notificacoes: [],
                termos: {},
                movimentacoes: {},
                usuarios: [],
                logs: [],
                carregamentoTermosId: 0,
                autenticado: false,
                usuarioAutenticado: null,
                liberacao: criarEstadoLiberacaoInicial(),
                ocupacaoAcompanhantes: criarEstadoOcupacaoAcompanhantesInicial(),
                descarte: DESCARTE_HABILITADO ? criarEstadoDescarteInicial() : null
            };
        }
        let estado = criarEstadoInicial();
        function obterEstadoLiberacao() {
            if (!estado.liberacao) {
                estado.liberacao = criarEstadoLiberacaoInicial();
            }
            return estado.liberacao;
        }
        function obterEstadoOcupacaoAcompanhantes() {
            if (!estado.ocupacaoAcompanhantes) {
                estado.ocupacaoAcompanhantes = criarEstadoOcupacaoAcompanhantesInicial();
            }
            return estado.ocupacaoAcompanhantes;
        }
        const STORAGE_KEYS = {
            sessaoUsuario: 'locknac_sessao_usuario',
            rascunhosOcupacao: 'locknac_rascunhos_ocupacao',
            rascunhoArmario: 'locknac_rascunho_armario',
            rascunhoTermo: 'locknac_rascunho_termo'
        };
        const travaRolagem = {
            contador: 0,
            aplicar() {
                this.contador += 1;
                document.body.classList.add('modal-open');
            },
            remover() {
                if (this.contador > 0) {
                    this.contador -= 1;
                }
                if (this.contador === 0) {
                    document.body.classList.remove('modal-open');
                }
            }
        };
        const SESSAO_TTL_MS = 1000 * 60 * 60 * 8; // 8 horas
        const AVATAR_OPTIONS = [
            {
                id: 'avatar-none',
                label: 'Sem imagem',
                initials: '游뗵',
                background: 'linear-gradient(135deg, #e5e7eb, #f9fafb)',
                textColor: '#1f2937'
            },
            {
                id: 'avatar-astronaut',
                label: 'Astronauta',
                url: 'https://api.dicebear.com/7.x/bottts-neutral/png?seed=Astronauta&backgroundColor=1f2937'
            },
            {
                id: 'avatar-guardiao',
                label: 'Guardi칚o',
                url: 'https://api.dicebear.com/7.x/adventurer-neutral/png?seed=Guardiao&backgroundColor=f9fafb'
            },
            {
                id: 'avatar-exploradora',
                label: 'Exploradora',
                url: 'https://api.dicebear.com/7.x/croodles-neutral/png?seed=Exploradora&backgroundColor=f2f2f2'
            },
            {
                id: 'avatar-raposa',
                label: 'Raposa',
                url: 'https://api.dicebear.com/7.x/lorelei-neutral/png?seed=Raposa&backgroundColor=fee2e2'
            },
            {
                id: 'avatar-robotica',
                label: 'Rob칩tica',
                url: 'https://api.dicebear.com/7.x/bottts/png?seed=Robotica&backgroundColor=dbebff'
            }
        ];
        let armazenamentoLocalDisponivel;
        let rascunhosOcupacaoRestaurados = false;
        function removerRascunhoChave(chave) {
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            try {
                storage.removeItem(chave);
            } catch (erro) {
                console.warn('Falha ao limpar rascunho local:', erro);
            }
        }
        function obterArmazenamentoLocal() {
            if (armazenamentoLocalDisponivel !== undefined) {
                return armazenamentoLocalDisponivel;
            }
            try {
                if (typeof window !== 'undefined' && window.localStorage) {
                    const chaveTeste = '__locknac_sessao_teste__';
                    window.localStorage.setItem(chaveTeste, '1');
                    window.localStorage.removeItem(chaveTeste);
                    armazenamentoLocalDisponivel = window.localStorage;
                    return armazenamentoLocalDisponivel;
                }
            } catch (erro) {
                console.warn('Armazenamento local indispon칤vel:', erro);
            }
            armazenamentoLocalDisponivel = null;
            return armazenamentoLocalDisponivel;
        }
        function salvarSessaoUsuario(usuario) {
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            try {
                const dados = {
                    usuario,
                    atualizadoEm: Date.now()
                };
                storage.setItem(STORAGE_KEYS.sessaoUsuario, JSON.stringify(dados));
            } catch (erro) {
                console.warn('N칚o foi poss칤vel salvar a sess칚o do usu치rio:', erro);
            }
        }
        function restaurarSessaoUsuario() {
            const storage = obterArmazenamentoLocal();
            if (!storage) return null;
            try {
                const dadosBrutos = storage.getItem(STORAGE_KEYS.sessaoUsuario);
                if (!dadosBrutos) {
                    return null;
                }
                const dados = JSON.parse(dadosBrutos);
                if (!dados || !dados.usuario) {
                    return null;
                }
                if (dados.atualizadoEm && (Date.now() - dados.atualizadoEm) > SESSAO_TTL_MS) {
                    storage.removeItem(STORAGE_KEYS.sessaoUsuario);
                    return null;
                }
                return dados.usuario;
            } catch (erro) {
                console.warn('Falha ao restaurar sess칚o do usu치rio:', erro);
                try {
                    storage.removeItem(STORAGE_KEYS.sessaoUsuario);
                } catch (erroRemocao) {
                    console.warn('N칚o foi poss칤vel limpar sess칚o inv치lida:', erroRemocao);
                }
                return null;
            }
        }
        function limparSessaoUsuario() {
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            try {
                storage.removeItem(STORAGE_KEYS.sessaoUsuario);
            } catch (erro) {
                console.warn('N칚o foi poss칤vel limpar a sess칚o do usu치rio:', erro);
            }
        }
        function persistirSessaoAtual() {
            if (estado.autenticado && estado.usuarioAutenticado) {
                const usuarioAtual = {
                    ...estado.usuarioAutenticado,
                    unidades: normalizarListaDeUnidades(estado.usuarioAutenticado.unidades)
                };
                salvarSessaoUsuario(usuarioAtual);
            } else {
                limparSessaoUsuario();
            }
        }
        function coletarCamposArmario() {
            const formulario = elementos.armarioForm;
            return {
                meta: {
                    armarioId: normalizarIdentificador(formulario?.dataset.armarioId || ''),
                    numero: (formulario?.dataset.numero || '').toString(),
                    tipo: (formulario?.dataset.tipo || '').toString()
                },
                valores: {
                    nomeVisitante: document.getElementById('nome-visitante')?.value || '',
                    nomePaciente: document.getElementById('nome-paciente')?.value || '',
                    leito: document.getElementById('leito')?.value || '',
                    whatsapp: document.getElementById('whatsapp-contato')?.value || '',
                    volumes: document.getElementById('volumes')?.value || '',
                    horaPrevista: elementos.horaPrevistaInput?.value || '',
                    visitaEstendida: Boolean(elementos.visitaEstendidaInput?.checked)
                }
            };
        }
        function salvarRascunhoArmario() {
            const storage = obterArmazenamentoLocal();
            if (!storage || !elementos.armarioForm || elementos.armarioModal?.style.display === 'none') {
                return;
            }
            const dados = coletarCamposArmario();
            const possuiDados = Object.values(dados.valores).some(valor => {
                if (typeof valor === 'boolean') return valor;
                return (valor || '').toString().trim();
            });
            try {
                if (!possuiDados) {
                    removerRascunhoChave(STORAGE_KEYS.rascunhoArmario);
                    return;
                }
                storage.setItem(STORAGE_KEYS.rascunhoArmario, JSON.stringify(dados));
            } catch (erro) {
                console.warn('N칚o foi poss칤vel salvar o rascunho do arm치rio localmente:', erro);
            }
        }
        function restaurarRascunhoArmario() {
            const storage = obterArmazenamentoLocal();
            if (!storage || !elementos.armarioForm) return;
            try {
                const bruto = storage.getItem(STORAGE_KEYS.rascunhoArmario);
                if (!bruto) return;
                const dados = JSON.parse(bruto);
                const metaAtual = coletarCamposArmario().meta;
                const metaSalva = dados?.meta || {};
                const metaIncompativel = (metaAtual.armarioId && metaSalva.armarioId && metaAtual.armarioId !== metaSalva.armarioId)
                    || (metaAtual.numero && metaSalva.numero && metaAtual.numero !== metaSalva.numero)
                    || (metaAtual.tipo && metaSalva.tipo && metaAtual.tipo !== metaSalva.tipo);
                if (metaIncompativel) return;
                const valores = dados?.valores || {};
                if (document.getElementById('nome-visitante')) document.getElementById('nome-visitante').value = valores.nomeVisitante || '';
                if (document.getElementById('nome-paciente')) document.getElementById('nome-paciente').value = valores.nomePaciente || '';
                if (document.getElementById('leito')) document.getElementById('leito').value = aplicarMascaraLeito(valores.leito || '');
                if (document.getElementById('whatsapp-contato')) document.getElementById('whatsapp-contato').value = valores.whatsapp || '';
                if (document.getElementById('volumes')) document.getElementById('volumes').value = valores.volumes || '';
                if (elementos.horaPrevistaInput) elementos.horaPrevistaInput.value = valores.horaPrevista || '';
                if (elementos.visitaEstendidaInput) elementos.visitaEstendidaInput.checked = Boolean(valores.visitaEstendida);
                atualizarInterfaceVisitaEstendida({ manterHorarioManual: true });
            } catch (erro) {
                console.warn('Falha ao restaurar rascunho do arm치rio:', erro);
                removerRascunhoChave(STORAGE_KEYS.rascunhoArmario);
            }
        }
        function limparRascunhoArmario() {
            removerRascunhoChave(STORAGE_KEYS.rascunhoArmario);
        }
        function coletarRascunhoTermo() {
            const meta = {
                armarioId: normalizarIdentificador(termoArmarioAtual || ''),
                numero: (elementos.termoArmario?.textContent || '').toString().trim()
            };
            const nascimentoValor = elementos.termoNascimento?.value || '';
            return {
                meta,
                passo: termoPassoAtual,
                valores: {
                    paciente: document.getElementById('termo-paciente')?.value || '',
                    prontuario: document.getElementById('termo-prontuario')?.value || '',
                    nascimento: nascimentoValor,
                    setor: elementos.termoSetor?.value || '',
                    leito: document.getElementById('termo-leito')?.value || '',
                    consciente: document.querySelector('input[name="termo-consciente"]:checked')?.value || '',
                    acompanhante: document.getElementById('termo-resp-nome')?.value || '',
                    telefone: document.getElementById('termo-resp-telefone')?.value || '',
                    documento: document.getElementById('termo-resp-doc')?.value || '',
                    parentesco: document.getElementById('termo-resp-parentesco')?.value || ''
                },
                orientacoes: ['ori1', 'ori2', 'ori3'].filter(chave => document.getElementById(`termo-${chave}`)?.checked),
                volumes: obterVolumesTermo(),
                assinatura: termoAssinaturaDesenhada && elementos.termoAssinaturaCanvas
                    ? elementos.termoAssinaturaCanvas.toDataURL('image/png')
                    : ''
            };
        }
        function salvarRascunhoTermo() {
            if (termoArmarioAtual === null) return;
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            const rascunho = coletarRascunhoTermo();
            const campos = [rascunho.valores.paciente, rascunho.valores.prontuario, rascunho.valores.nascimento,
                rascunho.valores.setor, rascunho.valores.leito, rascunho.valores.consciente, rascunho.valores.acompanhante,
                rascunho.valores.telefone, rascunho.valores.documento, rascunho.valores.parentesco];
            const possuiDados = campos.some(valor => (valor || '').toString().trim())
                || (rascunho.orientacoes && rascunho.orientacoes.length > 0)
                || (rascunho.volumes && rascunho.volumes.some(v => (v.quantidade || v.descricao)))
                || Boolean(rascunho.assinatura);
            try {
                if (!possuiDados) {
                    removerRascunhoChave(STORAGE_KEYS.rascunhoTermo);
                    return;
                }
                storage.setItem(STORAGE_KEYS.rascunhoTermo, JSON.stringify(rascunho));
            } catch (erro) {
                console.warn('N칚o foi poss칤vel salvar o rascunho do termo localmente:', erro);
            }
        }
        function restaurarRascunhoTermo() {
            const storage = obterArmazenamentoLocal();
            if (!storage || termoArmarioAtual === null) return;
            try {
                const bruto = storage.getItem(STORAGE_KEYS.rascunhoTermo);
                if (!bruto) return;
                const dados = JSON.parse(bruto);
                const metaSalva = dados?.meta || {};
                const armarioAtual = normalizarIdentificador(termoArmarioAtual);
                if (metaSalva.armarioId && normalizarIdentificador(metaSalva.armarioId) !== armarioAtual) return;
                const valores = dados?.valores || {};
                const nascimento = valores.nascimento || '';
                if (document.getElementById('termo-paciente')) document.getElementById('termo-paciente').value = valores.paciente || '';
                if (document.getElementById('termo-prontuario')) document.getElementById('termo-prontuario').value = valores.prontuario || '';
                if (elementos.termoNascimento) {
                    elementos.termoNascimento.value = nascimento;
                    const iso = converterDataTextoParaISO(nascimento);
                    if (iso) {
                        elementos.termoNascimento.dataset.isoValue = iso;
                    } else {
                        delete elementos.termoNascimento.dataset.isoValue;
                    }
                }
                if (elementos.termoSetor) elementos.termoSetor.value = valores.setor || '';
                if (document.getElementById('termo-leito')) document.getElementById('termo-leito').value = aplicarMascaraLeito(valores.leito || '');
                if (document.getElementById('termo-resp-nome')) document.getElementById('termo-resp-nome').value = valores.acompanhante || '';
                if (document.getElementById('termo-resp-telefone')) document.getElementById('termo-resp-telefone').value = valores.telefone || '';
                if (document.getElementById('termo-resp-doc')) document.getElementById('termo-resp-doc').value = valores.documento || '';
                if (document.getElementById('termo-resp-parentesco')) document.getElementById('termo-resp-parentesco').value = valores.parentesco || '';
                if (valores.consciente) {
                    const radio = document.querySelector(`input[name="termo-consciente"][value="${valores.consciente}"]`);
                    if (radio) radio.checked = true;
                }
                ['ori1', 'ori2', 'ori3'].forEach(chave => {
                    const checkbox = document.getElementById(`termo-${chave}`);
                    if (checkbox) {
                        checkbox.checked = Boolean(dados?.orientacoes?.includes(chave));
                    }
                });
                if (Array.isArray(dados?.volumes)) {
                    prepararVolumesTermo(dados.volumes);
                }
                if (dados?.assinatura) {
                    restaurarAssinaturaTermo(dados.assinatura);
                }
                mostrarPassoTermo(Number.isInteger(dados?.passo) ? dados.passo : 0);
            } catch (erro) {
                console.warn('Falha ao restaurar rascunho do termo:', erro);
                removerRascunhoChave(STORAGE_KEYS.rascunhoTermo);
            }
        }
        function limparRascunhoTermo() {
            removerRascunhoChave(STORAGE_KEYS.rascunhoTermo);
        }
        function rascunhoOcupacaoTemDados(rascunho) {
            if (!rascunho) return false;
            return ['paciente', 'prontuario', 'acompanhante'].some(campo => (rascunho[campo] || '').toString().trim());
        }
        function persistirRascunhosOcupacaoLocal() {
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            try {
                const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
                const rascunhosOriginais = estadoOcupacao.rascunhos || {};
                const rascunhosFiltrados = {};
                Object.entries(rascunhosOriginais).forEach(([id, valores]) => {
                    if (rascunhoOcupacaoTemDados(valores)) {
                        rascunhosFiltrados[id] = {
                            paciente: (valores.paciente || '').toString(),
                            prontuario: (valores.prontuario || '').toString(),
                            acompanhante: (valores.acompanhante || '').toString()
                        };
                    }
                });
                estadoOcupacao.rascunhos = rascunhosFiltrados;
                storage.setItem(STORAGE_KEYS.rascunhosOcupacao, JSON.stringify({ rascunhos: rascunhosFiltrados }));
            } catch (erro) {
                console.warn('N칚o foi poss칤vel salvar os rascunhos de ocupa칞칚o localmente:', erro);
            }
        }
        function restaurarRascunhosOcupacaoLocal() {
            if (rascunhosOcupacaoRestaurados) return;
            const storage = obterArmazenamentoLocal();
            if (!storage) return;
            try {
                const dados = storage.getItem(STORAGE_KEYS.rascunhosOcupacao);
                if (!dados) return;
                const json = JSON.parse(dados);
                const rascunhosRestaurados = {};
                Object.entries(json?.rascunhos || {}).forEach(([id, valores]) => {
                    if (!id) return;
                    rascunhosRestaurados[id] = {
                        paciente: (valores?.paciente || '').toString(),
                        prontuario: (valores?.prontuario || '').toString(),
                        acompanhante: (valores?.acompanhante || '').toString()
                    };
                });
                const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
                estadoOcupacao.rascunhos = rascunhosRestaurados;
                rascunhosOcupacaoRestaurados = true;
            } catch (erro) {
                console.warn('Falha ao restaurar rascunhos de ocupa칞칚o:', erro);
                try {
                    storage.removeItem(STORAGE_KEYS.rascunhosOcupacao);
                } catch (erroRemocao) {
                    console.warn('N칚o foi poss칤vel limpar rascunhos inv치lidos do armazenamento local:', erroRemocao);
                }
            }
        }
        function popularAvataresPadrao() {
            if (!elementos.avatarOptions) {
                return;
            }
            elementos.avatarOptions.innerHTML = '';
            AVATAR_OPTIONS.forEach(option => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'avatar-option';
                button.dataset.avatarId = option.id;
                button.dataset.avatarUrl = option.url ? option.url.toString() : '';
                button.setAttribute('aria-label', option.label);
                button.setAttribute('role', 'option');
                button.setAttribute('aria-selected', 'false');
                if (option.url) {
                    const img = document.createElement('img');
                    img.src = option.url;
                    img.alt = option.label;
                    img.loading = 'lazy';
                    button.appendChild(img);
                } else {
                    const span = document.createElement('span');
                    span.textContent = option.initials || '';
                    if (option.background) {
                        span.style.background = option.background;
                    }
                    if (option.textColor) {
                        span.style.color = option.textColor;
                    }
                    button.appendChild(span);
                }
                elementos.avatarOptions.appendChild(button);
            });
        }
        function obterAvatarAtualUrl() {
            const usuario = obterUsuarioAutenticado();
            return usuario && usuario.avatarUrl ? usuario.avatarUrl.toString().trim() : '';
        }
        function sincronizarSelecaoAvatar() {
            if (!elementos.avatarOptions) {
                return;
            }
            const atual = obterAvatarAtualUrl();
            const botoes = elementos.avatarOptions.querySelectorAll('.avatar-option');
            botoes.forEach(botao => {
                const valor = botao.dataset.avatarUrl || '';
                const selecionado = valor ? valor === atual : !atual;
                botao.classList.toggle('selected', selecionado);
                botao.setAttribute('aria-selected', selecionado ? 'true' : 'false');
            });
        }
        function avatarModalAberto() {
            return elementos.avatarModal && !elementos.avatarModal.classList.contains('hidden');
        }
        function abrirModalAvatar() {
            if (!elementos.avatarModal || !elementos.avatarModalBackdrop) {
                return;
            }
            if (!avatarModalAberto()) {
                travaRolagem.aplicar();
            }
            elementos.avatarModalBackdrop.classList.remove('hidden');
            elementos.avatarModal.classList.remove('hidden');
            elementos.avatarModalBackdrop.setAttribute('aria-hidden', 'false');
            if (elementos.headerUserProfile) {
                elementos.headerUserProfile.setAttribute('aria-expanded', 'true');
            }
            sincronizarSelecaoAvatar();
            requestAnimationFrame(() => {
                const selecionado = elementos.avatarOptions?.querySelector('.avatar-option.selected');
                const alvo = selecionado || elementos.avatarOptions?.querySelector('.avatar-option');
                alvo?.focus();
            });
        }
        function fecharModalAvatar({ focusTrigger = true } = {}) {
            if (!elementos.avatarModal || !elementos.avatarModalBackdrop) {
                return;
            }
            if (avatarModalAberto()) {
                travaRolagem.remover();
            }
            elementos.avatarModal.classList.add('hidden');
            elementos.avatarModalBackdrop.classList.add('hidden');
            elementos.avatarModalBackdrop.setAttribute('aria-hidden', 'true');
            if (elementos.headerUserProfile) {
                elementos.headerUserProfile.setAttribute('aria-expanded', 'false');
                if (focusTrigger) {
                    elementos.headerUserProfile.focus();
                }
            }
            if (elementos.avatarUrlInput) {
                elementos.avatarUrlInput.value = '';
                elementos.avatarUrlInput.classList.remove('invalid');
                elementos.avatarUrlInput.removeAttribute('aria-invalid');
            }
        }
        function aplicarAvatarUsuario(url) {
            if (!estado.autenticado || !estado.usuarioAutenticado) {
                fecharModalAvatar({ focusTrigger: false });
                return;
            }
            const normalizado = (url || '').toString().trim();
            if (normalizado) {
                estado.usuarioAutenticado.avatarUrl = normalizado;
            } else if (estado.usuarioAutenticado.avatarUrl) {
                delete estado.usuarioAutenticado.avatarUrl;
            }
            atualizarCabecalhoUsuario();
            persistirSessaoAtual();
            sincronizarSelecaoAvatar();
            fecharModalAvatar();
        }
        function aplicarAvatarPersonalizado() {
            if (!elementos.avatarUrlInput) {
                return;
            }
            const valor = elementos.avatarUrlInput.value.trim();
            if (!valor) {
                elementos.avatarUrlInput.classList.add('invalid');
                elementos.avatarUrlInput.setAttribute('aria-invalid', 'true');
                elementos.avatarUrlInput.focus();
                return;
            }
            try {
                const urlValida = new URL(valor);
                elementos.avatarUrlInput.classList.remove('invalid');
                elementos.avatarUrlInput.removeAttribute('aria-invalid');
                const urlFinal = urlValida.toString();
                elementos.avatarUrlInput.value = '';
                aplicarAvatarUsuario(urlFinal);
            } catch (erro) {
                elementos.avatarUrlInput.classList.add('invalid');
                elementos.avatarUrlInput.setAttribute('aria-invalid', 'true');
                elementos.avatarUrlInput.focus();
            }
        }
        // Elementos DOM
        const elementos = {
            loginContainer: document.getElementById('login-container'),
            appShell: document.getElementById('app-shell'),
            loginForm: document.getElementById('login-form'),
            loginUsuario: document.getElementById('login-usuario'),
            loginSenha: document.getElementById('login-senha'),
            loginSubmit: document.getElementById('login-submit'),
            loginFeedback: document.getElementById('login-feedback'),
            profileSelect: document.getElementById('profile-select'),
            unitSelect: document.getElementById('unit-select'),
            notificationBell: document.getElementById('notification-bell'),
            notificationPanel: document.getElementById('notification-panel'),
            notificationBadge: document.querySelector('.notification-badge'),
            armariosContainer: document.getElementById('armarios-container'),
            descarteLista: document.getElementById('descarte-lista'),
            descarteVencido: document.getElementById('descarte-vencido'),
            descarteAlerta: document.getElementById('descarte-alerta'),
            descarteNoPrazo: document.getElementById('descarte-prazo'),
            descartePendenteAlta: document.getElementById('descarte-pendente'),
            descarteDescartado: document.getElementById('descarte-descartado'),
            armarioModal: document.getElementById('armario-modal'),
            usuarioModal: document.getElementById('usuario-modal'),
            modalTitle: document.getElementById('modal-title'),
            armarioForm: document.getElementById('armario-form'),
            usuarioForm: document.getElementById('usuario-form'),
            usuarioModalTitle: document.getElementById('usuario-modal-title'),
            usuarioSenha: document.getElementById('usuario-senha'),
            usuarioStatus: document.getElementById('usuario-status'),
            usuarioUnidades: document.getElementById('usuario-unidades'),
            modalClose: document.getElementById('modal-close'),
            usuarioModalClose: document.getElementById('usuario-modal-close'),
            btnCancelar: document.getElementById('btn-cancelar'),
            usuarioBtnCancelar: document.getElementById('usuario-btn-cancelar'),
            nomeVisitanteLabel: document.querySelector("label[for='nome-visitante']"),
            horaPrevistaInput: document.getElementById('hora-prevista'),
            horaPrevistaGroup: document.getElementById('hora-prevista-group'),
            visitaEstendidaGroup: document.getElementById('visita-estendida-group'),
            visitaEstendidaInput: document.getElementById('visita-estendida'),
            filterBtns: document.querySelectorAll('.filter-btn'),
            dashboardSearch: document.getElementById('dashboard-search'),
            toggleDadosButton: document.getElementById('toggle-dados'),
            contingenciaButton: document.getElementById('btn-contingencia'),
            cardsCount: {
                livres: document.getElementById('livres-count'),
                emUso: document.getElementById('em-uso-count'),
                proximo: document.getElementById('proximo-count'),
                vencidos: document.getElementById('vencidos-count')
            },
            pages: document.querySelectorAll('.page'),
            menuLinks: document.querySelectorAll('.sidebar-menu a[data-page]'),
            headerUserProfile: document.getElementById('header-user-profile'),
            headerUserAvatar: document.getElementById('header-user-avatar'),
            headerUserName: document.getElementById('header-user-name'),
            headerUserRole: document.getElementById('header-user-role'),
            avatarModal: document.getElementById('avatar-modal'),
            avatarModalBackdrop: document.getElementById('avatar-modal-backdrop'),
            avatarModalClose: document.getElementById('avatar-modal-close'),
            avatarOptions: document.getElementById('avatar-options'),
            avatarUrlInput: document.getElementById('avatar-url'),
            avatarUrlApply: document.getElementById('avatar-url-apply'),
            globalLoadingOverlay: document.getElementById('global-loading-overlay'),
            globalLoadingText: document.getElementById('global-loading-text'),
            termoModal: document.getElementById('termo-modal'),
            termoForm: document.getElementById('termo-form'),
            termoNascimento: document.getElementById('termo-nascimento'),
            termoSetor: document.getElementById('termo-setor'),
            termoLeito: document.getElementById('termo-leito'),
            termoProntuario: document.getElementById('termo-prontuario'),
            termoSetorLabel: document.querySelector("label[for='termo-setor']"),
            termoLeitoLabel: document.querySelector("label[for='termo-leito']"),
            termoModalClose: document.getElementById('termo-modal-close'),
            termoBtnVoltar: document.getElementById('termo-btn-voltar'),
            termoBtnAvancar: document.getElementById('termo-btn-avancar'),
            termoBtnCancelar: document.getElementById('termo-btn-cancelar'),
            termoProgress: document.getElementById('termo-progress'),
            termoProgressLabel: document.getElementById('termo-progress-label'),
            termoArmario: document.getElementById('termo-armario'),
            termoLoading: document.getElementById('termo-loading'),
            termoLoadingText: document.getElementById('termo-loading-text'),
            termoVolumesList: document.getElementById('termo-volumes-list'),
            termoAddVolume: document.getElementById('termo-add-volume'),
            termoVolumesField: document.getElementById('termo-volumes-field'),
            termoAssinaturaCanvas: document.getElementById('termo-signature-canvas'),
            termoAssinaturaClear: document.getElementById('termo-signature-clear'),
            tabelaTermos: document.getElementById('tabela-termos'),
            tabelaTermosBody: document.querySelector('#tabela-termos tbody'),
            movimentacaoModal: document.getElementById('movimentacao-modal'),
            movimentacaoModalClose: document.getElementById('movimentacao-modal-close'),
            movimentacoesList: document.getElementById('movimentacoes-list'),
            movimentacaoForm: document.getElementById('movimentacao-form'),
            movimentacaoModalTitle: document.getElementById('movimentacao-modal-title'),
            movTipo: document.getElementById('mov-tipo'),
            movDescricao: document.getElementById('mov-descricao'),
            movResponsavelInfo: document.getElementById('mov-responsavel-info'),
            movData: document.getElementById('mov-data'),
            movHora: document.getElementById('mov-hora'),
            btnNovaUnidade: document.getElementById('btn-nova-unidade'),
            tabelaUnidades: document.getElementById('tabela-unidades'),
            tabelaUnidadesBody: document.querySelector('#tabela-unidades tbody'),
            tabelaUsuarios: document.getElementById('tabela-usuarios'),
            tabelaUsuariosBody: document.querySelector('#tabela-usuarios tbody'),
            tabelaLiberacao: document.getElementById('tabela-liberacao'),
            tabelaLiberacaoHead: document.querySelector('#tabela-liberacao thead tr'),
            tabelaLiberacaoBody: document.querySelector('#tabela-liberacao tbody'),
            liberacaoDataInicio: document.getElementById('liberacao-data-inicio'),
            liberacaoDataFim: document.getElementById('liberacao-data-fim'),
            liberacaoProntuario: document.getElementById('liberacao-prontuario'),
            liberacaoPaciente: document.getElementById('liberacao-paciente'),
            liberacaoRefresh: document.getElementById('liberacao-refresh'),
            liberacaoResumo: document.getElementById('liberacao-resumo'),
            ocupacaoRapidaForm: document.getElementById('ocupacao-rapida-form'),
            ocupacaoArmario: document.getElementById('ocupacao-armario'),
            ocupacaoPaciente: document.getElementById('ocupacao-paciente'),
            ocupacaoProntuario: document.getElementById('ocupacao-prontuario'),
            ocupacaoAcompanhante: document.getElementById('ocupacao-acompanhante'),
            ocupacaoFiltro: document.getElementById('ocupacao-filtro'),
            ocupacaoSalvarTodos: document.getElementById('ocupacao-btn-salvar-todos'),
            ocupacaoSalvar: document.getElementById('ocupacao-btn-salvar'),
            tabelaOcupacaoAcompanhantes: document.getElementById('tabela-ocupacao-acompanhantes'),
            tabelaOcupacaoAcompanhantesBody: document.querySelector('#tabela-ocupacao-acompanhantes tbody'),
            logoutButton: document.getElementById('logout-button')
        };
        popularAvataresPadrao();
        sincronizarSelecaoAvatar();
        const customSelectorInstances = new WeakMap();
        const customSelectorStore = new Set();
        const paginasRestritasUsuario = new Set(['cadastro-armarios', 'cadastro-unidades', 'usuarios', 'logs', 'ocupacao-acompanhantes']);
        let aplicacaoInicializada = false;
        let loginInicializado = false;
        let eventosInicializados = false;
        function aprimorarSeletoresCabecalho() {
            document.querySelectorAll('.selector-control .selector-input').forEach(select => criarSelectorPersonalizado(select));
        }
        function criarSelectorPersonalizado(select) {
            if (!select) return;
            const control = select.closest('.selector-control');
            if (!control) return;
            if (customSelectorInstances.has(select)) {
                atualizarSelectorPersonalizado(select);
                return;
            }
            const trigger = control.querySelector('.selector-trigger');
            const dropdown = control.querySelector('.selector-dropdown');
            if (!trigger || !dropdown) return;
            const labelEl = trigger.querySelector('.selector-trigger-label');
            const descriptionEl = trigger.querySelector('.selector-trigger-description');
            dropdown.innerHTML = '';
            const optionsList = document.createElement('ul');
            optionsList.className = 'selector-options';
            optionsList.setAttribute('role', 'presentation');
            dropdown.appendChild(optionsList);
            select.classList.add('selector-native-input');
            select.setAttribute('tabindex', '-1');
            select.setAttribute('aria-hidden', 'true');
            const instance = {
                select,
                control,
                trigger,
                dropdown,
                optionsList,
                labelEl,
                descriptionEl,
                optionButtons: new Map()
            };
            customSelectorInstances.set(select, instance);
            customSelectorStore.add(instance);
            control.addEventListener('focusout', event => {
                if (!control.contains(event.relatedTarget)) {
                    control.classList.remove('open');
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });
            trigger.addEventListener('click', () => toggleSelectorDropdown(instance));
            trigger.addEventListener('keydown', event => handleTriggerKeydown(event, instance));
            optionsList.addEventListener('click', event => handleOptionClick(event, instance));
            optionsList.addEventListener('keydown', event => handleOptionKeydown(event, instance));
            select.addEventListener('change', () => sincronizarTriggerComSelect(instance));
            popularOpcoesPersonalizadas(instance);
            sincronizarTriggerComSelect(instance);
        }
        function atualizarSelectorPersonalizado(select) {
            const instance = customSelectorInstances.get(select);
            if (!instance) {
                criarSelectorPersonalizado(select);
                return;
            }
            popularOpcoesPersonalizadas(instance);
            sincronizarTriggerComSelect(instance);
        }
        function popularOpcoesPersonalizadas(instance) {
            const { select, optionsList, optionButtons } = instance;
            optionButtons.clear();
            optionsList.innerHTML = '';
            Array.from(select.options).forEach(option => {
                const item = document.createElement('li');
                item.className = 'selector-option';
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'selector-option-button';
                button.dataset.value = option.value;
                button.setAttribute('role', 'option');
                button.tabIndex = -1;
                if (option.disabled) {
                    button.disabled = true;
                    button.classList.add('is-disabled');
                    button.setAttribute('aria-disabled', 'true');
                }
                const content = document.createElement('div');
                content.className = 'selector-option-content';
                const iconWrapper = document.createElement('span');
                const iconClass = option.dataset.icon;
                if (iconClass) {
                    iconWrapper.className = 'selector-option-icon';
                    iconWrapper.innerHTML = `<i class="${iconClass}"></i>`;
                } else {
                    iconWrapper.className = 'selector-option-bullet';
                    iconWrapper.textContent = (option.textContent || '').trim().charAt(0) || '?';
                }
                const textWrapper = document.createElement('div');
                textWrapper.className = 'selector-option-text';
                const label = document.createElement('span');
                label.className = 'selector-option-label';
                label.textContent = option.textContent;
                textWrapper.appendChild(label);
                if (option.dataset.description) {
                    const description = document.createElement('span');
                    description.className = 'selector-option-description';
                    description.textContent = option.dataset.description;
                    textWrapper.appendChild(description);
                }
                content.appendChild(iconWrapper);
                content.appendChild(textWrapper);
                button.appendChild(content);
                const check = document.createElement('span');
                check.className = 'selector-option-check';
                check.innerHTML = '<i class="fas fa-check"></i>';
                button.appendChild(check);
                item.appendChild(button);
                optionsList.appendChild(item);
                optionButtons.set(option.value, button);
            });
            sincronizarTriggerComSelect(instance);
        }
        function sincronizarTriggerComSelect(instance) {
            const { select, labelEl, descriptionEl, optionButtons } = instance;
            const selectedOption = select.options[select.selectedIndex];
            const labelTexto = selectedOption ? selectedOption.textContent : 'Selecionar';
            if (labelEl) labelEl.textContent = labelTexto;
            if (descriptionEl) {
                const descricao = selectedOption?.dataset?.description || '';
                descriptionEl.textContent = descricao;
                descriptionEl.hidden = !descricao;
            }
            optionButtons.forEach((button, value) => {
                const isSelected = selectedOption && value === selectedOption.value;
                button.classList.toggle('is-selected', Boolean(isSelected));
                button.setAttribute('aria-selected', isSelected ? 'true' : 'false');
            });
        }
        function toggleSelectorDropdown(instance, forceState) {
            const { control, trigger } = instance;
            const isOpen = control.classList.contains('open');
            const shouldOpen = typeof forceState === 'boolean' ? forceState : !isOpen;
            if (shouldOpen) {
                fecharTodosSeletores(instance);
                control.classList.add('open');
                trigger.setAttribute('aria-expanded', 'true');
                focarOpcaoSelecionada(instance);
            } else {
                control.classList.remove('open');
                trigger.setAttribute('aria-expanded', 'false');
            }
        }
        function fecharTodosSeletores(exceto) {
            customSelectorStore.forEach(instance => {
                if (instance !== exceto) {
                    instance.control.classList.remove('open');
                    instance.trigger.setAttribute('aria-expanded', 'false');
                }
            });
        }
        function handleOptionClick(event, instance) {
            const button = event.target.closest('.selector-option-button');
            if (!button || button.disabled) return;
            selecionarValorPersonalizado(instance, button.dataset.value);
        }
        function selecionarValorPersonalizado(instance, value) {
            const { select } = instance;
            const valorAtual = select.value;
            if (valorAtual !== value) {
                select.value = value;
                select.dispatchEvent(new Event('change', { bubbles: true }));
            } else {
                sincronizarTriggerComSelect(instance);
            }
            toggleSelectorDropdown(instance, false);
            instance.trigger.focus();
        }
        function handleOptionKeydown(event, instance) {
            const button = event.target.closest('.selector-option-button');
            if (!button) return;
            switch (event.key) {
                case 'ArrowDown':
                case 'ArrowRight':
                    event.preventDefault();
                    focarProximaOpcao(instance, button, 1);
                    break;
                case 'ArrowUp':
                case 'ArrowLeft':
                    event.preventDefault();
                    focarProximaOpcao(instance, button, -1);
                    break;
                case 'Home':
                    event.preventDefault();
                    focarExtremaOpcao(instance, 'first');
                    break;
                case 'End':
                    event.preventDefault();
                    focarExtremaOpcao(instance, 'last');
                    break;
                case 'Enter':
                case ' ':
                    event.preventDefault();
                    if (!button.disabled) {
                        selecionarValorPersonalizado(instance, button.dataset.value);
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    toggleSelectorDropdown(instance, false);
                    instance.trigger.focus();
                    break;
            }
        }
        function handleTriggerKeydown(event, instance) {
            if (['ArrowDown', 'ArrowUp', 'Enter', ' '].includes(event.key)) {
                event.preventDefault();
                toggleSelectorDropdown(instance, true);
                focarOpcaoSelecionada(instance, event.key === 'ArrowUp');
            } else if (event.key === 'Escape') {
                toggleSelectorDropdown(instance, false);
            }
        }
        function focarProximaOpcao(instance, currentButton, direction) {
            const buttons = Array.from(instance.optionsList.querySelectorAll('.selector-option-button:not(.is-disabled)'));
            if (!buttons.length) return;
            const indexAtual = buttons.indexOf(currentButton);
            const novoIndice = (indexAtual + direction + buttons.length) % buttons.length;
            buttons[novoIndice]?.focus();
        }
        function focarExtremaOpcao(instance, posicao) {
            const buttons = Array.from(instance.optionsList.querySelectorAll('.selector-option-button:not(.is-disabled)'));
            if (!buttons.length) return;
            const target = posicao === 'last' ? buttons[buttons.length - 1] : buttons[0];
            target.focus();
        }
        function focarOpcaoSelecionada(instance, preferirUltima = false) {
            requestAnimationFrame(() => {
                const selectedOption = instance.select.options[instance.select.selectedIndex];
                const selectedButton = selectedOption ? instance.optionButtons.get(selectedOption.value) : null;
                const buttons = Array.from(instance.optionsList.querySelectorAll('.selector-option-button:not(.is-disabled)'));
                if (selectedButton && !selectedButton.disabled) {
                    selectedButton.focus();
                } else if (buttons.length) {
                    const alvo = preferirUltima ? buttons[buttons.length - 1] : buttons[0];
                    alvo.focus();
                }
            });
        }
        document.addEventListener('click', event => {
            const control = event.target.closest('.selector-control');
            customSelectorStore.forEach(instance => {
                if (instance.control !== control) {
                    instance.control.classList.remove('open');
                    instance.trigger.setAttribute('aria-expanded', 'false');
                }
            });
        });
        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
                customSelectorStore.forEach(instance => {
                    if (instance.control.classList.contains('open')) {
                        const shouldReturnFocus = instance.control.contains(document.activeElement);
                        instance.control.classList.remove('open');
                        instance.trigger.setAttribute('aria-expanded', 'false');
                        if (shouldReturnFocus) {
                            instance.trigger.focus();
                        }
                    }
                });
            }
        });
        const normalizarTexto = (valor) => (valor ?? '').toString().trim().toLowerCase();
        const normalizarIdentificador = (valor) => (valor ?? '').toString().trim();
        const normalizarTextoBusca = (valor) => {
            const texto = (valor ?? '').toString().trim().toLowerCase();
            if (texto && typeof texto.normalize === 'function') {
                return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }
            return texto;
        };
        function montarIdentificadoresArmario(armario) {
            if (!armario) {
                return null;
            }
            const idPlanilha = armario.idPlanilha !== undefined && armario.idPlanilha !== null
                ? armario.idPlanilha.toString().trim()
                : '';
            const numeroArmario = normalizarIdentificador(armario.numero);
            const tipo = armario.tipo || '';
            return { idPlanilha, numeroArmario, tipo };
        }
        function montarPayloadTermo(armario, extras = {}) {
            const identificadores = montarIdentificadoresArmario(armario) || { idPlanilha: '', numeroArmario: '', tipo: '' };
            return {
                armarioId: identificadores.idPlanilha,
                numeroArmario: identificadores.numeroArmario,
                tipo: identificadores.tipo,
                ...extras
            };
        }
        function montarPayloadAcaoArmario(armario, extras = {}) {
            const identificadores = montarIdentificadoresArmario(armario) || { idPlanilha: '', numeroArmario: '', tipo: '' };
            return {
                id: identificadores.idPlanilha,
                armarioId: identificadores.idPlanilha,
                numeroArmario: identificadores.numeroArmario,
                tipo: identificadores.tipo,
                usuarioResponsavel: obterDescricaoResponsavelAtual(),
                ...extras
            };
        }
        function extrairIdDataset(elemento) {
            if (!elemento || !elemento.dataset) {
                return '';
            }
            const bruto = elemento.dataset.id;
            return bruto === undefined || bruto === null ? '' : normalizarIdentificador(bruto);
        }
        function obterUsuarioAutenticado() {
            return estado.usuarioAutenticado || null;
        }
        function obterDataHoraLocalPadrao() {
            const agora = new Date();
            const offset = agora.getTimezoneOffset();
            const local = new Date(agora.getTime() - offset * 60000);
            const isoLocal = local.toISOString();
            return {
                data: isoLocal.slice(0, 10),
                hora: isoLocal.slice(11, 16)
            };
        }
        function obterDescricaoResponsavelAtual() {
            const usuario = obterUsuarioAutenticado();
            if (!usuario) {
                return '';
            }
            const nome = (usuario.nome || '').toString().trim();
            const matricula = (usuario.matricula || '').toString().trim();
            const login = (usuario.usuario || '').toString().trim();
            const partes = [];
            if (nome) {
                partes.push(nome);
            }
            if (matricula) {
                partes.push(matricula);
            } else if (login && !partes.includes(login)) {
                partes.push(login);
            }
            return partes.join(' - ') || nome || matricula || login;
        }
        function atualizarResponsavelMovimentacaoInfo() {
            if (!elementos.movResponsavelInfo) {
                return;
            }
            const descricao = obterDescricaoResponsavelAtual();
            if (descricao) {
                elementos.movResponsavelInfo.textContent = descricao;
                elementos.movResponsavelInfo.classList.remove('is-warning');
            } else {
                elementos.movResponsavelInfo.textContent = 'Fa칞a login para registrar movimenta칞칫es.';
                elementos.movResponsavelInfo.classList.add('is-warning');
            }
        }
        function perfilAtualEhAdmin() {
            const usuario = obterUsuarioAutenticado();
            return usuario ? normalizarTexto(usuario.perfil) === 'admin' : false;
        }
        function perfilAtualEhAcompanhante() {
            const perfil = normalizarTexto(estado.perfilAtual);
            return perfil === 'acompanhante';
        }
        function normalizarListaDeUnidades(unidades) {
            if (!unidades) return [];
            if (Array.isArray(unidades)) {
                return unidades
                    .map(valor => (valor ?? '').toString().trim())
                    .filter(valor => valor);
            }
            if (typeof unidades === 'string') {
                const texto = unidades.toString().trim();
                if (!texto) {
                    return [];
                }
                if ((texto.startsWith('[') && texto.endsWith(']')) || (texto.startsWith('{') && texto.endsWith('}'))) {
                    try {
                        const convertido = JSON.parse(texto);
                        return normalizarListaDeUnidades(convertido);
                    } catch (erro) {
                        console.warn('Falha ao interpretar unidades como JSON:', erro);
                    }
                }
                const separador = texto.includes(';') || texto.includes(',') ? /[;,]/ : null;
                if (separador) {
                    return texto.split(separador).map(valor => valor.trim()).filter(valor => valor);
                }
                return [texto];
            }
            if (typeof unidades === 'object') {
                const valores = [];
                Object.keys(unidades).forEach(chave => {
                    const valor = unidades[chave];
                    if (Array.isArray(valor)) {
                        valores.push(...valor);
                    } else if (valor !== undefined && valor !== null) {
                        valores.push(valor);
                    }
                });
                return normalizarListaDeUnidades(valores);
            }
            return [(unidades ?? '').toString().trim()].filter(valor => valor);
        }
        function obterIdsPermitidos() {
            const usuario = obterUsuarioAutenticado();
            if (!usuario) {
                return [];
            }
            const unidadesNormalizadas = normalizarListaDeUnidades(usuario.unidades);
            if (perfilAtualEhAdmin() || unidadesNormalizadas.some(valor => normalizarTexto(valor) === 'all')) {
                return null;
            }
            return unidadesNormalizadas;
        }
        function obterUnidadesPermitidas() {
            const idsPermitidos = obterIdsPermitidos();
            if (idsPermitidos === null) {
                return estado.unidades.slice();
            }
            if (!idsPermitidos.length) {
                return [];
            }
            return estado.unidades.filter(unidade => idsPermitidos.includes(String(unidade.id)));
        }
        function usuarioPodeVerUnidade(unidadeReferencia) {
            const idsPermitidos = obterIdsPermitidos();
            if (idsPermitidos === null) {
                return true;
            }
            if (!idsPermitidos.length) {
                return false;
            }
            const referencia = (unidadeReferencia ?? '').toString().trim();
            if (!referencia) {
                return false;
            }
            if (idsPermitidos.includes(referencia)) {
                return true;
            }
            const referenciaNormalizada = normalizarTexto(referencia);
            const unidadeEncontrada = estado.unidades.find(unidade => {
                const nomeNormalizado = normalizarTexto(unidade.nome);
                return nomeNormalizado === referenciaNormalizada || String(unidade.id) === referencia;
            });
            if (!unidadeEncontrada) {
                return false;
            }
            return idsPermitidos.includes(String(unidadeEncontrada.id));
        }
        function filtrarListaPorPermissao(lista, extrator) {
            if (!Array.isArray(lista)) return [];
            return lista.filter(item => usuarioPodeVerUnidade(extrator ? extrator(item) : item));
        }
        function usuarioTemAcessoPagina(pagina) {
            if (!estado.autenticado) return false;
            if (perfilAtualEhAdmin()) return true;
            return !paginasRestritasUsuario.has(pagina);
        }
        function gerarIniciais(nome) {
            if (!nome) return '--';
            const partes = nome.trim().split(/\s+/).filter(Boolean);
            if (partes.length >= 2) {
                return (partes[0][0] + partes[partes.length - 1][0]).toUpperCase();
            }
            const unica = partes[0];
            return unica.slice(0, Math.min(2, unica.length)).toUpperCase();
        }
        function normalizarListaSetores(setores) {
            const lista = Array.isArray(setores) ? setores : [];
            const vistos = new Set();
            const resultado = [];
            lista.forEach(item => {
                const texto = (item ?? '').toString().trim();
                if (!texto) {
                    return;
                }
                const chave = normalizarTexto(texto);
                if (vistos.has(chave)) {
                    return;
                }
                vistos.add(chave);
                resultado.push(texto);
            });
            return resultado.sort((a, b) => a.localeCompare(b, 'pt-BR', { sensitivity: 'base' }));
        }
        function atualizarOpcoesSetorTermo(lista = estado.setores) {
            const select = elementos.termoSetor;
            if (!select) {
                return;
            }
            const valorAtual = select.value;
            const setoresValidos = normalizarListaSetores(lista);
            select.innerHTML = '';
            const opcaoPadrao = document.createElement('option');
            opcaoPadrao.value = '';
            opcaoPadrao.textContent = 'Selecione o setor';
            select.appendChild(opcaoPadrao);
            setoresValidos.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = setor;
                select.appendChild(option);
            });
            if (valorAtual) {
                garantirOpcaoSetor(valorAtual);
                select.value = valorAtual;
            } else {
                select.value = '';
            }
        }
        function garantirOpcaoSetor(setor) {
            const select = elementos.termoSetor;
            if (!select) {
                return;
            }
            const texto = (setor ?? '').toString().trim();
            if (!texto) {
                return;
            }
            const chaveTexto = normalizarTexto(texto);
            const existe = Array.from(select.options).some(opt => normalizarTexto(opt.value) === chaveTexto);
            if (!existe) {
                const option = document.createElement('option');
                option.value = texto;
                option.textContent = texto;
                select.appendChild(option);
            }
        }
        function definirSetorTermo(valor) {
            const select = elementos.termoSetor;
            if (!select) {
                return;
            }
            const texto = (valor ?? '').toString().trim();
            if (!texto) {
                select.value = '';
                return;
            }
            garantirOpcaoSetor(texto);
            select.value = texto;
        }
        async function preencherPacientePorProntuario(opcoes = {}) {
            const campoProntuario = elementos.termoProntuario || document.getElementById('termo-prontuario');
            if (!campoProntuario) {
                return;
            }

            const prontuario = (campoProntuario.value || '').toString().trim();
            if (!prontuario) {
                termoUltimoProntuarioBuscado = '';
                return;
            }

            if (!opcoes.forcar && termoUltimoProntuarioBuscado === prontuario) {
                return;
            }

            const carregamentoId = ++termoBuscaProntuarioId;
            setEstadoCarregamentoTermo(true, 'Buscando dados do paciente na Base Vitae...');

            try {
                const resposta = await callGoogleScript('buscarPacienteBaseVitae', { prontuario });
                if (carregamentoId !== termoBuscaProntuarioId) {
                    return;
                }
                termoUltimoProntuarioBuscado = prontuario;
                if (resposta.success && resposta.data) {
                    const { nome, setor, leito } = resposta.data;
                    if (nome) {
                        document.getElementById('termo-paciente').value = nome;
                    }
                    if (setor) {
                        definirSetorTermo(setor);
                    }
                    if (leito) {
                        document.getElementById('termo-leito').value = aplicarMascaraLeito(leito);
                    }
                    salvarRascunhoTermo();
                } else if (resposta.error && !resposta._erroNotificado) {
                    mostrarErro(resposta.error);
                }
            } catch (erroBusca) {
                console.error('Erro ao buscar paciente pelo prontu치rio:', erroBusca);
                if (erroBusca && erroBusca.mensagemUsuario) {
                    mostrarErro(erroBusca.mensagemUsuario);
                }
            } finally {
                if (carregamentoId === termoBuscaProntuarioId) {
                    setEstadoCarregamentoTermo(false);
                }
            }
        }
        function ajustarObrigatoriedadeCamposPaciente(tipo) {
            const ehAcompanhante = normalizarTexto(tipo) === 'acompanhante';
            const configuracoes = [
                { campo: elementos.termoSetor, label: elementos.termoSetorLabel },
                { campo: elementos.termoLeito, label: elementos.termoLeitoLabel }
            ];
            configuracoes.forEach(item => {
                if (!item.campo) {
                    return;
                }
                if (ehAcompanhante) {
                    item.campo.removeAttribute('required');
                    item.campo.closest('.wizard-field')?.classList.remove('invalid');
                    if (item.label) {
                        item.label.classList.remove('wizard-required');
                    }
                } else {
                    item.campo.setAttribute('required', 'required');
                    if (item.label && !item.label.classList.contains('wizard-required')) {
                        item.label.classList.add('wizard-required');
                    }
                }
            });
        }
        function obterDescricaoUnidades(unidadesLista) {
            const lista = normalizarListaDeUnidades(unidadesLista);
            if (!lista.length) {
                return 'Nenhuma';
            }
            if (lista.some(valor => normalizarTexto(valor) === 'all')) {
                return 'Todas';
            }
            const nomes = lista.map(id => {
                const unidade = estado.unidades.find(item => String(item.id) === String(id));
                return unidade ? unidade.nome : `ID ${id}`;
            });
            return nomes.join(', ');
        }
        function atualizarCabecalhoUsuario() {
            if (!elementos.headerUserName || !elementos.headerUserAvatar || !elementos.headerUserRole) {
                return;
            }
            const usuario = obterUsuarioAutenticado();
            if (!usuario) {
                elementos.headerUserName.textContent = 'Usu치rio';
                elementos.headerUserRole.textContent = '';
                elementos.headerUserAvatar.textContent = '--';
                elementos.headerUserAvatar.style.backgroundImage = '';
                elementos.headerUserAvatar.classList.remove('has-image');
                elementos.headerUserProfile?.setAttribute('aria-label', 'Perfil do usu치rio');
                atualizarResponsavelMovimentacaoInfo();
                return;
            }
            const nomeLimpo = (usuario.nome || 'Usu치rio').toString().trim();
            elementos.headerUserName.textContent = nomeLimpo;
            elementos.headerUserRole.textContent = perfilAtualEhAdmin() ? 'Administrador' : 'Usu치rio';
            elementos.headerUserProfile?.setAttribute('aria-label', `Perfil do usu치rio ${nomeLimpo} (${elementos.headerUserRole.textContent})`);
            const avatarUrl = usuario.avatarUrl ? usuario.avatarUrl.toString().trim() : '';
            if (avatarUrl) {
                elementos.headerUserAvatar.style.backgroundImage = `url("${avatarUrl.replace(/"/g, '\\"')}")`;
                elementos.headerUserAvatar.classList.add('has-image');
                elementos.headerUserAvatar.textContent = '';
            } else {
                elementos.headerUserAvatar.style.backgroundImage = '';
                elementos.headerUserAvatar.classList.remove('has-image');
                elementos.headerUserAvatar.textContent = gerarIniciais(nomeLimpo);
            }
            sincronizarSelecaoAvatar();
            atualizarResponsavelMovimentacaoInfo();
        }
        function aplicarPermissoesMenu() {
            if (!elementos.menuLinks) return;
            elementos.menuLinks.forEach(link => {
                const pagina = link.dataset.page;
                const permitido = usuarioTemAcessoPagina(pagina);
                link.parentElement.style.display = permitido ? '' : 'none';
            });
            const botoesRestritos = [
                document.getElementById('btn-novo-armario'),
                document.getElementById('btn-nova-unidade'),
                document.getElementById('btn-novo-usuario')
            ];
            botoesRestritos.forEach(botao => {
                if (!botao) return;
                botao.style.display = perfilAtualEhAdmin() ? '' : 'none';
            });
            if (!usuarioTemAcessoPagina(estado.paginaAtual)) {
                estado.paginaAtual = 'dashboard';
                navegarParaPagina('dashboard');
            }
        }
        const termoSteps = Array.from(document.querySelectorAll('#termo-form .wizard-step'));
        let termoPassoAtual = 0;
        let termoArmarioAtual = null;
        let termoPreCadastro = null;
        let termoCadastroArmario = null;
        let termoBuscaProntuarioId = 0;
        let termoUltimoProntuarioBuscado = '';
        let movimentacaoArmarioAtual = null;
        let movimentacaoEmProgresso = false;
        let termoAssinaturaDesenhada = false;
        let termoDesenhandoAssinatura = false;
        // Inicializa칞칚o
        document.addEventListener('DOMContentLoaded', function() {
            atualizarOpcoesSetorTermo();
            atualizarResponsavelMovimentacaoInfo();
            inicializarLogin();
        });
        function aguardar(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function executarCarregamentoSeguro(descricao, acao) {
            try {
                const resultado = await acao();
                const sucesso = resultado !== false;
                if (!sucesso) {
                    console.warn(`Carregamento conclu칤do sem sucesso (${descricao}).`);
                }
                return { sucesso, descricao };
            } catch (erro) {
                console.error(`Erro ao executar carregamento (${descricao}):`, erro);
                return { sucesso: false, descricao, erro };
            }
        }
        function criarErroChamadaGoogle(mensagemUsuario, detalhes) {
            const erro = new Error(detalhes || mensagemUsuario);
            erro.mensagemUsuario = mensagemUsuario;
            return erro;
        }
        // Fun칞칚o para chamar o Google Apps Script
        async function callGoogleScript(action, data = {}, opcoes = {}) {
            const tentativasConfiguradas = Number.isFinite(opcoes.tentativas) && opcoes.tentativas > 0
                ? Math.floor(opcoes.tentativas)
                : 3;
            const intervaloBaseConfigurado = Number.isFinite(opcoes.intervaloInicial) && opcoes.intervaloInicial > 0
                ? opcoes.intervaloInicial
                : 400;
            const payload = { ...(data || {}) };
            if (!Object.prototype.hasOwnProperty.call(payload, 'usuarioResponsavel')) {
                const responsavelAtual = obterDescricaoResponsavelAtual();
                if (responsavelAtual) {
                    payload.usuarioResponsavel = responsavelAtual;
                }
            }
            const entradas = [];
            Object.keys(payload).forEach(key => {
                const valor = payload[key];
                if (valor === undefined || valor === null) {
                    entradas.push([key, '']);
                } else if (valor instanceof Date) {
                    entradas.push([key, valor.toISOString()]);
                } else if (typeof valor === 'object') {
                    try {
                        entradas.push([key, JSON.stringify(valor)]);
                    } catch (erroJSON) {
                        console.error(`Erro ao serializar campo ${key} da a칞칚o ${action}:`, erroJSON);
                        entradas.push([key, '']);
                    }
                } else {
                    entradas.push([key, valor]);
                }
            });

            let atraso = intervaloBaseConfigurado;
            const maxTentativas = Math.max(1, tentativasConfiguradas);

            for (let tentativa = 1; tentativa <= maxTentativas; tentativa++) {
                try {
                    const formData = new FormData();
                    formData.append('action', action);
                    entradas.forEach(([chave, valor]) => formData.append(chave, valor));

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const mensagem = `Erro ${response.status} ao comunicar com o servidor (a칞칚o: ${action})`;
                        console.error(mensagem);
                        throw criarErroChamadaGoogle(mensagem, mensagem);
                    }

                    const textoResposta = await response.text();
                    if (!textoResposta) {
                        const mensagem = `Resposta vazia do servidor (a칞칚o: ${action})`;
                        console.error(mensagem);
                        throw criarErroChamadaGoogle(mensagem, mensagem);
                    }

                    try {
                        return JSON.parse(textoResposta);
                    } catch (parseError) {
                        console.error(`Falha ao interpretar a resposta da a칞칚o ${action}:`, parseError, textoResposta);
                        const mensagem = `Resposta inv치lida do servidor (a칞칚o: ${action})`;
                        throw criarErroChamadaGoogle(mensagem, parseError && parseError.message ? parseError.message : mensagem);
                    }
                } catch (erro) {
                    const ultimaTentativa = tentativa === maxTentativas;
                    console.error(`Erro ao chamar Google Script (a칞칚o: ${action}, tentativa ${tentativa}/${maxTentativas}):`, erro);
                    if (ultimaTentativa) {
                        const mensagemUsuario = erro && erro.mensagemUsuario ? erro.mensagemUsuario : 'Erro de conex칚o com o servidor';
                        mostrarErro(mensagemUsuario);
                        const mensagemDetalhada = erro && erro.message ? erro.message : mensagemUsuario;
                        return { success: false, error: mensagemDetalhada, _erroNotificado: true };
                    }
                    await aguardar(atraso);
                    atraso = Math.min(atraso * 1.8, 2000);
                }
            }

            mostrarErro('Erro de conex칚o com o servidor');
            return { success: false, error: 'Erro de conex칚o com o servidor', _erroNotificado: true };
        }
        async function inicializarAplicacao() {
            if (aplicacaoInicializada) {
                await carregarDadosIniciais();
                atualizarCabecalhoUsuario();
                aplicarPermissoesMenu();
                carregarDadosTabelas();
                persistirSessaoAtual();
                return;
            }
            aplicacaoInicializada = true;
            aprimorarSeletoresCabecalho();
            inicializarCanvasAssinatura();
            inicializarEventos();
            await carregarDadosIniciais();
            atualizarCabecalhoUsuario();
            aplicarPermissoesMenu();
            carregarDadosTabelas();
            persistirSessaoAtual();
        }
        function atualizarFeedbackLogin(tipo, mensagem = '') {
            if (!elementos.loginFeedback) {
                return;
            }
            const classes = ['is-loading', 'is-error', 'is-success'];
            elementos.loginFeedback.classList.remove(...classes);
            elementos.loginFeedback.textContent = mensagem || '';
            if (tipo && classes.includes(`is-${tipo}`)) {
                elementos.loginFeedback.classList.add(`is-${tipo}`);
            }
        }
        function inicializarLogin() {
            if (typeof loginInicializado !== 'undefined' && loginInicializado) {
                return;
            }
            loginInicializado = true;
            const sessaoRestaurada = restaurarSessaoUsuario();
            if (sessaoRestaurada && !estado.autenticado) {
                const usuarioRestaurado = {
                    ...sessaoRestaurada
                };
                usuarioRestaurado.perfil = (usuarioRestaurado.perfil || 'usuario').toString().trim().toLowerCase();
                usuarioRestaurado.unidades = normalizarListaDeUnidades(usuarioRestaurado.unidades);
                estado.usuarioAutenticado = usuarioRestaurado;
                estado.autenticado = true;
                persistirSessaoAtual();
                if (elementos.loginContainer) {
                    elementos.loginContainer.classList.add('hidden');
                }
                if (elementos.appShell) {
                    elementos.appShell.classList.remove('hidden');
                }
                atualizarCabecalhoUsuario();
                aplicarPermissoesMenu();
                inicializarAplicacao().catch(erro => {
                    console.error('Erro ao inicializar aplica칞칚o ap칩s restaurar sess칚o:', erro);
                });
            }
            if (!elementos.loginForm) {
                return;
            }
            elementos.loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const usuarioLogin = elementos.loginUsuario?.value.trim();
                const senha = elementos.loginSenha?.value.trim();
                atualizarFeedbackLogin();
                if (!usuarioLogin || !senha) {
                    atualizarFeedbackLogin('error', 'Informe usu치rio e senha.');
                    return;
                }
                const finalizarLoading = iniciarLoadingBotao(elementos.loginSubmit);
                atualizarFeedbackLogin('loading', 'Validando credenciais...');
                try {
                    const resultado = await callGoogleScript('autenticarUsuario', { usuario: usuarioLogin, matricula: usuarioLogin, senha });
                    if (!resultado.success) {
                        atualizarFeedbackLogin('error', resultado.error || 'Credenciais inv치lidas.');
                        return;
                    }
                    const usuarioAutenticado = resultado.usuario || {};
                    usuarioAutenticado.perfil = (usuarioAutenticado.perfil || 'usuario').toString().trim().toLowerCase();
                    usuarioAutenticado.unidades = normalizarListaDeUnidades(usuarioAutenticado.unidades);
                    estado.usuarioAutenticado = usuarioAutenticado;
                    estado.autenticado = true;
                    persistirSessaoAtual();
                    elementos.loginSenha.value = '';
                    atualizarFeedbackLogin('success', 'Login realizado com sucesso!');
                    if (elementos.loginContainer) {
                        elementos.loginContainer.classList.add('hidden');
                    }
                    if (elementos.appShell) {
                        elementos.appShell.classList.remove('hidden');
                    }
                    atualizarCabecalhoUsuario();
                    aplicarPermissoesMenu();
                    await inicializarAplicacao();
                } catch (error) {
                    console.error('Erro ao autenticar usu치rio:', error);
                    atualizarFeedbackLogin('error', 'N칚o foi poss칤vel realizar o login. Tente novamente.');
                } finally {
                    finalizarLoading();
                }
            });
        }
        function realizarLogout() {
            estado = criarEstadoInicial();
            aplicacaoInicializada = false;
            limparSessaoUsuario();
            atualizarFeedbackLogin();
            atualizarCabecalhoUsuario();
            atualizarOpcoesSetorTermo();
            if (elementos.loginUsuario) {
                elementos.loginUsuario.value = '';
            }
            if (elementos.loginSenha) {
                elementos.loginSenha.value = '';
            }
            if (elementos.loginContainer) {
                elementos.loginContainer.classList.remove('hidden');
            }
            if (elementos.appShell) {
                elementos.appShell.classList.add('hidden');
            }
            if (elementos.notificationPanel) {
                elementos.notificationPanel.style.display = 'none';
            }
            if (elementos.notificationBadge) {
                elementos.notificationBadge.textContent = '0';
            }
            if (elementos.profileSelect) {
                elementos.profileSelect.value = 'geral';
                atualizarSelectorPersonalizado(elementos.profileSelect);
            }
            if (elementos.unitSelect) {
                elementos.unitSelect.value = 'todas';
                atualizarSelectorPersonalizado(elementos.unitSelect);
            }
            if (elementos.filterBtns) {
                elementos.filterBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === 'todos');
                });
            }
            if (elementos.menuLinks) {
                elementos.menuLinks.forEach(link => link.classList.remove('active'));
            }
            const dashboardLink = document.querySelector('.sidebar-menu a[data-page="dashboard"]');
            if (dashboardLink) {
                dashboardLink.classList.add('active');
            }
            if (elementos.pages) {
                elementos.pages.forEach(page => page.classList.remove('active'));
            }
            const dashboardPage = document.getElementById('dashboard');
            if (dashboardPage) {
                dashboardPage.classList.add('active');
            }
            const headerTitle = document.querySelector('.header-title h1');
            if (headerTitle) {
                headerTitle.textContent = 'Dashboard';
            }
            if (elementos.liberacaoResumo) {
                elementos.liberacaoResumo.textContent = 'Selecione um per칤odo para visualizar os registros de libera칞칚o.';
            }
            const padraoLocal = obterDataHoraLocalPadrao();
            if (elementos.liberacaoDataInicio) {
                elementos.liberacaoDataInicio.value = padraoLocal.data;
            }
            if (elementos.liberacaoDataFim) {
                elementos.liberacaoDataFim.value = padraoLocal.data;
            }
            if (elementos.liberacaoProntuario) {
                elementos.liberacaoProntuario.value = '';
            }
            if (elementos.liberacaoPaciente) {
                elementos.liberacaoPaciente.value = '';
            }
            mostrarEstadoTabelaLiberacao('Selecione um per칤odo e aplique os filtros para carregar os registros de libera칞칚o.');
            termoPassoAtual = 0;
            termoArmarioAtual = null;
            movimentacaoArmarioAtual = null;
            termoAssinaturaDesenhada = false;
            termoDesenhandoAssinatura = false;
            limparRascunhoArmario();
            limparRascunhoTermo();
            fecharModalArmario();
            fecharModalUsuario();
            fecharTermoModal();
            fecharMovimentacaoModal();
            fecharModalAvatar({ focusTrigger: false });
        }
        async function carregarDadosIniciais() {
            if (!estado.autenticado) {
                return;
            }
            try {
                const resultado = await callGoogleScript('verificarInicializacao');
                if (!resultado.success || !resultado.inicializado) {
                    await callGoogleScript('inicializarPlanilha');
                }

                const carregamentoUnidades = await executarCarregamentoSeguro('carregar unidades', carregarUnidades);
                const carregamentoSetores = await executarCarregamentoSeguro('carregar setores', carregarSetores);
                const carregamentosParalelos = [
                    executarCarregamentoSeguro('carregar arm치rios', () => carregarArmarios({ forcarAtualizacao: true })),
                    executarCarregamentoSeguro('carregar usu치rios', carregarUsuarios),
                    executarCarregamentoSeguro('carregar estat칤sticas', carregarEstatisticas),
                    executarCarregamentoSeguro('carregar notifica칞칫es', carregarNotificacoes)
                ];

                if (DESCARTE_HABILITADO) {
                    carregamentosParalelos.push(executarCarregamentoSeguro('carregar descarte', carregarDescarte));
                }

                const demaisCarregamentos = await Promise.all(carregamentosParalelos);

                const resultados = [carregamentoUnidades, carregamentoSetores, ...demaisCarregamentos];
                const houveSucesso = resultados.some(item => item.sucesso);

                if (!houveSucesso) {
                    mostrarErro('Erro ao carregar dados do sistema');
                    return;
                }

                const falhasParciais = resultados.filter(item => !item.sucesso);
                if (falhasParciais.length) {
                    console.warn('Falha ao carregar parte dos dados:', falhasParciais.map(item => item.descricao));
                }

                atualizarInterface();
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                mostrarErro('Erro ao carregar dados do sistema');
            }
        }
        async function carregarArmarios({ forcarAtualizacao = false } = {}) {
            if (!estado.autenticado) {
                return false;
            }
            if (!forcarAtualizacao && estado.armariosCarregados) {
                return true;
            }

            const resultado = await callGoogleScript('getArmarios', {
                tipo: 'todos'
            });

            if (resultado.success) {
                const armariosProcessados = (resultado.data || []).map(armario => ({
                    ...armario,
                    id: normalizarIdentificador(armario.id),
                    idPlanilha: armario.idPlanilha !== undefined && armario.idPlanilha !== null
                        ? armario.idPlanilha.toString().trim()
                        : '',
                    numero: normalizarIdentificador(armario.numero),
                    unidade: armario.unidade ? armario.unidade.trim() : '',
                    prontuario: armario.prontuario ? armario.prontuario.toString().trim() : '',
                    pacienteDeAlta: Boolean(armario.pacienteDeAlta),
                    destinoAtual: armario.destinoAtual ? armario.destinoAtual.toString().trim() : '',
                    dataAltaReferencia: armario.dataAltaReferencia || '',
                    dataAltaIso: armario.dataAltaIso || '',
                    visitaEstendida: Boolean(armario.visitaEstendida),
                    ehContingencia: Boolean(armario.ehContingencia) || normalizarTexto(armario.numero || '').startsWith('contingencia')
                }));
                estado.armarios = filtrarListaPorPermissao(armariosProcessados, item => item.unidade);
                estado.armariosCarregados = true;
                atualizarResumoDashboardLocal();
                return true;
            }

            estado.armariosCarregados = false;
            return false;
        }
        async function carregarDescarte() {
            if (!DESCARTE_HABILITADO) {
                estado.descarte = criarEstadoDescarteInicial();
                return true;
            }
            if (!estado.autenticado) {
                return false;
            }

            const resultado = await callGoogleScript('getDescarte');
            const resumoPadrao = criarEstadoDescarteInicial().resumo;

            if (resultado.success) {
                const itensProcessados = (resultado.data?.itens || []).map(item => ({
                    ...item,
                    prontuario: item.prontuario ? item.prontuario.toString().trim() : '',
                    paciente: item.paciente ? item.paciente.toString().trim() : '',
                    item: item.item ? item.item.toString().trim() : '',
                    armario: item.armario ? item.armario.toString().trim() : '',
                    dataAlta: item.dataAlta || '',
                    dataLimite: item.dataLimite || '',
                    descartadoEm: item.descartadoEm || '',
                    diasRestantes: Number.isFinite(item.diasRestantes) ? item.diasRestantes : null,
                    status: item.status || 'pendente-alta'
                }));

                estado.descarte = {
                    itens: itensProcessados,
                    resumo: { ...resumoPadrao, ...(resultado.data?.resumo || {}) }
                };
                renderizarDescarte();
                return true;
            }

            estado.descarte = criarEstadoDescarteInicial();
            renderizarDescarte();
            return false;
        }
        async function carregarUnidades() {
            if (!estado.autenticado) {
                return false;
            }
            const resultado = await callGoogleScript('getUnidades');
            if (resultado.success) {
                estado.unidades = resultado.data.map(unidade => ({
                    ...unidade,
                    nome: unidade.nome ? unidade.nome.trim() : ''
                }));
                atualizarSeletoresUnidade();
                if (estado.unidadeAtual !== 'todas' && !usuarioPodeVerUnidade(estado.unidadeAtual)) {
                    estado.unidadeAtual = 'todas';
                }
                return true;
            }
            return false;
        }
        async function carregarSetores() {
            if (!estado.autenticado) {
                estado.setores = [];
                atualizarOpcoesSetorTermo();
                return true;
            }
            const resultado = await callGoogleScript('getSetores');
            if (resultado.success) {
                const setores = normalizarListaSetores(resultado.data);
                estado.setores = setores;
                atualizarOpcoesSetorTermo(setores);
                return true;
            }
            return false;
        }
        async function carregarUsuarios() {
            if (!estado.autenticado || !perfilAtualEhAdmin()) {
                estado.usuarios = [];
                return true;
            }
            const resultado = await callGoogleScript('getUsuarios');
            if (resultado.success) {
                estado.usuarios = (resultado.data || []).map(usuario => ({
                    ...usuario,
                    unidades: normalizarListaDeUnidades(usuario.unidades)
                }));
                return true;
            }
            return false;
        }
        async function carregarEstatisticas() {
            atualizarResumoDashboardLocal();
            return true;
        }
        async function carregarNotificacoes() {
            if (!estado.autenticado) {
                estado.notificacoes = [];
                return true;
            }
            const resultado = await callGoogleScript('getNotificacoes');
            if (resultado.success) {
                estado.notificacoes = resultado.data;
                if (elementos.notificationBadge) {
                    elementos.notificationBadge.textContent = estado.notificacoes.length;
                }
                atualizarPainelNotificacoes();
                return true;
            }
            return false;
        }
        function sincronizarDadosArmariosEmSegundoPlano({
            recarregarArmarios = true,
            recarregarEstatisticas = true,
            recarregarTabelas = true,
            recarregarArmariosNasTabelas = true
        } = {}) {
            const tarefas = [];
            if (recarregarArmarios) {
                tarefas.push(carregarArmarios({ forcarAtualizacao: true }));
            }
            if (recarregarEstatisticas) {
                tarefas.push(carregarEstatisticas());
            }
            Promise.allSettled(tarefas)
                .then(() => {
                    if (recarregarTabelas) {
                        return carregarDadosTabelas({ recarregarArmarios: recarregarArmariosNasTabelas });
                    }
                    return null;
                })
                .catch(erro => {
                    console.error('Erro na sincroniza칞칚o em segundo plano:', erro);
                })
                .finally(() => {
                    atualizarResumoDashboardLocal();
                    atualizarInterface();
                });
        }
        function aguardarProximoFrame() {
            return new Promise(resolve => {
                if (typeof requestAnimationFrame === 'function') {
                    requestAnimationFrame(() => resolve());
                } else {
                    setTimeout(resolve, 16);
                }
            });
        }
        function restaurarDesenhoCanvas(canvas, dataUrl) {
            if (!canvas || !dataUrl) return;
            const ctx = canvas.getContext('2d');
            const imagem = new Image();
            imagem.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(imagem, 0, 0, canvas.width, canvas.height);
            };
            imagem.src = dataUrl.startsWith('data:') ? dataUrl : `data:image/png;base64,${dataUrl}`;
        }
        function inicializarCanvasAssinatura() {
            if (elementos.termoAssinaturaCanvas) {
                const assinaturaTermoExistente = termoAssinaturaDesenhada
                    ? elementos.termoAssinaturaCanvas.toDataURL('image/png')
                    : null;
                const rectTermo = elementos.termoAssinaturaCanvas.getBoundingClientRect();
                if (rectTermo.width && rectTermo.height) {
                    elementos.termoAssinaturaCanvas.width = rectTermo.width;
                    elementos.termoAssinaturaCanvas.height = rectTermo.height;
                }
                const ctxTermo = elementos.termoAssinaturaCanvas.getContext('2d');
                ctxTermo.lineWidth = 2;
                ctxTermo.lineCap = 'round';
                ctxTermo.lineJoin = 'round';
                ctxTermo.strokeStyle = '#0b1324';
                if (assinaturaTermoExistente) {
                    restaurarDesenhoCanvas(elementos.termoAssinaturaCanvas, assinaturaTermoExistente);
                }
            }
        }
        function debounce(fn, delay = 200) {
            let timeoutId;
            return function(...args) {
                const contexto = this;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(contexto, args), delay);
            };
        }
        function iniciarLoadingBotao(botao) {
            if (!botao) return () => {};
            const inicio = Date.now();
            const duracaoMinima = 180;
            botao.classList.add('btn-loading');
            botao.disabled = true;
            return () => {
                const encerrar = () => {
                    botao.classList.remove('btn-loading');
                    botao.disabled = false;
                };
                const decorrido = Date.now() - inicio;
                if (decorrido < duracaoMinima) {
                    setTimeout(encerrar, duracaoMinima - decorrido);
                } else {
                    encerrar();
                }
            };
        }
        function mostrarOverlayCarregamento(mensagem = 'Processando...') {
            if (!elementos.globalLoadingOverlay || !elementos.globalLoadingText) {
                return () => {};
            }
            const overlay = elementos.globalLoadingOverlay;
            const texto = elementos.globalLoadingText;
            texto.textContent = mensagem;
            overlay.classList.add('is-active');
            overlay.setAttribute('aria-hidden', 'false');
            const inicio = Date.now();
            return () => {
                const encerrar = () => {
                    overlay.classList.remove('is-active');
                    overlay.setAttribute('aria-hidden', 'true');
                };
                const decorrido = Date.now() - inicio;
                if (decorrido < 150) {
                    setTimeout(encerrar, 150 - decorrido);
                } else {
                    encerrar();
                }
            };
        }
        async function atualizarDadosPosOperacao(mensagemCarregamento = 'Atualizando informa칞칫es...', posAtualizacaoLocal) {
            const finalizarOverlay = mostrarOverlayCarregamento(mensagemCarregamento);
            try {
                const promessas = [
                    carregarArmarios({ forcarAtualizacao: true }),
                    carregarEstatisticas()
                ];

                if (DESCARTE_HABILITADO) {
                    promessas.push(carregarDescarte());
                }

                const [resultadoArmarios, resultadoEstatisticas, resultadoDescarte] = await Promise.allSettled(promessas);

                if (resultadoArmarios.status === 'rejected') {
                    console.error('Erro ao recarregar arm치rios ap칩s opera칞칚o:', resultadoArmarios.reason);
                } else if (resultadoArmarios.status === 'fulfilled' && resultadoArmarios.value === false) {
                    console.warn('Recarregamento de arm치rios n칚o p칪de ser conclu칤do ap칩s a opera칞칚o.');
                }

                if (resultadoEstatisticas.status === 'rejected') {
                    console.error('Erro ao atualizar estat칤sticas ap칩s opera칞칚o:', resultadoEstatisticas.reason);
                }
                if (DESCARTE_HABILITADO && resultadoDescarte && resultadoDescarte.status === 'rejected') {
                    console.error('Erro ao atualizar descarte ap칩s opera칞칚o:', resultadoDescarte.reason);
                }

                if (typeof posAtualizacaoLocal === 'function') {
                    try {
                        posAtualizacaoLocal({ resultadoArmarios, resultadoEstatisticas });
                    } catch (erroAtualizacaoLocal) {
                        console.error('Erro ao aplicar atualiza칞칚o local p칩s-opera칞칚o:', erroAtualizacaoLocal);
                    }
                }

                atualizarInterface();
                try {
                    await carregarDadosTabelas();
                } catch (erroCarregarTabelas) {
                    console.error('Erro ao recarregar dados das tabelas ap칩s opera칞칚o:', erroCarregarTabelas);
                }
            } finally {
                finalizarOverlay();
            }
        }
        function configurarBotaoAcao(botao, acao) {
            if (!botao) return;
            botao.addEventListener('click', async (event) => {
                const finalizar = iniciarLoadingBotao(event.currentTarget);
                try {
                    await acao();
                } finally {
                    finalizar();
                }
            });
        }
        function mostrarErro(mensagem) {
            Swal.fire({
                title: 'Erro',
                text: mensagem,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
        function mostrarSucesso(mensagem) {
            Swal.fire({
                title: 'Sucesso!',
                text: mensagem,
                icon: 'success',
                confirmButtonText: 'OK'
            });
        }
        function notificarErroPadrao(resultado, mensagemPadrao = 'Ocorreu um erro inesperado') {
            if (!resultado || resultado._erroNotificado) {
                return;
            }
            const mensagem = resultado.error || mensagemPadrao;
            mostrarErro(mensagem);
        }
        function calcularHoraPrevistaSaida() {
            const agora = new Date();
            agora.setHours(agora.getHours() + 1);
            const horas = String(agora.getHours()).padStart(2, '0');
            const minutos = String(agora.getMinutes()).padStart(2, '0');
            return `${horas}:${minutos}`;
        }
        function atualizarInterfaceVisitaEstendida({ manterHorarioManual = false } = {}) {
            const formulario = elementos.armarioForm;
            const checkbox = elementos.visitaEstendidaInput;
            const inputHora = elementos.horaPrevistaInput;
            if (!formulario || !checkbox || !inputHora) {
                return;
            }

            const visitaEstendida = Boolean(checkbox.checked);
            formulario.dataset.visitaEstendida = visitaEstendida ? 'true' : 'false';

            if (visitaEstendida) {
                if (inputHora.value) {
                    formulario.dataset.horaPrevistaAnterior = inputHora.value;
                }
                inputHora.value = '';
                inputHora.disabled = true;
                inputHora.required = false;
            } else {
                inputHora.disabled = false;
                inputHora.required = true;
                const valorAnterior = formulario.dataset.horaPrevistaAnterior || '';
                if (!manterHorarioManual) {
                    if (valorAnterior) {
                        inputHora.value = valorAnterior;
                    } else if (!inputHora.value) {
                        inputHora.value = calcularHoraPrevistaSaida();
                    }
                }
            }
            salvarRascunhoArmario();
        }
        // Configura칞칚o de eventos
        function inicializarEventos() {
            if (eventosInicializados) {
                return;
            }
            eventosInicializados = true;
            // Seletor de perfil
            if (elementos.profileSelect) {
                elementos.profileSelect.addEventListener('change', async function() {
                    estado.perfilAtual = this.value;
                    await carregarArmarios();
                    atualizarResumoDashboardLocal();
                    atualizarInterface();
                    carregarDadosTabelas();
                });
            }
            if (elementos.unitSelect) {
                elementos.unitSelect.addEventListener('change', async function() {
                    estado.unidadeAtual = this.value;
                    await carregarArmarios();
                    atualizarResumoDashboardLocal();
                    atualizarInterface();
                    carregarDadosTabelas();
                });
            }
            if (elementos.visitaEstendidaInput) {
                elementos.visitaEstendidaInput.addEventListener('change', () => {
                    atualizarInterfaceVisitaEstendida();
                    salvarRascunhoArmario();
                });
            }
            if (elementos.horaPrevistaInput) {
                elementos.horaPrevistaInput.addEventListener('input', () => {
                    if (elementos.armarioForm) {
                        elementos.armarioForm.dataset.horaPrevistaAnterior = elementos.horaPrevistaInput.value;
                    }
                    salvarRascunhoArmario();
                });
            }
            // Notifica칞칫es
            if (elementos.notificationBell) {
                elementos.notificationBell.addEventListener('click', function() {
                    elementos.notificationPanel.style.display =
                        elementos.notificationPanel.style.display === 'block' ? 'none' : 'block';
                });
            }
            if (elementos.headerUserProfile) {
                elementos.headerUserProfile.addEventListener('click', () => {
                    if (avatarModalAberto()) {
                        fecharModalAvatar({ focusTrigger: false });
                    } else {
                        abrirModalAvatar();
                    }
                });
                elementos.headerUserProfile.addEventListener('keydown', event => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        abrirModalAvatar();
                    }
                });
            }
            if (elementos.avatarModalClose) {
                elementos.avatarModalClose.addEventListener('click', () => fecharModalAvatar());
            }
            if (elementos.avatarModalBackdrop) {
                elementos.avatarModalBackdrop.addEventListener('click', event => {
                    if (event.target === elementos.avatarModalBackdrop) {
                        fecharModalAvatar();
                    }
                });
            }
            if (elementos.avatarOptions) {
                elementos.avatarOptions.addEventListener('click', event => {
                    const botao = event.target.closest('.avatar-option');
                    if (!botao) {
                        return;
                    }
                    event.preventDefault();
                    aplicarAvatarUsuario(botao.dataset.avatarUrl || '');
                });
                elementos.avatarOptions.addEventListener('keydown', event => {
                    if (event.key !== 'Enter' && event.key !== ' ') {
                        return;
                    }
                    const botao = event.target.closest('.avatar-option');
                    if (!botao) {
                        return;
                    }
                    event.preventDefault();
                    aplicarAvatarUsuario(botao.dataset.avatarUrl || '');
                });
            }
            if (elementos.avatarUrlApply) {
                elementos.avatarUrlApply.addEventListener('click', aplicarAvatarPersonalizado);
            }
            if (elementos.avatarUrlInput) {
                elementos.avatarUrlInput.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        aplicarAvatarPersonalizado();
                    }
                });
                elementos.avatarUrlInput.addEventListener('input', () => {
                    elementos.avatarUrlInput.classList.remove('invalid');
                    elementos.avatarUrlInput.removeAttribute('aria-invalid');
                });
            }
            // Fechar modais
            elementos.modalClose.addEventListener('click', fecharModalArmario);
            elementos.usuarioModalClose.addEventListener('click', fecharModalUsuario);
            elementos.btnCancelar.addEventListener('click', fecharModalArmario);
            elementos.usuarioBtnCancelar.addEventListener('click', fecharModalUsuario);
            // Filtros
            elementos.filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filtro = this.dataset.filter || 'todos';
                    alternarFiltroDashboard(filtro);
                    atualizarBotoesFiltroDashboard();
                    renderizarArmarios();
                });
            });
            if (elementos.dashboardSearch) {
                elementos.dashboardSearch.addEventListener('input', () => {
                    estado.buscaDashboard = elementos.dashboardSearch.value || '';
                    renderizarArmarios();
                });
            }
            if (elementos.toggleDadosButton) {
                elementos.toggleDadosButton.addEventListener('click', () => {
                    estado.ocultarDadosDashboard = !estado.ocultarDadosDashboard;
                    atualizarToggleDadosDashboard();
                    renderizarArmarios();
                });
            }
            if (elementos.contingenciaButton) {
                elementos.contingenciaButton.addEventListener('click', abrirCadastroContingencia);
            }
            atualizarBotoesFiltroDashboard();
            atualizarToggleDadosDashboard();
            const padraoLocalLiberacao = obterDataHoraLocalPadrao();
            if (elementos.liberacaoDataInicio) {
                const padraoInicio = converterDataTextoParaISO(elementos.liberacaoDataInicio.value) || padraoLocalLiberacao.data;
                elementos.liberacaoDataInicio.value = padraoInicio;
                elementos.liberacaoDataInicio.addEventListener('change', () => {
                    const iso = converterDataTextoParaISO(elementos.liberacaoDataInicio.value);
                    elementos.liberacaoDataInicio.value = iso || '';
                });
            }
            if (elementos.liberacaoDataFim) {
                const padraoFim = converterDataTextoParaISO(elementos.liberacaoDataFim.value) || padraoLocalLiberacao.data;
                elementos.liberacaoDataFim.value = padraoFim;
                elementos.liberacaoDataFim.addEventListener('change', () => {
                    const iso = converterDataTextoParaISO(elementos.liberacaoDataFim.value);
                    elementos.liberacaoDataFim.value = iso || '';
                });
            }
            if (elementos.liberacaoProntuario) {
                elementos.liberacaoProntuario.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        carregarTabelaLiberacao({ forcarAtualizacao: true });
                    }
                });
            }
            if (elementos.liberacaoPaciente) {
                elementos.liberacaoPaciente.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        carregarTabelaLiberacao({ forcarAtualizacao: true });
                    }
                });
            }
            if (elementos.liberacaoRefresh) {
                configurarBotaoAcao(elementos.liberacaoRefresh, async () => {
                    await carregarTabelaLiberacao({ forcarAtualizacao: true });
                });
            }
            // Formul치rios
            elementos.armarioForm.addEventListener('submit', function(e) {
                e.preventDefault();
                salvarArmario();
            });
            ['nome-visitante', 'nome-paciente', 'leito', 'whatsapp-contato', 'volumes', 'hora-prevista'].forEach(id => {
                const campo = document.getElementById(id);
                if (!campo) return;
                campo.addEventListener('input', salvarRascunhoArmario);
                campo.addEventListener('change', salvarRascunhoArmario);
            });
            [document.getElementById('leito'), elementos.termoLeito].forEach(campo => aplicarMascaraLeitoCampo(campo));
            elementos.usuarioForm.addEventListener('submit', function(e) {
                e.preventDefault();
                salvarUsuario();
            });
            // Navega칞칚o do menu
            elementos.menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.dataset.page;
                    if (!targetPage) {
                        return;
                    }
                    navegarParaPagina(targetPage);
                });
            });
            if (elementos.logoutButton) {
                elementos.logoutButton.addEventListener('click', realizarLogout);
            }
            // Bot칫es de a칞칚o
            configurarBotaoAcao(document.getElementById('btn-novo-visitante'), () => abrirModalNovoArmario('visitante'));
            configurarBotaoAcao(document.getElementById('btn-novo-acompanhante'), () => abrirModalNovoArmario('acompanhante'));
            configurarBotaoAcao(document.getElementById('btn-novo-armario'), () => abrirModalNovoArmarioFisico());
            configurarBotaoAcao(document.getElementById('btn-novo-usuario'), () => abrirModalNovoUsuario());
            configurarBotaoAcao(elementos.btnNovaUnidade, () => abrirModalNovaUnidade());
            if (elementos.ocupacaoRapidaForm) {
                elementos.ocupacaoRapidaForm.addEventListener('submit', async (evento) => {
                    evento.preventDefault();
                    await submeterOcupacaoAcompanhantes();
                });
            }
            if (elementos.ocupacaoArmario) {
                elementos.ocupacaoArmario.addEventListener('change', () => {
                    const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
                    estadoOcupacao.armarioSelecionado = elementos.ocupacaoArmario.value || '';
                    const rascunho = estadoOcupacao.armarioSelecionado
                        ? obterRascunhoOcupacaoArmario(estadoOcupacao.armarioSelecionado)
                        : null;
                    if (rascunho) {
                        if (elementos.ocupacaoPaciente) elementos.ocupacaoPaciente.value = rascunho.paciente || '';
                        if (elementos.ocupacaoProntuario) elementos.ocupacaoProntuario.value = rascunho.prontuario || '';
                        if (elementos.ocupacaoAcompanhante) elementos.ocupacaoAcompanhante.value = rascunho.acompanhante || '';
                    } else {
                        if (elementos.ocupacaoPaciente) elementos.ocupacaoPaciente.value = '';
                        if (elementos.ocupacaoProntuario) elementos.ocupacaoProntuario.value = '';
                        if (elementos.ocupacaoAcompanhante) elementos.ocupacaoAcompanhante.value = '';
                    }
                });
            }
            const atualizarRascunhoFormularioOcupacao = (campo, valor) => {
                const idSelecionado = elementos.ocupacaoArmario?.value?.trim();
                if (!idSelecionado) return;
                atualizarRascunhoOcupacao(idSelecionado, campo, valor || '');
            };
            if (elementos.ocupacaoPaciente) {
                elementos.ocupacaoPaciente.addEventListener('input', (evento) => {
                    atualizarRascunhoFormularioOcupacao('paciente', evento.target.value);
                });
            }
            if (elementos.ocupacaoProntuario) {
                elementos.ocupacaoProntuario.addEventListener('input', (evento) => {
                    atualizarRascunhoFormularioOcupacao('prontuario', evento.target.value);
                });
            }
            if (elementos.ocupacaoAcompanhante) {
                elementos.ocupacaoAcompanhante.addEventListener('input', (evento) => {
                    atualizarRascunhoFormularioOcupacao('acompanhante', evento.target.value);
                });
            }
            if (elementos.ocupacaoFiltro) {
                elementos.ocupacaoFiltro.addEventListener('input', debounce(() => {
                    const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
                    estadoOcupacao.filtro = elementos.ocupacaoFiltro.value || '';
                    carregarOcupacaoAcompanhantes({ recarregarArmarios: false });
                }, 200));
            }
            if (elementos.ocupacaoSalvarTodos) {
                elementos.ocupacaoSalvarTodos.addEventListener('click', salvarTodasOcupacoesPreenchidas);
            }
            // Termo de responsabilidade
            elementos.termoBtnVoltar.addEventListener('click', () => navegarPassoTermo(-1));
            elementos.termoBtnVoltar.addEventListener('keydown', event => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    navegarPassoTermo(-1);
                }
            });
            elementos.termoBtnAvancar.addEventListener('click', avancarOuAplicarTermo);
            elementos.termoBtnCancelar.addEventListener('click', fecharTermoModal);
            elementos.termoModalClose.addEventListener('click', fecharTermoModal);
            if (elementos.termoProntuario) {
                const dispararBuscaPaciente = debounce(() => preencherPacientePorProntuario({ forcar: true }), 200);
                elementos.termoProntuario.addEventListener('change', dispararBuscaPaciente);
                elementos.termoProntuario.addEventListener('blur', dispararBuscaPaciente);
                elementos.termoProntuario.addEventListener('keydown', event => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        dispararBuscaPaciente();
                    }
                });
            }
            if (elementos.termoForm) {
                elementos.termoForm.addEventListener('input', salvarRascunhoTermo);
                elementos.termoForm.addEventListener('change', salvarRascunhoTermo);
            }
            if (elementos.termoNascimento) {
                elementos.termoNascimento.addEventListener('input', () => normalizarCampoDataNascimento(elementos.termoNascimento));
                elementos.termoNascimento.addEventListener('blur', () => finalizarCampoDataNascimento(elementos.termoNascimento));
            }
            if (elementos.termoAddVolume) {
                elementos.termoAddVolume.addEventListener('click', () => {
                    const novoVolume = adicionarVolumeTermo();
                    novoVolume?.querySelector('.termo-volume-qty')?.focus();
                    salvarRascunhoTermo();
                });
            }
            if (elementos.termoVolumesList) {
                elementos.termoVolumesList.addEventListener('click', evento => {
                    const botao = evento.target.closest('.btn-remove-volume');
                    if (!botao) return;
                    const item = botao.closest('.wizard-volume-item');
                    removerVolumeTermo(item);
                    salvarRascunhoTermo();
                });
                elementos.termoVolumesList.addEventListener('input', () => {
                    elementos.termoVolumesField?.classList.remove('invalid');
                    salvarRascunhoTermo();
                });
            }
            if (elementos.termoAssinaturaClear) {
                elementos.termoAssinaturaClear.addEventListener('click', () => {
                    limparAssinaturaTermo();
                    salvarRascunhoTermo();
                });
            }
            if (elementos.termoAssinaturaCanvas) {
                elementos.termoAssinaturaCanvas.addEventListener('pointerdown', iniciarAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointermove', desenharAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointerup', finalizarAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointerleave', finalizarAssinaturaTermo);
                elementos.termoAssinaturaCanvas.addEventListener('pointercancel', finalizarAssinaturaTermo);
            }
            window.addEventListener('resize', debounce(() => {
                inicializarCanvasAssinatura();
            }, 150));
            // Movimenta칞칫es
            elementos.movimentacaoModalClose.addEventListener('click', fecharMovimentacaoModal);
            elementos.movimentacaoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const botao = elementos.movimentacaoForm.querySelector('button[type="submit"]');
                const finalizarLoading = iniciarLoadingBotao(botao);
                try {
                    await salvarMovimentacao();
                } finally {
                    finalizarLoading();
                }
            });
            // Tabela de termos
            elementos.tabelaTermos.addEventListener('click', tratarAcaoTermo);
            if (elementos.tabelaUnidadesBody) {
                elementos.tabelaUnidadesBody.addEventListener('click', tratarAcaoUnidade);
            }
            const tabelaVisitantes = document.querySelector('#tabela-visitantes');
            if (tabelaVisitantes) {
                tabelaVisitantes.addEventListener('click', async (evento) => {
                    const alvo = evento.target.closest('[data-action]');
                    if (!alvo) return;
                    const id = extrairIdDataset(alvo);
                    if (!id) return;
                    const acao = alvo.dataset.action;
                    let finalizarLoading = () => {};
                    if (alvo.tagName === 'BUTTON') {
                        finalizarLoading = iniciarLoadingBotao(alvo);
                    }
                    try {
                        switch (acao) {
                            case 'usar':
                                usarArmario(id);
                                break;
                            case 'liberar':
                                if ((alvo.dataset.tipo || '').toLowerCase() === 'visitante') {
                                    await confirmarLiberacaoVisitante(id);
                                } else {
                                    await confirmarLiberacaoAcompanhante(id);
                                }
                                break;
                            default:
                                break;
                        }
                    } finally {
                        finalizarLoading();
                    }
                });
            }
            const tabelaAcompanhantes = document.querySelector('#tabela-acompanhantes');
            if (tabelaAcompanhantes) {
                tabelaAcompanhantes.addEventListener('click', async (evento) => {
                    const alvo = evento.target.closest('[data-action]');
                    if (!alvo) return;
                    const id = extrairIdDataset(alvo);
                    if (!id) return;
                    const acao = alvo.dataset.action;
                    let finalizarLoading = () => {};
                    if (alvo.tagName === 'BUTTON') {
                        finalizarLoading = iniciarLoadingBotao(alvo);
                    }
                    try {
                        switch (acao) {
                            case 'usar':
                                usarArmario(id);
                                break;
                            case 'liberar':
                                await confirmarLiberacaoAcompanhante(id);
                                break;
                            case 'mov':
                                await abrirMovimentacoes(id);
                                break;
                            case 'termo':
                                await abrirTermoWizard(id);
                                break;
                            default:
                                break;
                        }
                    } finally {
                        finalizarLoading();
                    }
                });
            }
            if (elementos.tabelaOcupacaoAcompanhantesBody) {
                elementos.tabelaOcupacaoAcompanhantesBody.addEventListener('click', (evento) => {
                    const botaoSelecionar = evento.target.closest('[data-action="selecionar-ocupacao"]');
                    if (botaoSelecionar) {
                        selecionarArmarioParaOcupacao(botaoSelecionar.dataset.id || '');
                        return;
                    }
                    const botaoSalvar = evento.target.closest('[data-action="salvar-ocupacao"]');
                    if (botaoSalvar) {
                        salvarOcupacaoIndividual(botaoSalvar.dataset.id || '', botaoSalvar);
                    }
                });
                elementos.tabelaOcupacaoAcompanhantesBody.addEventListener('input', (evento) => {
                    const input = evento.target.closest('[data-ocupacao-id][data-ocupacao-campo]');
                    if (!input) return;
                    atualizarRascunhoOcupacao(input.dataset.ocupacaoId, input.dataset.ocupacaoCampo, input.value || '');
                });
            }
            if (elementos.tabelaUsuariosBody) {
                elementos.tabelaUsuariosBody.addEventListener('click', tratarAcaoUsuario);
            }
            if (elementos.usuarioUnidades) {
                elementos.usuarioUnidades.addEventListener('change', tratarAlteracaoUnidadeUsuario);
            }
            // Fechar notifica칞칫es ao clicar fora
            document.addEventListener('click', function(e) {
                if (!elementos.notificationBell.contains(e.target) &&
                    !elementos.notificationPanel.contains(e.target)) {
                    elementos.notificationPanel.style.display = 'none';
                }
            });
            document.addEventListener('keydown', event => {
                if (event.key === 'Escape' && avatarModalAberto()) {
                    fecharModalAvatar();
                }
            });
        }
        // Navega칞칚o entre p치ginas
        function navegarParaPagina(pagina) {
            if (!usuarioTemAcessoPagina(pagina)) {
                mostrarErro('Voc칡 n칚o tem permiss칚o para acessar esta 치rea.');
                return;
            }
            // Atualizar menu ativo
            elementos.menuLinks.forEach(link => link.classList.remove('active'));
            const linkAlvo = document.querySelector(`[data-page="${pagina}"]`);
            if (!linkAlvo) {
                return;
            }
            linkAlvo.classList.add('active');

            // Atualizar p치gina ativa
            elementos.pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pagina).classList.add('active');

            // Atualizar t칤tulo
            const pageTitle = linkAlvo.querySelector('span')?.textContent || '';
            document.querySelector('.header-title h1').textContent = pageTitle;

            estado.paginaAtual = pagina;

            // Carregar dados espec칤ficos da p치gina
            carregarDadosTabelas();
        }
        // Atualizar interface baseada no perfil
        function atualizarInterface() {
            atualizarVisibilidadeContingencia();
            // Renderizar arm치rios
            if (estado.paginaAtual === 'dashboard') {
                renderizarDescarte();
                renderizarArmarios();
            }
        }
        function atualizarVisibilidadeContingencia() {
            if (!elementos.contingenciaButton) return;
            const perfilNormalizado = normalizarTexto(estado.perfilAtual);
            const visivel = perfilAtualEhAcompanhante()
                || perfilNormalizado === 'geral'
                || perfilNormalizado === 'todos'
                || perfilAtualEhAdmin();
            elementos.contingenciaButton.style.display = visivel ? 'inline-flex' : 'none';
        }
        function obterFiltrosAtivosDashboard() {
            if (!Array.isArray(estado.filtrosSelecionados) || estado.filtrosSelecionados.length === 0) {
                estado.filtrosSelecionados = ['todos'];
            }
            return estado.filtrosSelecionados;
        }
        function atualizarBotoesFiltroDashboard() {
            const ativos = obterFiltrosAtivosDashboard();
            elementos.filterBtns.forEach(botao => {
                const filtro = botao.dataset.filter || 'todos';
                botao.classList.toggle('active', ativos.includes(filtro));
            });
        }
        function atualizarToggleDadosDashboard() {
            if (!elementos.toggleDadosButton) {
                return;
            }
            const ocultar = !!estado.ocultarDadosDashboard;
            elementos.toggleDadosButton.classList.toggle('ativo', ocultar);
            elementos.toggleDadosButton.setAttribute('aria-pressed', ocultar.toString());
            const icone = elementos.toggleDadosButton.querySelector('i');
            const label = elementos.toggleDadosButton.querySelector('.toggle-dados-label');
            if (icone) {
                icone.className = ocultar ? 'fas fa-eye-slash' : 'fas fa-eye';
            }
            if (label) {
                label.textContent = ocultar ? 'Exibir dados' : 'Ocultar dados';
            }
        }
        function alternarFiltroDashboard(filtroSelecionado) {
            if (!filtroSelecionado || filtroSelecionado === 'todos') {
                estado.filtrosSelecionados = ['todos'];
                return;
            }
            const atuais = Array.isArray(estado.filtrosSelecionados)
                ? estado.filtrosSelecionados.filter(Boolean)
                : [];
            const conjunto = new Set(atuais);
            conjunto.delete('todos');
            if (conjunto.has(filtroSelecionado)) {
                conjunto.delete(filtroSelecionado);
            } else {
                conjunto.add(filtroSelecionado);
            }
            if (conjunto.size === 0) {
                conjunto.add('todos');
            }
            estado.filtrosSelecionados = Array.from(conjunto);
        }
        function armarioCorrespondeBusca(armario, termoBusca) {
            const filtroNormalizado = normalizarTextoBusca(termoBusca);
            if (!filtroNormalizado) {
                return true;
            }
            const campos = [
                armario.numero,
                armario.prontuario,
                armario.nomePaciente,
                armario.nomeVisitante,
                armario.unidade,
                armario.acompanhante,
                armario.responsavel
            ];
            return campos.some(campo => normalizarTextoBusca(campo).includes(filtroNormalizado));
        }
        function armarioEhContingencia(armario) {
            if (!armario) return false;
            if (armario.ehContingencia) return true;
            const numeroNormalizado = normalizarTexto(armario.numero);
            const statusNormalizado = normalizarTexto(armario.status);
            return numeroNormalizado.startsWith('contingencia') || statusNormalizado === 'contingencia';
        }
        function obterResumoDescartePadrao() {
            return criarEstadoDescarteInicial().resumo;
        }
        function formatarRotuloStatusDescarte(status) {
            const chave = normalizarTexto(status);
            switch (chave) {
                case 'vencido':
                    return 'Vencido';
                case 'alerta':
                    return 'Vence em 48h';
                case 'no-prazo':
                    return 'No prazo';
                case 'descartado':
                    return 'Descartado';
                default:
                    return 'Aguardando alta';
            }
        }
        function renderizarDescarte() {
            if (!DESCARTE_HABILITADO) return;
            const resumo = estado.descarte?.resumo || obterResumoDescartePadrao();
            if (elementos.descarteVencido) elementos.descarteVencido.textContent = resumo.vencido || 0;
            if (elementos.descarteAlerta) elementos.descarteAlerta.textContent = resumo.alerta || 0;
            if (elementos.descarteNoPrazo) elementos.descarteNoPrazo.textContent = resumo.noPrazo || 0;
            if (elementos.descartePendenteAlta) elementos.descartePendenteAlta.textContent = resumo.pendenteAlta || 0;
            if (elementos.descarteDescartado) elementos.descarteDescartado.textContent = resumo.descartado || 0;

            const container = elementos.descarteLista;
            if (!container) return;
            container.innerHTML = '';

            const itens = Array.isArray(estado.descarte?.itens) ? [...estado.descarte.itens] : [];
            if (!itens.length) {
                const vazio = document.createElement('div');
                vazio.className = 'descarte-vazio';
                vazio.textContent = 'Nenhum item aguardando descarte.';
                container.appendChild(vazio);
                return;
            }

            const pesos = { vencido: 0, alerta: 1, 'no-prazo': 2, 'pendente-alta': 3, descartado: 4 };
            itens.sort((a, b) => {
                const pesoA = pesos[normalizarTexto(a.status)] ?? 99;
                const pesoB = pesos[normalizarTexto(b.status)] ?? 99;
                if (pesoA !== pesoB) return pesoA - pesoB;
                const diasA = Number.isFinite(a.diasRestantes) ? a.diasRestantes : 999;
                const diasB = Number.isFinite(b.diasRestantes) ? b.diasRestantes : 999;
                return diasA - diasB;
            });

            itens.forEach(item => {
                const statusClasse = normalizarTexto(item.status) || 'pendente-alta';
                const card = document.createElement('div');
                card.className = 'descarte-card';

                const linhaTopo = document.createElement('div');
                linhaTopo.className = 'linha';
                const titulo = document.createElement('div');
                titulo.className = 'titulo';
                titulo.textContent = item.paciente || '-';
                const prontuario = document.createElement('span');
                prontuario.className = 'detalhe';
                prontuario.textContent = `Pront. ${item.prontuario || '-'}`;
                titulo.appendChild(document.createTextNode(' '));
                titulo.appendChild(prontuario);
                const statusTag = document.createElement('span');
                statusTag.className = `descarte-status ${statusClasse}`;
                statusTag.textContent = formatarRotuloStatusDescarte(statusClasse);
                linhaTopo.append(titulo, statusTag);

                const linhaItem = document.createElement('div');
                linhaItem.className = 'linha';
                const itemDescricao = document.createElement('span');
                itemDescricao.className = 'detalhe';
                itemDescricao.textContent = item.item || 'Volume n칚o informado';
                linhaItem.appendChild(itemDescricao);
                if (item.armario) {
                    const armarioInfo = document.createElement('span');
                    armarioInfo.className = 'detalhe';
                    armarioInfo.textContent = `Arm치rio ${item.armario}`;
                    linhaItem.appendChild(armarioInfo);
                }

                const datas = document.createElement('div');
                datas.className = 'descarte-datas';
                const altaSpan = document.createElement('span');
                altaSpan.textContent = `Alta: ${formatarData(item.dataAlta)}`;
                const limiteSpan = document.createElement('span');
                limiteSpan.textContent = `Limite: ${formatarData(item.dataLimite)}`;
                datas.append(altaSpan, limiteSpan);

                const diasSpan = document.createElement('span');
                if (statusClasse === 'descartado' && item.descartadoEm) {
                    diasSpan.textContent = `Descartado em ${formatarData(item.descartadoEm)}`;
                } else if (statusClasse === 'vencido' || statusClasse === 'alerta' || statusClasse === 'no-prazo') {
                    if (Number.isFinite(item.diasRestantes)) {
                        diasSpan.textContent = statusClasse === 'vencido'
                            ? `Atraso: ${Math.abs(item.diasRestantes)} dia(s)`
                            : `Restam ${item.diasRestantes} dia(s)`;
                    }
                } else if (statusClasse === 'pendente-alta') {
                    diasSpan.textContent = 'Alta n칚o encontrada na base';
                }
                if (diasSpan.textContent) {
                    datas.appendChild(diasSpan);
                }
                if (item.destinoAtual) {
                    const destino = document.createElement('span');
                    destino.className = 'detalhe';
                    destino.textContent = `Destino: ${item.destinoAtual}`;
                    datas.appendChild(destino);
                }

                card.append(linhaTopo, linhaItem, datas);
                container.appendChild(card);
            });
        }
        // Renderizar lista de arm치rios no dashboard
        function renderizarArmarios() {
            elementos.armariosContainer.innerHTML = '';
            if (elementos.dashboardSearch && elementos.dashboardSearch.value !== (estado.buscaDashboard || '')) {
                elementos.dashboardSearch.value = estado.buscaDashboard || '';
            }
            const perfil = estado.perfilAtual;
            const unidadeFiltro = estado.unidadeAtual;
            const perfilNormalizado = normalizarTexto(perfil);
            const unidadeFiltroNormalizado = normalizarTexto(unidadeFiltro);
            let armariosParaExibir = estado.armarios.filter(a => {
                const tipoNormalizado = normalizarTexto(a.tipo);
                const correspondePerfil = perfilNormalizado === 'geral' || perfilNormalizado === 'todos' || tipoNormalizado === perfilNormalizado;
                const correspondeUnidade = unidadeFiltroNormalizado === 'todas' ||
                    normalizarTexto(a.unidade) === unidadeFiltroNormalizado;
                return correspondePerfil && correspondeUnidade;
            }).filter(a => !(armarioEhContingencia(a) && normalizarTexto(a.status) === 'livre'));
            // Aplicar filtro
            const filtrosAtivos = obterFiltrosAtivosDashboard();
            if (!filtrosAtivos.includes('todos')) {
                armariosParaExibir = armariosParaExibir.filter(a => filtrosAtivos.includes(a.status));
            }
            // Aplicar busca por texto
            const termoBusca = estado.buscaDashboard;
            if (termoBusca) {
                armariosParaExibir = armariosParaExibir.filter(armario => armarioCorrespondeBusca(armario, termoBusca));
            }
            armariosParaExibir.forEach(armario => {
                const card = document.createElement('div');
                const classeStatus = armarioEhContingencia(armario) ? 'contingencia' : armario.status;
                card.className = `armario-card ${classeStatus}`;
                card.dataset.id = armario.id;
                if (armario.visitaEstendida) {
                    card.classList.add('visita-estendida');
                }
                if (armario.pacienteDeAlta) {
                    card.classList.add('alta-registrada');
                }
                const rascunho = estado.ocupacaoAcompanhantes?.rascunhos?.[armario.id];
                const rascunhoAtivo = normalizarTexto(armario.tipo) === 'acompanhante' && rascunhoOcupacaoTemDados(rascunho);
                let detailsHTML = '';
                if (armario.status === 'livre') {
                    detailsHTML += '<p>Dispon칤vel para uso</p>';
                } else if (estado.ocultarDadosDashboard) {
                    const paciente = armario.nomePaciente || '-';
                    const prontuario = armario.prontuario || '-';
                    detailsHTML += `
                        <p><strong>Paciente:</strong> ${paciente}</p>
                        <p><strong>Prontu치rio:</strong> ${prontuario}</p>
                    `;
                } else {
                    const termoHtml = armario.tipo === 'acompanhante'
                        ? `<p><strong>Termo:</strong> ${formatarStatusTermo(armario.termoStatus)}</p>`
                        : '';
                    const dataRegistroFormatada = formatarDataComDiaSemana(armario.dataRegistro);
                    const dataRegistroHtml = `<p><strong>Data:</strong> ${dataRegistroFormatada}</p>`;
                    const altaInfoHtml = armario.pacienteDeAlta
                        ? `<p class="armario-alerta-info"><i class="fas fa-heartbeat" aria-hidden="true"></i> Alta em ${formatarData(armario.dataAltaReferencia)}${armario.destinoAtual ? `  Destino: ${armario.destinoAtual}` : ''}</p>`
                        : '';
                    detailsHTML += `
                        <p><strong>${armario.tipo === 'acompanhante' ? 'Acompanhante' : 'Visitante'}:</strong> ${armario.nomeVisitante}</p>
                        <p><strong>Paciente:</strong> ${armario.nomePaciente}</p>
                        <p><strong>Prontu치rio:</strong> ${armario.prontuario || '-'}</p>
                        <p><strong>Leito:</strong> ${armario.leito}</p>
                        <p><strong>Volumes:</strong> ${armario.volumes}</p>
                        ${armario.whatsapp ? `<p><strong>WhatsApp:</strong> ${armario.whatsapp}</p>` : ''}
                        <p><strong>In칤cio:</strong> ${armario.horaInicio}</p>
                        ${armario.visitaEstendida
                            ? '<p><strong>Visita:</strong> Estendida</p>'
                            : (armario.horaPrevista ? `<p><strong>Previs칚o de sa칤da:</strong> ${armario.horaPrevista}</p>` : '')}
                        ${termoHtml}
                        ${dataRegistroHtml}
                        ${altaInfoHtml}
                    `;
                }
                const statusTexto = armarioEhContingencia(armario)
                    ? 'Conting칡ncia'
                    : armario.status === 'livre'
                        ? 'Livre'
                        : armario.status === 'em-uso'
                            ? 'Em uso'
                            : armario.status === 'proximo'
                                ? 'Pr칩ximo'
                                : 'Vencido';
                const statusHtml = `
                    <div class="armario-status status-${classeStatus}">
                        ${statusTexto}
                    </div>
                `;
                const destaqueVisita = armario.visitaEstendida
                    ? `<div class="armario-highlight"><span class="visita-estendida-tag"><i class="fas fa-infinity" aria-hidden="true"></i> Visita estendida</span></div>`
                    : '';
                const alertaAltaChip = armario.pacienteDeAlta
                    ? '<span class="alerta-alta-chip" title="Alta registrada na planilha Base Vitae 1">Alta registrada</span>'
                    : '';
                card.innerHTML = `
                    <div class="armario-header">
                        <div class="armario-number">${armario.numero}</div>
                        <div class="armario-header-right">
                            ${destaqueVisita}
                            ${alertaAltaChip}
                            ${rascunhoAtivo ? '<span class="armario-draft-badge" title="Pr칠-cadastro incompleto nesta esta칞칚o">Incompleto</span>' : ''}
                            ${statusHtml}
                        </div>
                    </div>
                    <div class="armario-details">
                        ${detailsHTML}
                    </div>
                `;
                card.addEventListener('click', () => abrirModalArmario(armario));
                elementos.armariosContainer.appendChild(card);
            });
        }

        function atualizarResumoDashboardLocal() {
            const totais = {
                livres: 0,
                emUso: 0,
                proximo: 0,
                vencidos: 0
            };

            const perfilFiltro = normalizarTexto(estado.perfilAtual);
            const unidadeFiltro = normalizarTexto(estado.unidadeAtual);

            estado.armarios.forEach(armario => {
                const tipoNormalizado = normalizarTexto(armario.tipo);
                const unidadeNormalizada = normalizarTexto(armario.unidade);

                if (perfilFiltro !== 'geral' && perfilFiltro !== 'todos' && tipoNormalizado !== perfilFiltro) {
                    return;
                }

                if (unidadeFiltro !== 'todas' && unidadeNormalizada !== unidadeFiltro) {
                    return;
                }

                switch (armario.status) {
                    case 'livre':
                        totais.livres += 1;
                        break;
                    case 'em-uso':
                        totais.emUso += 1;
                        break;
                    case 'proximo':
                        totais.proximo += 1;
                        break;
                    case 'vencido':
                        totais.vencidos += 1;
                        break;
                    default:
                        break;
                }
            });

            elementos.cardsCount.livres.textContent = totais.livres;
            elementos.cardsCount.emUso.textContent = totais.emUso;
            elementos.cardsCount.proximo.textContent = totais.proximo;
            elementos.cardsCount.vencidos.textContent = totais.vencidos;
        }

        function atualizarArmarioLocal(id, atualizacoes) {
            const indice = estado.armarios.findIndex(armario => armario.id === id);
            if (indice === -1) {
                return null;
            }

            const armarioAtualizado = {
                ...estado.armarios[indice],
                ...atualizacoes
            };

            estado.armarios[indice] = armarioAtualizado;
            return armarioAtualizado;
        }

        function garantirArmarioLiberadoLocal(id, metodo, confirmacao) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                return false;
            }

            const atualizacoes = {};
            let precisaAtualizar = false;
            const statusNormalizado = normalizarTexto(armario.status);
            const tipoNormalizado = normalizarTexto(armario.tipo);
            const termoStatusNormalizado = normalizarTexto(armario.termoStatus);

            if (statusNormalizado !== 'livre') {
                Object.assign(atualizacoes, {
                    status: 'livre',
                    nomeVisitante: '',
                    nomePaciente: '',
                    leito: '',
                    volumes: '',
                    whatsapp: '',
                    horaInicio: '',
                    horaPrevista: '',
                    visitaEstendida: false
                });
                precisaAtualizar = true;
            }

            if (tipoNormalizado === 'acompanhante') {
                if (!armario.termoFinalizado) {
                    atualizacoes.termoFinalizado = true;
                    precisaAtualizar = true;
                }
                if (armario.termoAplicado) {
                    atualizacoes.termoAplicado = false;
                    precisaAtualizar = true;
                }
                if (termoStatusNormalizado !== 'finalizado') {
                    atualizacoes.termoStatus = 'finalizado';
                    precisaAtualizar = true;
                }

                const termoAtualizado = { ...(armario.termoInfo || {}) };
                let atualizouTermo = false;

                if (!termoAtualizado.finalizadoEm) {
                    termoAtualizado.finalizadoEm = new Date().toISOString();
                    atualizouTermo = true;
                }

                if (metodo && termoAtualizado.metodoFinal !== metodo) {
                    termoAtualizado.metodoFinal = metodo;
                    atualizouTermo = true;
                }

                if (metodo === 'cpf' && confirmacao && termoAtualizado.cpfConfirmacao !== confirmacao) {
                    termoAtualizado.cpfConfirmacao = confirmacao;
                    atualizouTermo = true;
                }

                if (normalizarTexto(termoAtualizado.status) !== 'finalizado') {
                    termoAtualizado.status = 'Finalizado';
                    atualizouTermo = true;
                }

                if (!armario.termoInfo || atualizouTermo) {
                    atualizacoes.termoInfo = termoAtualizado;
                    precisaAtualizar = true;
                }
            }

            if (!precisaAtualizar) {
                return false;
            }

            return Boolean(atualizarArmarioLocal(id, atualizacoes));
        }
        // Carregar dados nas tabelas
        async function carregarDadosTabelas(opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            const unidadeFiltro = estado.unidadeAtual;
            try {
                // Carregar dados espec칤ficos da p치gina atual
                switch(estado.paginaAtual) {
                    case 'visitantes':
                        await carregarTabelaVisitantes(unidadeFiltro, { recarregarArmarios });
                        break;
                    case 'acompanhantes':
                        await carregarTabelaAcompanhantes(unidadeFiltro, { recarregarArmarios });
                        break;
                    case 'ocupacao-acompanhantes':
                        await carregarOcupacaoAcompanhantes({ recarregarArmarios });
                        break;
                    case 'historico-visitantes':
                        await carregarHistoricoVisitantes();
                        break;
                    case 'historico-acompanhantes':
                        await carregarHistoricoAcompanhantes();
                        break;
                    case 'liberacao':
                        await carregarTabelaLiberacao();
                        break;
                    case 'termo-responsabilidade':
                        await carregarTabelaTermos({ recarregarArmarios });
                        break;
                    case 'cadastro-armarios':
                        await carregarCadastroArmarios(unidadeFiltro);
                        break;
                    case 'cadastro-unidades':
                        renderizarTabelaUnidades();
                        break;
                    case 'usuarios':
                        await carregarTabelaUsuarios();
                        break;
                    case 'logs':
                        await carregarTabelaLogs();
                        break;
                }
            } catch (error) {
                console.error('Erro ao carregar dados da tabela:', error);
                mostrarErro('Erro ao carregar dados');
            }
        }
        function mostrarEstadoTabelaLiberacao(mensagem, tipo = 'empty') {
            const tbody = elementos.tabelaLiberacaoBody;
            if (!tbody) return;
            const estadoLiberacao = obterEstadoLiberacao();
            const colunas = Math.max(
                estadoLiberacao.colunas?.length || estadoLiberacao.linhas?.[0]?.length || 0,
                7
            );
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = colunas;
            if (tipo === 'loading') {
                td.className = 'table-loading';
            } else if (tipo === 'error') {
                td.className = 'table-error';
            } else {
                td.className = 'table-empty';
            }
            td.textContent = mensagem;
            tr.appendChild(td);
            tbody.innerHTML = '';
            tbody.appendChild(tr);
        }
        function atualizarResumoLiberacao() {
            const resumoEl = elementos.liberacaoResumo;
            if (!resumoEl) return;
            const estadoLiberacao = obterEstadoLiberacao();
            if (estadoLiberacao.carregando) {
                resumoEl.textContent = 'Carregando registros de libera칞칚o...';
                return;
            }
            if (estadoLiberacao.erro) {
                resumoEl.textContent = estadoLiberacao.erro;
                return;
            }
            if (!estadoLiberacao.linhasCarregadas) {
                resumoEl.textContent = 'Selecione um per칤odo para visualizar os registros de libera칞칚o.';
                return;
            }
            const filtros = estadoLiberacao.filtros || {};
            let periodoDescricao = '';
            if (filtros.dataInicio && filtros.dataFim) {
                periodoDescricao = filtros.dataInicio === filtros.dataFim
                    ? formatarData(filtros.dataInicio)
                    : `${formatarData(filtros.dataInicio)} a ${formatarData(filtros.dataFim)}`;
            }
            const detalhes = [];
            if (periodoDescricao) {
                detalhes.push(`Per칤odo: ${periodoDescricao}`);
            }
            if (filtros.prontuario) {
                detalhes.push(`Prontu치rio: ${filtros.prontuario}`);
            }
            if (filtros.paciente) {
                detalhes.push(`Paciente: ${filtros.paciente}`);
            }
            if (!estadoLiberacao.totalFiltrado) {
                resumoEl.textContent = detalhes.length
                    ? `Nenhum registro encontrado (${detalhes.join('  ')}).`
                    : 'Nenhum registro encontrado para o per칤odo selecionado.';
                return;
            }
            const horaAtualizacao = estadoLiberacao.ultimaAtualizacao
                ? new Date(estadoLiberacao.ultimaAtualizacao)
                : new Date();
            const horaFormatada = horaAtualizacao.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const totalPlanilha = estadoLiberacao.totalPlanilha || estadoLiberacao.totalFiltrado;
            const prefixo = `${estadoLiberacao.totalFiltrado} de ${totalPlanilha} registros exibidos`;
            const detalhesTexto = detalhes.length ? `${detalhes.join('  ')}  ` : '';
            resumoEl.textContent = `${prefixo}  ${detalhesTexto}Atualizado 맙 ${horaFormatada}`;
        }
        function renderizarTabelaLiberacao() {
            const headRow = elementos.tabelaLiberacaoHead;
            const tbody = elementos.tabelaLiberacaoBody;
            if (!headRow || !tbody) return;
            const estadoLiberacao = obterEstadoLiberacao();
            const colunas = Array.isArray(estadoLiberacao.colunas) ? estadoLiberacao.colunas : [];
            const linhas = Array.isArray(estadoLiberacao.linhas) ? estadoLiberacao.linhas : [];
            const totalColunas = colunas.length || (linhas[0]?.length ?? 0);
            headRow.innerHTML = '';
            if (colunas.length) {
                const fragmentHead = document.createDocumentFragment();
                colunas.forEach(coluna => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.textContent = coluna || '';
                    fragmentHead.appendChild(th);
                });
                headRow.appendChild(fragmentHead);
            }
            tbody.innerHTML = '';
            if (!linhas.length) {
                mostrarEstadoTabelaLiberacao('Nenhum registro encontrado para o per칤odo selecionado.');
                return;
            }
            const fragmentBody = document.createDocumentFragment();
            linhas.forEach(linha => {
                const tr = document.createElement('tr');
                const limiteColunas = totalColunas || linha.length;
                for (let i = 0; i < limiteColunas; i++) {
                    const td = document.createElement('td');
                    const valor = linha[i] !== undefined && linha[i] !== null ? linha[i] : '';
                    td.textContent = valor;
                    tr.appendChild(td);
                }
                fragmentBody.appendChild(tr);
            });
            tbody.appendChild(fragmentBody);
        }
        function obterFiltrosLiberacaoDoFormulario() {
            return {
                dataInicio: converterDataTextoParaISO(elementos.liberacaoDataInicio?.value || ''),
                dataFim: converterDataTextoParaISO(elementos.liberacaoDataFim?.value || ''),
                paciente: elementos.liberacaoPaciente?.value?.trim() || '',
                prontuario: elementos.liberacaoProntuario?.value?.trim() || ''
            };
        }
        function sanearFiltrosLiberacao(filtros = {}) {
            const padraoLocal = obterDataHoraLocalPadrao().data;
            const paciente = (filtros.paciente || '').toString().trim();
            const prontuario = (filtros.prontuario || '').toString().trim();
            const filtroTextoAtivo = Boolean(paciente || prontuario);
            let dataInicio = converterDataTextoParaISO(filtros.dataInicio || '') || '';
            let dataFim = converterDataTextoParaISO(filtros.dataFim || '') || '';

            if (!filtroTextoAtivo) {
                if (dataInicio && !dataFim) {
                    dataFim = dataInicio;
                }
                if (dataFim && !dataInicio) {
                    dataInicio = dataFim;
                }
                if (!dataInicio && !dataFim) {
                    dataInicio = padraoLocal;
                    dataFim = padraoLocal;
                }
            } else {
                if (dataInicio && !dataFim) {
                    dataFim = dataInicio;
                }
                if (dataFim && !dataInicio) {
                    dataInicio = dataFim;
                }
            }

            return { dataInicio, dataFim, paciente, prontuario };
        }
        function gerarChaveFiltroLiberacao(filtros = {}) {
            return JSON.stringify({
                dataInicio: filtros.dataInicio || '',
                dataFim: filtros.dataFim || '',
                paciente: normalizarTexto(filtros.paciente || ''),
                prontuario: normalizarTexto(filtros.prontuario || '')
            });
        }
        function sincronizarCamposFiltroLiberacao(filtros = {}) {
            if (elementos.liberacaoDataInicio) {
                elementos.liberacaoDataInicio.value = filtros.dataInicio || '';
            }
            if (elementos.liberacaoDataFim) {
                elementos.liberacaoDataFim.value = filtros.dataFim || '';
            }
            if (elementos.liberacaoProntuario) {
                elementos.liberacaoProntuario.value = filtros.prontuario || '';
            }
            if (elementos.liberacaoPaciente) {
                elementos.liberacaoPaciente.value = filtros.paciente || '';
            }
        }
        async function carregarTabelaLiberacao(opcoes = {}) {
            const tabela = elementos.tabelaLiberacao;
            if (!tabela) return;
            const estadoLiberacao = obterEstadoLiberacao();
            const { filtros: filtrosOverride, forcarAtualizacao = false } = opcoes;
            const filtrosFormulario = obterFiltrosLiberacaoDoFormulario();
            const filtrosAtuais = sanearFiltrosLiberacao({
                dataInicio: filtrosOverride?.dataInicio ?? filtrosFormulario.dataInicio ?? estadoLiberacao.filtros?.dataInicio,
                dataFim: filtrosOverride?.dataFim ?? filtrosFormulario.dataFim ?? estadoLiberacao.filtros?.dataFim,
                paciente: filtrosOverride?.paciente ?? filtrosFormulario.paciente ?? estadoLiberacao.filtros?.paciente,
                prontuario: filtrosOverride?.prontuario ?? filtrosFormulario.prontuario ?? estadoLiberacao.filtros?.prontuario
            });
            sincronizarCamposFiltroLiberacao(filtrosAtuais);
            if (!filtrosAtuais.dataInicio || !filtrosAtuais.dataFim) {
                estadoLiberacao.erro = 'Informe um per칤odo v치lido para realizar a busca.';
                estadoLiberacao.linhasCarregadas = false;
                estadoLiberacao.linhas = [];
                mostrarEstadoTabelaLiberacao('Informe um per칤odo v치lido para realizar a busca.', 'error');
                atualizarResumoLiberacao();
                return;
            }
            if (filtrosAtuais.dataInicio > filtrosAtuais.dataFim) {
                estadoLiberacao.erro = 'A data inicial n칚o pode ser posterior  data final.';
                estadoLiberacao.linhasCarregadas = false;
                estadoLiberacao.linhas = [];
                mostrarEstadoTabelaLiberacao('A data inicial n칚o pode ser posterior  data final.', 'error');
                atualizarResumoLiberacao();
                return;
            }
            const chaveFiltroAtual = gerarChaveFiltroLiberacao(filtrosAtuais);
            if (!forcarAtualizacao && estadoLiberacao.linhasCarregadas && estadoLiberacao.chaveFiltrosAplicados === chaveFiltroAtual) {
                estadoLiberacao.filtros = filtrosAtuais;
                atualizarResumoLiberacao();
                renderizarTabelaLiberacao();
                return;
            }
            estadoLiberacao.carregando = true;
            estadoLiberacao.erro = '';
            estadoLiberacao.filtros = filtrosAtuais;
            estadoLiberacao.chaveFiltrosAplicados = chaveFiltroAtual;
            atualizarResumoLiberacao();
            mostrarEstadoTabelaLiberacao('Carregando registros...', 'loading');
            try {
                const resultado = await callGoogleScript('getPlanilhaLiberacao', {
                    dataInicio: filtrosAtuais.dataInicio,
                    dataFim: filtrosAtuais.dataFim,
                    paciente: filtrosAtuais.paciente,
                    prontuario: filtrosAtuais.prontuario
                });
                if (!resultado.success) {
                    throw new Error(resultado.error || 'Falha ao obter dados.');
                }
                estadoLiberacao.colunas = Array.isArray(resultado.columns) ? resultado.columns : [];
                estadoLiberacao.linhas = Array.isArray(resultado.rows) ? resultado.rows : [];
                estadoLiberacao.totalPlanilha = Number(resultado.totalPlanilha) || estadoLiberacao.linhas.length;
                estadoLiberacao.totalFiltrado = Number(resultado.totalFiltrado) || estadoLiberacao.linhas.length;
                estadoLiberacao.ultimaAtualizacao = Date.now();
                estadoLiberacao.linhasCarregadas = true;
                const filtrosRetornados = sanearFiltrosLiberacao({
                    dataInicio: resultado?.filtro?.dataInicio || filtrosAtuais.dataInicio,
                    dataFim: resultado?.filtro?.dataFim || filtrosAtuais.dataFim,
                    paciente: resultado?.filtro?.paciente ?? filtrosAtuais.paciente,
                    prontuario: resultado?.filtro?.prontuario ?? filtrosAtuais.prontuario
                });
                estadoLiberacao.filtros = filtrosRetornados;
                estadoLiberacao.chaveFiltrosAplicados = gerarChaveFiltroLiberacao(filtrosRetornados);
                estadoLiberacao.erro = '';
                sincronizarCamposFiltroLiberacao(filtrosRetornados);
                renderizarTabelaLiberacao();
            } catch (erro) {
                console.error('Erro ao carregar dados de libera칞칚o:', erro);
                estadoLiberacao.erro = 'N칚o foi poss칤vel carregar os registros de libera칞칚o.';
                estadoLiberacao.linhas = [];
                estadoLiberacao.linhasCarregadas = false;
                estadoLiberacao.totalPlanilha = 0;
                estadoLiberacao.totalFiltrado = 0;
                mostrarEstadoTabelaLiberacao('N칚o foi poss칤vel carregar os registros de libera칞칚o.', 'error');
                mostrarErro('N칚o foi poss칤vel carregar os registros de libera칞칚o.');
            } finally {
                estadoLiberacao.carregando = false;
                atualizarResumoLiberacao();
            }
        }
        async function carregarTabelaVisitantes(unidadeFiltro, opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            const tbodyVisitantes = document.querySelector('#tabela-visitantes tbody');
            if (!tbodyVisitantes) return;
            if (recarregarArmarios || !estado.armariosCarregados) {
                await carregarArmarios();
            }
            tbodyVisitantes.innerHTML = '';
            const filtroNormalizado = normalizarTexto(unidadeFiltro);
            const armariosVisitantes = estado.armarios
                .filter(armario => normalizarTexto(armario.tipo) === 'visitante')
                .filter(a => filtroNormalizado === 'todas' || normalizarTexto(a.unidade) === filtroNormalizado)
                .filter(a => usuarioPodeVerUnidade(a.unidade));
            if (!armariosVisitantes.length) {
                tbodyVisitantes.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum arm치rio encontrado.</td></tr>';
                return;
            }
            armariosVisitantes.forEach(armario => {
                const tr = document.createElement('tr');
                if (armario.visitaEstendida) {
                    tr.classList.add('visita-estendida');
                }
                const horaPrevistaColuna = armario.visitaEstendida
                    ? '<span class="visita-estendida-tag"><i class="fas fa-infinity" aria-hidden="true"></i> Visita estendida</span>'
                    : (armario.horaPrevista || '-');
                tr.innerHTML = `
                    <td>${armario.numero}</td>
                    <td>${armario.unidade || '-'}</td>
                    <td><span class="armario-status status-${armario.status}">${formatarStatusArmario(armario.status)}</span></td>
                    <td>${armario.nomeVisitante || '-'}</td>
                    <td>${armario.nomePaciente || '-'}</td>
                    <td>${armario.leito || '-'}</td>
                    <td>${armario.volumes || '-'}</td>
                    <td>${armario.horaInicio || '-'}</td>
                    <td>${horaPrevistaColuna}</td>
                    <td>${armario.whatsapp || '-'}</td>
                    <td>
                        ${armario.status !== 'livre'
                            ? `<button class="btn-small btn-danger" data-action="liberar" data-id="${armario.id}" data-tipo="visitante">Liberar</button>`
                            : `<button class="btn-small btn-primary" data-action="usar" data-id="${armario.id}">Usar</button>`
                        }
                    </td>
                `;
                tbodyVisitantes.appendChild(tr);
            });
        }
        async function carregarTabelaAcompanhantes(unidadeFiltro, opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            const tbodyAcompanhantes = document.querySelector('#tabela-acompanhantes tbody');
            if (!tbodyAcompanhantes) return;
            if (recarregarArmarios || !estado.armariosCarregados) {
                await carregarArmarios();
            }
            tbodyAcompanhantes.innerHTML = '';
            const filtroNormalizado = normalizarTexto(unidadeFiltro);
            const armariosAcompanhantes = estado.armarios
                .filter(armario => normalizarTexto(armario.tipo) === 'acompanhante')
                .filter(a => filtroNormalizado === 'todas' || normalizarTexto(a.unidade) === filtroNormalizado)
                .filter(a => usuarioPodeVerUnidade(a.unidade));
            if (!armariosAcompanhantes.length) {
                tbodyAcompanhantes.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum arm치rio encontrado.</td></tr>';
                return;
            }
            armariosAcompanhantes.forEach(armario => {
                const tr = document.createElement('tr');
                const statusArmarioNormalizado = normalizarTexto(armario.status);
                const statusTermoNormalizado = normalizarTexto(armario.termoStatus);
                const botoesTermo = statusArmarioNormalizado !== 'livre'
                    ? (statusTermoNormalizado === 'pendente'
                        ? `<button class="btn-small btn-primary" data-action="termo" data-id="${armario.id}">Aplicar termo</button>`
                        : '')
                    : '';
                tr.innerHTML = `
                    <td>${armario.numero}</td>
                    <td>${armario.unidade || '-'}</td>
                    <td><span class="armario-status status-${armario.status}">${formatarStatusArmario(armario.status)}</span></td>
                    <td>${armario.nomeVisitante || '-'}</td>
                    <td>${armario.nomePaciente || '-'}</td>
                    <td>${armario.leito || '-'}</td>
                    <td>${armario.volumes || '-'}</td>
                    <td>${armario.horaInicio || '-'}</td>
                    <td>${armario.whatsapp || '-'}</td>
                    <td>
                        ${statusArmarioNormalizado !== 'livre'
                            ? `<button class="btn-small btn-danger" data-action="liberar" data-id="${armario.id}" data-tipo="acompanhante">Liberar</button>
                               <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimenta칞칫es</button>
                               ${botoesTermo}`
                            : `<button class="btn-small btn-primary" data-action="usar" data-id="${armario.id}">Usar</button>`
                        }
                    </td>
                `;
                tbodyAcompanhantes.appendChild(tr);
            });
        }
        function obterArmariosAcompanhantesLivres(filtroTexto = '') {
            const filtroNormalizado = normalizarTexto(filtroTexto);
            return estado.armarios
                .filter(armario => normalizarTexto(armario.tipo) === 'acompanhante')
                .filter(armario => normalizarTexto(armario.status) === 'livre')
                .filter(armario => !armarioEhContingencia(armario))
                .filter(armario => usuarioPodeVerUnidade(armario.unidade))
                .filter(armario => {
                    if (!filtroNormalizado) return true;
                    const numero = normalizarTexto(armario.numero);
                    const unidade = normalizarTexto(armario.unidade);
                    return numero.includes(filtroNormalizado) || unidade.includes(filtroNormalizado);
                })
                .sort((a, b) => a.numero.localeCompare(b.numero, 'pt-BR', { numeric: true }));
        }
        function obterRascunhoOcupacaoArmario(idArmario) {
            restaurarRascunhosOcupacaoLocal();
            const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
            if (!estadoOcupacao.rascunhos) {
                estadoOcupacao.rascunhos = {};
            }
            if (!estadoOcupacao.rascunhos[idArmario]) {
                estadoOcupacao.rascunhos[idArmario] = {
                    paciente: '',
                    prontuario: '',
                    acompanhante: ''
                };
            }
            return estadoOcupacao.rascunhos[idArmario];
        }
        function atualizarRascunhoOcupacao(idArmario, campo, valor) {
            if (!idArmario || !campo) return;
            const rascunho = obterRascunhoOcupacaoArmario(idArmario);
            rascunho[campo] = valor;
            persistirRascunhosOcupacaoLocal();
            if (estado.paginaAtual === 'dashboard') {
                renderizarArmarios();
            }
        }
        function limparRascunhoOcupacao(idArmario) {
            const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
            if (estadoOcupacao.rascunhos && estadoOcupacao.rascunhos[idArmario]) {
                delete estadoOcupacao.rascunhos[idArmario];
                persistirRascunhosOcupacaoLocal();
                if (estado.paginaAtual === 'dashboard') {
                    renderizarArmarios();
                }
            }
        }
        function coletarDadosRascunho(idArmario) {
            const rascunho = obterRascunhoOcupacaoArmario(idArmario);
            return {
                paciente: (rascunho.paciente || '').trim(),
                prontuario: (rascunho.prontuario || '').trim(),
                acompanhante: (rascunho.acompanhante || '').trim()
            };
        }
        function atualizarSelectOcupacaoAcompanhantes(armariosLivres) {
            if (!elementos.ocupacaoArmario) return;
            const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
            const selecaoAtual = elementos.ocupacaoArmario.value || estadoOcupacao.armarioSelecionado;
            elementos.ocupacaoArmario.innerHTML = '';
            const optionPadrao = document.createElement('option');
            optionPadrao.value = '';
            optionPadrao.textContent = armariosLivres.length ? 'Selecione um arm치rio livre' : 'Nenhum arm치rio livre dispon칤vel';
            elementos.ocupacaoArmario.appendChild(optionPadrao);
            armariosLivres.forEach(armario => {
                const option = document.createElement('option');
                option.value = armario.id;
                const unidadeTexto = armario.unidade ? ` - ${armario.unidade}` : '';
                option.textContent = `${armario.numero}${unidadeTexto}`;
                elementos.ocupacaoArmario.appendChild(option);
            });
            if (selecaoAtual && armariosLivres.some(item => item.id === selecaoAtual)) {
                elementos.ocupacaoArmario.value = selecaoAtual;
            } else {
                elementos.ocupacaoArmario.value = '';
                estadoOcupacao.armarioSelecionado = '';
            }
        }
        function renderizarTabelaOcupacaoAcompanhantes(armariosLivres) {
            const tbody = elementos.tabelaOcupacaoAcompanhantesBody;
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!perfilAtualEhAdmin()) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:12px; color:#c0392b;">Apenas administradores podem utilizar este painel.</td></tr>';
                return;
            }
            if (!armariosLivres.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum arm치rio livre para acompanhantes no momento.</td></tr>';
                return;
            }
            const linhas = armariosLivres.map(armario => {
                const rascunho = obterRascunhoOcupacaoArmario(armario.id);
                return `
                    <tr>
                        <td>${armario.numero}</td>
                        <td>${armario.unidade || '-'}</td>
                        <td>
                            <input class="ocupacao-inline-input" type="text" value="${rascunho.paciente || ''}" placeholder="Paciente" data-ocupacao-id="${armario.id}" data-ocupacao-campo="paciente">
                        </td>
                        <td>
                            <input class="ocupacao-inline-input" type="text" value="${rascunho.prontuario || ''}" placeholder="Prontu치rio" data-ocupacao-id="${armario.id}" data-ocupacao-campo="prontuario">
                        </td>
                        <td>
                            <input class="ocupacao-inline-input" type="text" value="${rascunho.acompanhante || ''}" placeholder="Acompanhante" data-ocupacao-id="${armario.id}" data-ocupacao-campo="acompanhante">
                        </td>
                        <td>
                            <div class="ocupacao-inline-actions">
                                <button class="btn-small btn-secondary" type="button" data-action="selecionar-ocupacao" data-id="${armario.id}"><i class="fas fa-arrow-right"></i> Selecionar</button>
                                <button class="btn-small btn-primary" type="button" data-action="salvar-ocupacao" data-id="${armario.id}"><i class="fas fa-save"></i> Salvar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = linhas.join('');
        }
        async function carregarOcupacaoAcompanhantes(opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            if (!elementos.tabelaOcupacaoAcompanhantesBody) return;
            if (recarregarArmarios || !estado.armariosCarregados) {
                await carregarArmarios();
            }
            restaurarRascunhosOcupacaoLocal();
            const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
            if (elementos.ocupacaoFiltro && elementos.ocupacaoFiltro.value !== estadoOcupacao.filtro) {
                elementos.ocupacaoFiltro.value = estadoOcupacao.filtro || '';
            }
            const armariosLivres = obterArmariosAcompanhantesLivres(estadoOcupacao.filtro);
            const idsLivres = new Set(armariosLivres.map(item => item.id));
            if (estadoOcupacao.rascunhos) {
                Object.keys(estadoOcupacao.rascunhos).forEach(id => {
                    if (!idsLivres.has(id)) {
                        delete estadoOcupacao.rascunhos[id];
                    }
                });
                persistirRascunhosOcupacaoLocal();
            }
            atualizarSelectOcupacaoAcompanhantes(armariosLivres);
            renderizarTabelaOcupacaoAcompanhantes(armariosLivres);
        }
        function selecionarArmarioParaOcupacao(idArmario) {
            if (!elementos.ocupacaoArmario) return;
            const armario = estado.armarios.find(item => item.id === idArmario);
            if (!armario) return;
            elementos.ocupacaoArmario.value = idArmario;
            const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
            estadoOcupacao.armarioSelecionado = idArmario;
            elementos.ocupacaoArmario.focus();
            elementos.ocupacaoArmario.dispatchEvent(new Event('change'));
        }
        async function registrarOcupacaoArmario({ armarioId, dadosCadastro = {}, botao = null, silencioso = false, recarregarApos = true }) {
            if (!perfilAtualEhAdmin()) {
                if (!silencioso) {
                    mostrarErro('Apenas administradores podem registrar ocupa칞칫es r치pidas.');
                }
                return false;
            }
            const finalizar = botao ? iniciarLoadingBotao(botao) : () => {};
            try {
                const armarioSelecionado = (armarioId || '').trim();
                if (!armarioSelecionado) {
                    if (!silencioso) {
                        mostrarErro('Selecione um arm치rio livre para continuar.');
                    }
                    return false;
                }
                const armario = estado.armarios.find(item => item.id === armarioSelecionado);
                if (!armario || normalizarTexto(armario.status) !== 'livre' || normalizarTexto(armario.tipo) !== 'acompanhante') {
                    if (!silencioso) {
                        mostrarErro('Arm치rio selecionado n칚o est치 dispon칤vel.');
                    }
                    await carregarOcupacaoAcompanhantes({ recarregarArmarios: true });
                    return false;
                }
                const dados = {
                    idPlanilha: armario.idPlanilha || armario.id,
                    id: armario.idPlanilha || armario.id,
                    numero: armario.numero,
                    tipo: 'acompanhante',
                    nomeVisitante: (dadosCadastro.acompanhante || '').trim(),
                    nomePaciente: (dadosCadastro.paciente || '').trim(),
                    prontuario: (dadosCadastro.prontuario || '').trim(),
                    observacoes: (dadosCadastro.observacoes || '').trim(),
                    leito: '',
                    volumes: 0,
                    whatsapp: '',
                    horaPrevista: '',
                    usuarioResponsavel: obterDescricaoResponsavelAtual()
                };
                const resultado = await callGoogleScript('cadastrarArmario', dados);
                if (!resultado.success) {
                    if (!silencioso) {
                        notificarErroPadrao(resultado, 'N칚o foi poss칤vel ocupar o arm치rio selecionado.');
                    }
                    return false;
                }
                const agora = new Date();
                const atualizacoesLocais = {
                    status: 'em-uso',
                    nomeVisitante: dados.nomeVisitante,
                    nomePaciente: dados.nomePaciente,
                    prontuario: dados.prontuario,
                    leito: '',
                    volumes: 0,
                    whatsapp: '',
                    horaInicio: agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                    horaPrevista: '',
                    visitaEstendida: false,
                    dataRegistro: agora.toISOString(),
                    termoAplicado: false,
                    termoFinalizado: false,
                    termoStatus: 'pendente'
                };
                atualizarArmarioLocal(armario.id, atualizacoesLocais);
                limparRascunhoOcupacao(armario.id);
                if (recarregarApos) {
                    await carregarOcupacaoAcompanhantes({ recarregarArmarios: true });
                }
                atualizarResumoDashboardLocal();
                atualizarInterface();
                carregarDadosTabelas({ recarregarArmarios: false }).catch(console.error);
                sincronizarDadosArmariosEmSegundoPlano({ recarregarArmariosNasTabelas: true });
                if (!silencioso) {
                    mostrarSucesso('Arm치rio ocupado com sucesso.');
                }
                return true;
            } finally {
                finalizar();
            }
        }
        async function submeterOcupacaoAcompanhantes() {
            const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
            const armarioSelecionado = (elementos.ocupacaoArmario?.value || estadoOcupacao.armarioSelecionado || '').trim();
            const dadosCadastro = {
                paciente: elementos.ocupacaoPaciente?.value?.trim() || '',
                prontuario: elementos.ocupacaoProntuario?.value?.trim() || '',
                acompanhante: elementos.ocupacaoAcompanhante?.value?.trim() || ''
            };
            const sucesso = await registrarOcupacaoArmario({ armarioId: armarioSelecionado, dadosCadastro, botao: elementos.ocupacaoSalvar });
            if (sucesso) {
                estadoOcupacao.armarioSelecionado = '';
                if (elementos.ocupacaoRapidaForm) {
                    elementos.ocupacaoRapidaForm.reset();
                }
            }
        }
        async function salvarOcupacaoIndividual(idArmario, botao) {
            const dadosCadastro = coletarDadosRascunho(idArmario);
            await registrarOcupacaoArmario({ armarioId: idArmario, dadosCadastro, botao });
        }
        async function salvarTodasOcupacoesPreenchidas() {
            const estadoOcupacao = obterEstadoOcupacaoAcompanhantes();
            const rascunhos = estadoOcupacao.rascunhos || {};
            const idsPreenchidos = Object.keys(rascunhos).filter(id => {
                const dados = coletarDadosRascunho(id);
                return dados.paciente || dados.prontuario || dados.acompanhante;
            });
            if (!idsPreenchidos.length) {
                mostrarErro('Preencha os dados em pelo menos um arm치rio livre para salvar em lote.');
                return;
            }
            const finalizar = elementos.ocupacaoSalvarTodos ? iniciarLoadingBotao(elementos.ocupacaoSalvarTodos) : () => {};
            try {
                let algumSucesso = false;
                for (const id of idsPreenchidos) {
                    const botaoLinha = document.querySelector(`[data-action="salvar-ocupacao"][data-id="${id}"]`);
                    const resultado = await registrarOcupacaoArmario({
                        armarioId: id,
                        dadosCadastro: coletarDadosRascunho(id),
                        botao: botaoLinha,
                        silencioso: true,
                        recarregarApos: false
                    });
                    algumSucesso = algumSucesso || resultado;
                }
                await carregarOcupacaoAcompanhantes({ recarregarArmarios: true });
                if (algumSucesso) {
                    mostrarSucesso('Arm치rios preenchidos foram cadastrados.');
                }
            } finally {
                finalizar();
            }
        }
        async function carregarHistoricoVisitantes() {
            const tbody = document.querySelector('#tabela-historico-visitantes tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getHistorico', { tipo: 'visitante' });
            if (!resultado.success) return;
            tbody.innerHTML = '';
            const registros = (resultado.data || []).filter(item => usuarioPodeVerUnidade(item.unidade));
            if (!registros.length) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            registros.forEach(historico => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarData(historico.data)}</td>
                    <td>${historico.armario}</td>
                    <td>${historico.nome}</td>
                    <td>${historico.paciente}</td>
                    <td>${historico.leito}</td>
                    <td>${historico.volumes}</td>
                    <td>${historico.horaInicio}</td>
                    <td>${historico.horaFim}</td>
                    <td>${historico.whatsapp || '-'}</td>
                    <td>${historico.status}</td>
                    <td>${historico.usuario || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function carregarHistoricoAcompanhantes() {
            const tbody = document.querySelector('#tabela-historico-acompanhantes tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getHistorico', { tipo: 'acompanhante' });
            if (!resultado.success) return;
            tbody.innerHTML = '';
            const registros = (resultado.data || []).filter(item => usuarioPodeVerUnidade(item.unidade));
            if (!registros.length) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum registro encontrado.</td></tr>';
                return;
            }
            registros.forEach(historico => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarData(historico.data)}</td>
                    <td>${historico.armario}</td>
                    <td>${historico.nome}</td>
                    <td>${historico.paciente}</td>
                    <td>${historico.leito}</td>
                    <td>${historico.volumes}</td>
                    <td>${historico.horaInicio}</td>
                    <td>${historico.horaFim}</td>
                    <td>${historico.whatsapp || '-'}</td>
                    <td>${historico.status}</td>
                    <td>${historico.usuario || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function carregarTabelaTermos(opcoes = {}) {
            const { recarregarArmarios = true } = opcoes;
            if (!elementos.tabelaTermosBody) return;

            const carregamentoId = ++estado.carregamentoTermosId;
            const tbody = elementos.tabelaTermosBody;
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:16px; color:#5b6b86;">Carregando termos...</td></tr>';

            if (recarregarArmarios || !estado.armariosCarregados) {
                await carregarArmarios();
            }
            if (estado.carregamentoTermosId !== carregamentoId) return;

            if (!estado.armariosCarregados) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:16px; color:#c0392b;">Erro ao carregar termos.</td></tr>';
                return;
            }

            const armariosComTermo = estado.armarios
                .filter(a => normalizarTexto(a.tipo) === 'acompanhante')
                .filter(a => {
                    const statusArmario = normalizarTexto(a.status);
                    const statusTermo = normalizarTexto(a.termoStatus);
                    return statusArmario !== 'livre' || statusTermo === 'finalizado';
                })
                .sort((a, b) => {
                    const peso = (valor) => {
                        if (!valor.termoInfo) return 0;
                        return valor.termoStatus === 'finalizado' ? 2 : 1;
                    };
                    const pesoA = peso(a);
                    const pesoB = peso(b);
                    if (pesoA === pesoB) {
                        return new Date(b.dataRegistro || 0) - new Date(a.dataRegistro || 0);
                    }
                    return pesoA - pesoB;
                });

            if (!armariosComTermo.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:16px; color:#5b6b86;">Nenhum termo ativo ou pendente no momento.</td></tr>';
                return;
            }

            const linhas = [];

            for (const armario of armariosComTermo) {
                const termoInfo = armario.termoInfo || null;
                const statusTermoNormalizado = normalizarTexto(armario.termoStatus);
                const finalizado = statusTermoNormalizado === 'finalizado';
                const emAndamento = statusTermoNormalizado === 'em andamento';
                const movResultado = await callGoogleScript('getMovimentacoes', montarPayloadTermo(armario));
                if (estado.carregamentoTermosId !== carregamentoId) return;

                const numMovimentacoes = movResultado.success ? movResultado.data.length : 0;
                const aplicadoEm = finalizado
                    ? formatarData(termoInfo?.finalizadoEm || termoInfo?.aplicadoEm)
                    : termoInfo?.aplicadoEm ? formatarData(termoInfo.aplicadoEm) : '-';
                const statusClasse = finalizado ? 'aplicado' : emAndamento ? 'andamento' : 'pendente';
                const statusTexto = finalizado ? 'Finalizado' : emAndamento ? 'Em andamento' : 'Pendente';
                const pdfDisponivel = finalizado && termoInfo?.pdfUrl;
                const pdfColuna = pdfDisponivel
                    ? `<a href="#" class="btn-small btn-primary" data-action="ver-pdf" data-id="${armario.id}">Ver PDF</a>`
                    : '<span class="text-muted">Indispon칤vel</span>';
                const botoesAcao = finalizado
                    ? `
                        <button class="btn-small btn-primary" data-action="ver" data-id="${armario.id}">Ver termo</button>
                        <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimenta칞칫es</button>
                    `
                    : emAndamento
                        ? `
                        <button class="btn-small btn-primary" data-action="ver" data-id="${armario.id}">Ver termo</button>
                        <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimenta칞칫es</button>
                        <button class="btn-small btn-danger" data-action="encerrar" data-id="${armario.id}">Encerrar</button>
                    `
                        : `
                        <button class="btn-small btn-primary" data-action="aplicar" data-id="${armario.id}">Aplicar termo</button>
                        <button class="btn-small btn-edit" data-action="mov" data-id="${armario.id}">Movimenta칞칫es</button>
                        <button class="btn-small btn-danger" data-action="encerrar" data-id="${armario.id}">Encerrar</button>
                    `;

                linhas.push(`
                    <tr>
                        <td>${armario.numero}</td>
                        <td>${armario.nomeVisitante || '-'}</td>
                        <td>${armario.nomePaciente || '-'}</td>
                        <td><span class="status-label ${statusClasse}">${statusTexto}</span></td>
                        <td>${aplicadoEm}</td>
                        <td>${numMovimentacoes} registro(s)</td>
                        <td>${pdfColuna}</td>
                        <td>${botoesAcao}</td>
                    </tr>
                `);
            }

            if (estado.carregamentoTermosId !== carregamentoId) return;
            tbody.innerHTML = linhas.join('');
        }

        async function carregarCadastroArmarios(unidadeFiltro) {
            const tbody = document.querySelector('#tabela-cadastro-armarios tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getCadastroArmarios');
            if (!resultado.success) return;
            tbody.innerHTML = '';
            const filtroNormalizado = normalizarTexto(unidadeFiltro);
            estado.cadastroArmarios = resultado.data.map(armario => ({
                ...armario,
                unidade: armario.unidade ? armario.unidade.trim() : ''
            }));
            const armariosFiltrados = estado.cadastroArmarios
                .filter(armario => filtroNormalizado === 'todas' || normalizarTexto(armario.unidade) === filtroNormalizado)
                .filter(armario => usuarioPodeVerUnidade(armario.unidade));
            if (!armariosFiltrados.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum arm치rio cadastrado para esta unidade.</td></tr>';
                return;
            }
            armariosFiltrados.forEach(armario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${armario.id}</td>
                    <td>${armario.numero}</td>
                    <td>${armario.tipo === 'visitante' ? 'Visitante' : 'Acompanhante'}</td>
                    <td>${armario.unidade || '-'}</td>
                    <td>${armario.localizacao || '-'}</td>
                    <td>${armario.status}</td>
                    <td>
                        <button class="btn-small btn-edit">Editar</button>
                        <button class="btn-small btn-danger">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function carregarTabelaUsuarios() {
            const tbody = elementos.tabelaUsuariosBody;
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!perfilAtualEhAdmin()) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:12px; color:#c0392b;">Apenas administradores podem visualizar os usu치rios.</td></tr>';
                return;
            }
            if (!estado.usuarios.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:12px; color:#5b6b86;">Nenhum usu치rio cadastrado.</td></tr>';
                return;
            }
            estado.usuarios.forEach(usuario => {
                const tr = document.createElement('tr');
                const perfilDescricao = usuario.perfil === 'admin' ? 'Administrador' : 'Usu치rio';
                const unidadesDescricao = obterDescricaoUnidades(usuario.unidades);
                const statusDescricao = normalizarTexto(usuario.status) === 'ativo' ? 'Ativo' : 'Inativo';
                tr.innerHTML = `
                    <td>${usuario.id}</td>
                    <td>${usuario.nome}</td>
                    <td>${usuario.email}</td>
                    <td>${perfilDescricao}</td>
                    <td>${usuario.acessoVisitantes ? 'Sim' : 'N칚o'}</td>
                    <td>${usuario.acessoAcompanhantes ? 'Sim' : 'N칚o'}</td>
                    <td>${unidadesDescricao}</td>
                    <td>${statusDescricao}</td>
                    <td>
                        <button class="btn-small btn-edit" data-acao-usuario="editar" data-id="${usuario.id}">Editar</button>
                        <button class="btn-small btn-danger" data-acao-usuario="excluir" data-id="${usuario.id}">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function renderizarOpcoesUnidadesFormulario(selecionadas = []) {
            if (!elementos.usuarioUnidades) return;
            const selecionadasNormalizadas = normalizarListaDeUnidades(selecionadas);
            const incluiTodas = selecionadasNormalizadas.some(valor => normalizarTexto(valor) === 'all');
            const unidadesDisponiveis = estado.unidades.slice();
            if (!unidadesDisponiveis.length) {
                elementos.usuarioUnidades.innerHTML = '<span class="field-hint">Cadastre unidades antes de atribuir acessos.</span>';
                return;
            }
            const partes = [];
            if (perfilAtualEhAdmin()) {
                partes.push(`<label><input type="checkbox" value="all" ${incluiTodas ? 'checked' : ''}> Todas as unidades</label>`);
            }
            unidadesDisponiveis.forEach(unidade => {
                const id = String(unidade.id);
                const checked = !incluiTodas && selecionadasNormalizadas.includes(id) ? 'checked' : '';
                const disabled = incluiTodas ? 'disabled' : '';
                partes.push(`<label><input type="checkbox" value="${id}" ${checked} ${disabled}> ${unidade.nome}</label>`);
            });
            elementos.usuarioUnidades.innerHTML = partes.join('');
        }
        function obterUnidadesSelecionadasFormulario() {
            if (!elementos.usuarioUnidades) return [];
            const selecionados = Array.from(elementos.usuarioUnidades.querySelectorAll('input[type="checkbox"]:checked'))
                .map(input => input.value);
            if (selecionados.includes('all')) {
                return ['all'];
            }
            return selecionados;
        }
        function tratarAlteracaoUnidadeUsuario(evento) {
            const input = evento.target;
            if (!input || input.type !== 'checkbox') return;
            if (input.value === 'all') {
                const marcarTodas = input.checked;
                elementos.usuarioUnidades.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.value !== 'all') {
                        checkbox.checked = false;
                        checkbox.disabled = marcarTodas;
                    }
                });
            } else {
                const todas = elementos.usuarioUnidades.querySelector('input[type="checkbox"][value="all"]');
                if (todas && todas.checked) {
                    todas.checked = false;
                    elementos.usuarioUnidades.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        }
        function tratarAcaoUsuario(evento) {
            const botao = evento.target.closest('[data-acao-usuario]');
            if (!botao) return;
            const id = parseInt(botao.dataset.id, 10);
            if (Number.isNaN(id)) return;
            const acao = botao.dataset.acaoUsuario;
            if (acao === 'editar') {
                abrirModalEditarUsuario(id);
            } else if (acao === 'excluir') {
                confirmarExclusaoUsuario(id, botao);
            }
        }
        function abrirModalEditarUsuario(id) {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem editar usu치rios.');
                return;
            }
            const usuario = estado.usuarios.find(u => Number(u.id) === Number(id));
            if (!usuario) {
                mostrarErro('Usu치rio n칚o encontrado.');
                return;
            }
            elementos.usuarioForm.reset();
            elementos.usuarioForm.dataset.id = String(id);
            if (elementos.usuarioModalTitle) {
                elementos.usuarioModalTitle.textContent = 'Editar Usu치rio';
            }
            document.getElementById('usuario-nome').value = usuario.nome || '';
            document.getElementById('usuario-email').value = usuario.email || '';
            if (elementos.usuarioSenha) {
                elementos.usuarioSenha.value = usuario.senha || '';
            }
            if (elementos.usuarioStatus) {
                elementos.usuarioStatus.value = usuario.status || 'ativo';
            }
            document.getElementById('usuario-perfil').value = usuario.perfil || 'usuario';
            document.getElementById('acesso-visitantes').checked = Boolean(usuario.acessoVisitantes);
            document.getElementById('acesso-acompanhantes').checked = Boolean(usuario.acessoAcompanhantes);
            renderizarOpcoesUnidadesFormulario(usuario.unidades);
            if (elementos.usuarioModal.style.display !== 'flex') {
                travaRolagem.aplicar();
            }
            elementos.usuarioModal.style.display = 'flex';
        }
        async function confirmarExclusaoUsuario(id, botao) {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem excluir usu치rios.');
                return;
            }
            const usuario = estado.usuarios.find(u => Number(u.id) === Number(id));
            if (!usuario) {
                mostrarErro('Usu치rio n칚o encontrado.');
                return;
            }
            const resultado = await Swal.fire({
                title: 'Excluir usu치rio',
                text: `Deseja remover ${usuario.nome}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, excluir',
                cancelButtonText: 'Cancelar'
            });
            if (!resultado.isConfirmed) {
                return;
            }
            const finalizar = botao ? iniciarLoadingBotao(botao) : () => {};
            try {
                const resposta = await callGoogleScript('excluirUsuario', { id });
                if (resposta.success) {
                    await carregarUsuarios();
                    carregarTabelaUsuarios();
                    mostrarSucesso('Usu치rio exclu칤do com sucesso');
                } else {
                    notificarErroPadrao(resposta);
                }
            } finally {
                finalizar();
            }
        }
        async function carregarTabelaLogs() {
            const tbody = document.querySelector('#tabela-logs tbody');
            if (!tbody) return;
            const resultado = await callGoogleScript('getLogs');
            if (!resultado.success) return;
            tbody.innerHTML = '';
            resultado.data.forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarDataHora(log.dataHora)}</td>
                    <td>${log.usuario}</td>
                    <td>${log.acao}</td>
                    <td>${log.detalhes}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        function atualizarSeletoresUnidade() {
            if (!elementos.unitSelect) return;
            const valorAtual = (estado.unidadeAtual || 'todas').toString().trim();
            const valorAtualNormalizado = normalizarTexto(valorAtual);
            const unidadesDisponiveis = obterUnidadesPermitidas();
            const deveIncluirOpcaoTodas = perfilAtualEhAdmin() || obterIdsPermitidos() === null;
            const opcoes = unidadesDisponiveis.map(unidade => {
                const nomeLimpo = (unidade.nome || '').trim();
                const desativada = unidade.status !== 'ativa';
                const label = desativada ? `${nomeLimpo} (inativa)` : nomeLimpo;
                const descricao = desativada ? 'Unidade temporariamente indispon칤vel' : 'Filtrar por este setor';
                return `<option value="${nomeLimpo}" ${desativada ? 'disabled' : ''} data-icon="fas fa-location-dot" data-description="${descricao}">${label}</option>`;
            }).join('');
            const opcaoTodas = `<option value="todas" data-icon="fas fa-layer-group" data-description="Visualiza칞칚o geral por setor">Todas as unidades</option>`;
            elementos.unitSelect.innerHTML = `${deveIncluirOpcaoTodas ? opcaoTodas : ''}${opcoes}`;
            const opcaoCorrespondente = Array.from(elementos.unitSelect.options)
                .find(option => normalizarTexto(option.value) === valorAtualNormalizado);
            if (opcaoCorrespondente) {
                elementos.unitSelect.value = opcaoCorrespondente.value;
                estado.unidadeAtual = opcaoCorrespondente.value;
            } else {
                if (!deveIncluirOpcaoTodas && unidadesDisponiveis.length) {
                    const primeiraUnidade = (unidadesDisponiveis[0].nome || '').trim();
                    elementos.unitSelect.value = primeiraUnidade;
                    estado.unidadeAtual = primeiraUnidade;
                } else {
                    elementos.unitSelect.value = 'todas';
                    estado.unidadeAtual = 'todas';
                }
            }
            atualizarSelectorPersonalizado(elementos.unitSelect);
        }
        function renderizarTabelaUnidades() {
            if (!elementos.tabelaUnidadesBody) return;
            elementos.tabelaUnidadesBody.innerHTML = '';
            estado.unidades.forEach(unidade => {
                const nomeLimpo = (unidade.nome || '').trim();
                const totalArmarios = (estado.cadastroArmarios || [])
                    .filter(armario => normalizarTexto(armario.unidade) === normalizarTexto(nomeLimpo)).length;
                const statusClasse = unidade.status === 'ativa' ? 'status-livre' : 'status-vencido';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${unidade.id}</td>
                    <td>${nomeLimpo}</td>
                    <td><span class="armario-status ${statusClasse}">${unidade.status === 'ativa' ? 'Ativa' : 'Inativa'}</span></td>
                    <td>${totalArmarios}</td>
                    <td>
                        <button class="btn-small btn-primary" data-acao-unidade="filtrar" data-unidade="${nomeLimpo}">Ver arm치rios</button>
                        <button class="btn-small ${unidade.status === 'ativa' ? 'btn-edit' : 'btn-secondary'}" data-acao-unidade="alternar" data-unidade="${nomeLimpo}">${unidade.status === 'ativa' ? 'Desativar' : 'Ativar'}</button>
                    </td>
                `;
                elementos.tabelaUnidadesBody.appendChild(tr);
            });
        }
        function tratarAcaoUnidade(evento) {
            const botao = evento.target.closest('button[data-acao-unidade]');
            if (!botao) return;
            const unidade = botao.dataset.unidade;
            const acao = botao.dataset.acaoUnidade;
            if (acao === 'filtrar') {
                selecionarUnidade(unidade);
                navegarParaPagina('cadastro-armarios');
            } else if (acao === 'alternar') {
                alternarStatusUnidade(unidade);
            }
        }
        function selecionarUnidade(unidade) {
            const valorLimpo = (unidade || '').toString().trim();
            const alvoNormalizado = normalizarTexto(valorLimpo) || 'todas';
            estado.unidadeAtual = valorLimpo || 'todas';
            if (elementos.unitSelect) {
                const opcaoCorrespondente = Array.from(elementos.unitSelect.options)
                    .find(option => normalizarTexto(option.value) === alvoNormalizado);
                if (opcaoCorrespondente) {
                    elementos.unitSelect.value = opcaoCorrespondente.value;
                    estado.unidadeAtual = opcaoCorrespondente.value;
                } else {
                    elementos.unitSelect.value = 'todas';
                    estado.unidadeAtual = 'todas';
                }
                atualizarSelectorPersonalizado(elementos.unitSelect);
            }
            atualizarInterface();
            carregarDadosTabelas();
        }
        async function alternarStatusUnidade(nome) {
            const alvoNormalizado = normalizarTexto(nome);
            const unidade = estado.unidades.find(u => normalizarTexto(u.nome) === alvoNormalizado);
            if (!unidade) return;
            const resultado = await callGoogleScript('alternarStatusUnidade', { nome: unidade.nome });
            if (resultado.success) {
                unidade.status = unidade.status === 'ativa' ? 'inativa' : 'ativa';
                const nomeExibicao = unidade.nome;
                if (unidade.status === 'inativa' && normalizarTexto(estado.unidadeAtual) === normalizarTexto(nomeExibicao)) {
                    estado.unidadeAtual = 'todas';
                }
                atualizarSeletoresUnidade();
                renderizarTabelaUnidades();
                carregarDadosTabelas();
                atualizarInterface();
                await Swal.fire({
                    title: 'Unidade atualizada',
                    text: `A unidade ${nomeExibicao} agora est치 ${unidade.status === 'ativa' ? 'ativa' : 'inativa'}.`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                notificarErroPadrao(resultado);
            }
        }
        async function abrirModalNovaUnidade() {
            const { value: nomeUnidade, isConfirmed } = await Swal.fire({
                title: 'Nova Unidade',
                input: 'text',
                inputLabel: 'Nome da unidade',
                inputPlaceholder: 'Ex.: NAC Eletiva',
                showCancelButton: true,
                confirmButtonText: 'Salvar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || !value.trim()) {
                        return 'Informe o nome da unidade';
                    }
                    return null;
                }
            });
            if (!isConfirmed || !nomeUnidade || !nomeUnidade.trim()) {
                return;
            }
            const nome = nomeUnidade.trim();
            const resultado = await callGoogleScript('cadastrarUnidade', { nome });
            if (resultado.success) {
                estado.unidades.push({
                    id: resultado.id,
                    nome,
                    status: 'ativa',
                    dataCadastro: new Date()
                });
                atualizarSeletoresUnidade();
                renderizarTabelaUnidades();
                await Swal.fire({
                    title: 'Sucesso!',
                    text: 'Unidade cadastrada com sucesso',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                notificarErroPadrao(resultado);
            }
        }
        // Abrir modal para cadastro/edi칞칚o de arm치rio
        async function abrirCadastroContingencia() {
            if (!perfilAtualEhAcompanhante()) {
                mostrarErro('A칞칚o dispon칤vel apenas no perfil de acompanhantes.');
                return;
            }

                const resultado = await Swal.fire({
                    title: 'Registrar conting칡ncia',
                    html: `
                        <div class="swal-form-grid">
                        <div class="swal-form-group">
                            <label for="contingencia-paciente">Paciente</label>
                            <input id="contingencia-paciente" class="swal2-input" placeholder="Nome do paciente" required>
                        </div>
                        <div class="swal-form-group">
                            <label for="contingencia-acompanhante">Acompanhante</label>
                            <input id="contingencia-acompanhante" class="swal2-input" placeholder="Nome do acompanhante" required>
                        </div>
                        <div class="swal-form-group">
                            <label for="contingencia-prontuario">Prontu치rio</label>
                            <input id="contingencia-prontuario" class="swal2-input" placeholder="Prontu치rio" aria-required="true">
                        </div>
                        <div class="swal-form-group">
                            <label for="contingencia-observacoes">Observa칞칫es</label>
                            <textarea id="contingencia-observacoes" class="swal2-textarea" placeholder="Observa칞칫es da conting칡ncia"></textarea>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Registrar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const popup = Swal.getPopup();
                    const acompanhante = popup.querySelector('#contingencia-acompanhante').value.trim();
                    const paciente = popup.querySelector('#contingencia-paciente').value.trim();
                    const prontuario = popup.querySelector('#contingencia-prontuario').value.trim();
                    const observacoes = popup.querySelector('#contingencia-observacoes').value.trim();
                    if (!acompanhante || !paciente) {
                        Swal.showValidationMessage('Informe acompanhante e paciente.');
                        return false;
                    }
                    return { acompanhante, paciente, prontuario, observacoes };
                }
            });

            if (!resultado.isConfirmed || !resultado.value) {
                return;
            }

            const payload = {
                nomeAcompanhante: resultado.value.acompanhante,
                nomePaciente: resultado.value.paciente,
                prontuario: resultado.value.prontuario,
                observacoes: resultado.value.observacoes,
                unidade: estado.unidadeAtual === 'todas' ? '' : estado.unidadeAtual,
                usuarioResponsavel: obterDescricaoResponsavelAtual()
            };

            const finalizar = mostrarOverlayCarregamento('Registrando conting칡ncia...');
            try {
                const resposta = await callGoogleScript('registrarContingencia', payload);
                if (!resposta.success) {
                    notificarErroPadrao(resposta, 'N칚o foi poss칤vel registrar conting칡ncia.');
                    return;
                }

                const novoArmario = resposta.data || {};
                const armarioNormalizado = {
                    ...novoArmario,
                    id: normalizarIdentificador(novoArmario.id),
                    idPlanilha: novoArmario.idPlanilha !== undefined && novoArmario.idPlanilha !== null
                        ? novoArmario.idPlanilha.toString().trim()
                        : '',
                    numero: normalizarIdentificador(novoArmario.numero),
                    unidade: novoArmario.unidade ? novoArmario.unidade.toString().trim() : '',
                    prontuario: novoArmario.prontuario ? novoArmario.prontuario.toString().trim() : '',
                    observacoes: novoArmario.observacoes ? novoArmario.observacoes.toString().trim() : '',
                    visitaEstendida: Boolean(novoArmario.visitaEstendida),
                    ehContingencia: true,
                    status: 'contingencia'
                };
                estado.armarios.push(armarioNormalizado);
                estado.armariosCarregados = true;
                atualizarResumoDashboardLocal();
                atualizarInterface();
                carregarDadosTabelas({ recarregarArmarios: false }).catch(console.error);
                sincronizarDadosArmariosEmSegundoPlano({ recarregarArmarios: true });
                mostrarSucesso('Conting칡ncia registrada com sucesso.');
            } finally {
                finalizar();
            }
        }
        function abrirModalArmario(armario) {
            if (armario.status === 'livre') {
                if (normalizarTexto(armario.tipo) === 'acompanhante') {
                    limparRascunhoArmario();
                    abrirTermoWizard(armario.id);
                    return;
                }
                elementos.modalTitle.textContent = `Cadastrar Arm치rio ${armario.numero}`;
                elementos.armarioForm.reset();
                elementos.nomeVisitanteLabel.textContent =
                    armario.tipo === 'visitante' ? 'Nome do Visitante' : 'Nome do Acompanhante';
                document.getElementById('nome-visitante').placeholder =
                    armario.tipo === 'visitante' ? 'Nome do visitante' : 'Nome do acompanhante';
                const exigeHoraPrevista = armario.tipo === 'visitante';
                if (elementos.horaPrevistaGroup) {
                    elementos.horaPrevistaGroup.style.display = exigeHoraPrevista ? 'block' : 'none';
                }
                if (elementos.visitaEstendidaGroup) {
                    elementos.visitaEstendidaGroup.style.display = exigeHoraPrevista ? 'block' : 'none';
                }
                const horaPrevistaInput = elementos.horaPrevistaInput;
                const visitaEstendidaInput = elementos.visitaEstendidaInput;
                if (horaPrevistaInput) {
                    horaPrevistaInput.required = exigeHoraPrevista;
                    horaPrevistaInput.disabled = !exigeHoraPrevista;
                    horaPrevistaInput.readOnly = false;
                    if (exigeHoraPrevista) {
                        const horarioSugerido = calcularHoraPrevistaSaida();
                        horaPrevistaInput.value = horarioSugerido;
                        if (elementos.armarioForm) {
                            delete elementos.armarioForm.dataset.horaPrevistaAnterior;
                        }
                        if (visitaEstendidaInput) {
                            visitaEstendidaInput.checked = false;
                        }
                        atualizarInterfaceVisitaEstendida({ manterHorarioManual: true });
                    } else {
                        horaPrevistaInput.value = '';
                        if (elementos.armarioForm) {
                            delete elementos.armarioForm.dataset.visitaEstendida;
                            delete elementos.armarioForm.dataset.horaPrevistaAnterior;
                        }
                        if (visitaEstendidaInput) {
                            visitaEstendidaInput.checked = false;
                        }
                    }
                }
                const whatsappInput = document.getElementById('whatsapp-contato');
                if (whatsappInput) {
                    whatsappInput.placeholder = armario.tipo === 'visitante'
                        ? 'WhatsApp do visitante'
                        : 'WhatsApp do acompanhante';
                }
                elementos.armarioForm.dataset.modo = 'cadastro';
                elementos.armarioForm.dataset.id = armario.idPlanilha || '';
                elementos.armarioForm.dataset.idPlanilha = armario.idPlanilha || '';
                elementos.armarioForm.dataset.armarioId = armario.id;
                elementos.armarioForm.dataset.tipo = armario.tipo;
                elementos.armarioForm.dataset.numero = armario.numero;
                restaurarRascunhoArmario();
                if (elementos.armarioModal.style.display !== 'flex') {
                    travaRolagem.aplicar();
                }
                elementos.armarioModal.style.display = 'flex';
            } else {
                const ehContingencia = armarioEhContingencia(armario);
                const termoStatusNormalizado = normalizarTexto(armario.termoStatus);
                const termoStatusTexto = formatarStatusTermo(armario.termoStatus);
                const termoPendente = termoStatusNormalizado === 'pendente';
                const termoEmAndamento = termoStatusNormalizado === 'em andamento';
                const termoAviso = armario.tipo === 'acompanhante'
                    ? (termoEmAndamento
                        ? '<br><small>Finalize o termo durante a libera칞칚o do arm치rio.</small>'
                        : termoPendente
                            ? '<br><small>Preencha o termo para ocupar este arm치rio.</small>'
                            : '')
                    : '';
                const termoHtml = armario.tipo === 'acompanhante'
                    ? `<div class="info-box" style="margin-top:12px;">Termo de responsabilidade: <strong>${termoStatusTexto}</strong>${termoAviso}</div>`
                    : '';
                const dataRegistroFormatada = formatarDataComDiaSemana(armario.dataRegistro);
                const dataRegistroHtml = `<p><strong>Data:</strong> ${dataRegistroFormatada}</p>`;
                const botoesEdicao = armario.tipo === 'visitante'
                    ? `<div class="swal-extra-actions"><button id="btn-editar-horario" class="swal2-confirm swal2-styled swal2-secondary-action" type="button" style="background-color:#2c6e8f;">Editar hor치rio/visita</button></div>`
                    : '';
                const moverContingenciaHtml = ehContingencia
                    ? `<div class="swal-extra-actions" style="margin-top:8px;"><button id="btn-mover-contingencia" class="swal2-confirm swal2-styled swal2-secondary-action" type="button" style="background-color:#0f766e;">Mover para arm치rio livre</button></div>`
                    : '';
                Swal.fire({
                    title: `Arm치rio ${armario.numero}`,
                    html: `
                        <p><strong>Status:</strong> ${formatarStatusArmario(armario.status)}</p>
                        <p class="armario-unidade">
                            <span class="label">Unidade</span>
                            <span class="value">${armario.unidade || '-'}</span>
                        </p>
                        <p><strong>${armario.tipo === 'acompanhante' ? 'Acompanhante' : 'Visitante'}:</strong> ${armario.nomeVisitante}</p>
                        <p><strong>Paciente:</strong> ${armario.nomePaciente}</p>
                        <p><strong>Prontu치rio:</strong> ${armario.prontuario || '-'}</p>
                        <p><strong>Leito:</strong> ${armario.leito}</p>
                        <p><strong>Volumes:</strong> ${armario.volumes}</p>
                        ${armario.whatsapp ? `<p><strong>WhatsApp:</strong> ${armario.whatsapp}</p>` : ''}
                        <p><strong>In칤cio:</strong> ${armario.horaInicio}</p>
                        ${armario.visitaEstendida
                            ? '<p><strong>Visita:</strong> Estendida</p>'
                            : (armario.horaPrevista ? `<p><strong>Previs칚o de sa칤da:</strong> ${armario.horaPrevista}</p>` : '')}
                        ${dataRegistroHtml}
                        ${termoHtml}
                        ${botoesEdicao}
                        ${moverContingenciaHtml}
                        ${armario.tipo === 'acompanhante' && termoPendente ? `<div style="margin-top:16px;"><button id="btn-aplicar-termo" class="swal2-confirm swal2-styled" style="background-color:#2c6e8f;">Aplicar termo agora</button></div>` : ''}
                    `,
                    icon: 'info',
                    showCancelButton: true,
                    showDenyButton: armario.tipo === 'acompanhante',
                    confirmButtonText: 'Liberar Arm치rio',
                    denyButtonText: 'Movimenta칞칫es',
                    cancelButtonText: 'Fechar',
                    confirmButtonColor: '#28a745',
                    reverseButtons: true,
                    didOpen: () => {
                        const confirmButton = Swal.getConfirmButton();
                        if (confirmButton) {
                            const aplicarLoadingConfirmacao = () => {
                                confirmButton.classList.add('swal-button-loading');
                                confirmButton.innerHTML = `
                                    <span class="swal-button-spinner" aria-hidden="true"></span>
                                    <span class="swal-button-text">Preparando libera칞칚o...</span>
                                `;
                            };
                            confirmButton.addEventListener('click', aplicarLoadingConfirmacao, { once: true });
                        }
                        if (ehContingencia) {
                            const moverContingenciaButton = Swal.getHtmlContainer().querySelector('#btn-mover-contingencia');
                            if (moverContingenciaButton) {
                                moverContingenciaButton.addEventListener('click', event => {
                                    event.preventDefault();
                                    moverContingenciaParaArmarioLivre(armario);
                                });
                            }
                        }
                        if (armario.tipo === 'visitante') {
                            const botaoEditar = Swal.getHtmlContainer().querySelector('#btn-editar-horario');
                            if (botaoEditar) {
                                botaoEditar.addEventListener('click', async event => {
                                    event.preventDefault();
                                    const finalizar = iniciarLoadingBotao(botaoEditar);
                                    try {
                                        Swal.close();
                                        await abrirEdicaoHorarioArmario(armario.id);
                                    } finally {
                                        finalizar();
                                    }
                                });
                            }
                        }
                        if (armario.tipo === 'acompanhante' && (termoPendente || termoEmAndamento)) {
                            const btn = Swal.getHtmlContainer().querySelector('#btn-aplicar-termo');
                            if (btn) {
                                btn.addEventListener('click', async () => {
                                    const finalizar = iniciarLoadingBotao(btn);
                                    try {
                                        Swal.close();
                                        await abrirTermoWizard(armario.id);
                                    } finally {
                                        finalizar();
                                    }
                                });
                            }
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (normalizarTexto(armario.tipo) === 'visitante') {
                            confirmarLiberacaoVisitante(armario.id);
                        } else {
                            confirmarLiberacaoAcompanhante(armario.id);
                        }
                    } else if (result.isDenied) {
                        abrirMovimentacoes(armario.id);
                    }
                });
            }
        }
        async function moverContingenciaParaArmarioLivre(armarioContingencia) {
            if (!armarioContingencia || !armarioEhContingencia(armarioContingencia)) {
                return;
            }
            const livres = obterArmariosAcompanhantesLivres();
            if (!livres.length) {
                await Swal.fire({
                    title: 'Nenhum arm치rio livre',
                    text: 'Cadastre ou libere um arm치rio para transferir esta conting칡ncia.',
                    icon: 'warning'
                });
                return;
            }

            const optionsHtml = livres.map(item => {
                const unidadeTexto = item.unidade ? ` - ${item.unidade}` : '';
                return `<option value="${item.id}">${item.numero}${unidadeTexto}</option>`;
            }).join('');

            const resultado = await Swal.fire({
                title: 'Mover para arm치rio livre',
                html: `
                    <div class="swal-form-group">
                        <label for="destino-contingencia">Selecione o arm치rio livre</label>
                        <select id="destino-contingencia" class="swal2-select" style="width:100%;">
                            ${optionsHtml}
                        </select>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Mover',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const select = Swal.getPopup().querySelector('#destino-contingencia');
                    const valor = select ? select.value : '';
                    if (!valor) {
                        Swal.showValidationMessage('Selecione um arm치rio de destino.');
                        return false;
                    }
                    return valor;
                }
            });

            if (!resultado.isConfirmed || !resultado.value) {
                return;
            }

            const destinoId = resultado.value;
            const dadosCadastro = {
                paciente: armarioContingencia.nomePaciente || '',
                prontuario: armarioContingencia.prontuario || '',
                acompanhante: armarioContingencia.nomeVisitante || '',
                observacoes: armarioContingencia.observacoes || ''
            };

            const finalizar = mostrarOverlayCarregamento('Movendo conting칡ncia...');
            try {
                const ocupacao = await registrarOcupacaoArmario({
                    armarioId: destinoId,
                    dadosCadastro,
                    silencioso: true,
                    recarregarApos: false
                });

                if (!ocupacao) {
                    return;
                }

                const liberacao = await callGoogleScript('liberarArmario', {
                    id: armarioContingencia.idPlanilha || armarioContingencia.id,
                    tipo: 'acompanhante',
                    numero: armarioContingencia.numero,
                    usuarioResponsavel: obterDescricaoResponsavelAtual()
                });

                if (!liberacao.success) {
                    notificarErroPadrao(liberacao, 'N칚o foi poss칤vel atualizar o status da conting칡ncia.');
                }

                await carregarArmarios({ forcarAtualizacao: true });
                atualizarResumoDashboardLocal();
                atualizarInterface();
                carregarDadosTabelas({ recarregarArmarios: false }).catch(console.error);
                sincronizarDadosArmariosEmSegundoPlano({ recarregarArmarios: true });
                mostrarSucesso('Conting칡ncia movida para arm치rio livre.');
            } finally {
                finalizar();
            }
        }
        // Abrir edi칞칚o de hor치rio/visita para arm치rio em uso
        async function abrirEdicaoHorarioArmario(idArmario) {
            const armario = obterArmarioPorId(idArmario);
            if (!armario) {
                mostrarErro('Arm치rio n칚o encontrado. Atualize a lista e tente novamente.');
                return;
            }

            if (normalizarTexto(armario.tipo) !== 'visitante') {
                mostrarErro('Apenas arm치rios de visitantes possuem hor치rio previsto.');
                return;
            }

            const visitaEstendidaAtual = Boolean(armario.visitaEstendida);
            const horaAtual = armario.horaPrevista || '';

            const resultado = await Swal.fire({
                title: `Editar hor치rio - Arm치rio ${armario.numero}`,
                html: `
                    <div class="swal-form-grid">
                        <div class="swal-form-group">
                            <label for="editar-hora-prevista">Previs칚o de sa칤da</label>
                            <input type="time" id="editar-hora-prevista" class="swal2-input" value="${horaAtual}" ${visitaEstendidaAtual ? 'disabled' : ''}>
                        </div>
                        <div class="swal-form-group">
                            <label class="swal2-checkbox" style="margin-top:12px;">
                                <input type="checkbox" id="editar-visita-estendida" ${visitaEstendidaAtual ? 'checked' : ''}>
                                <span style="margin-left:8px;">Visita estendida (sem hor치rio previsto)</span>
                            </label>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Salvar altera칞칫es',
                cancelButtonText: 'Cancelar',
                didOpen: () => {
                    const checkbox = Swal.getPopup().querySelector('#editar-visita-estendida');
                    const inputHora = Swal.getPopup().querySelector('#editar-hora-prevista');
                    if (checkbox && inputHora) {
                        checkbox.addEventListener('change', () => {
                            const estendida = checkbox.checked;
                            inputHora.disabled = estendida;
                            if (estendida) {
                                inputHora.value = '';
                            } else if (!inputHora.value) {
                                inputHora.value = calcularHoraPrevistaSaida();
                            }
                        });
                    }
                },
                preConfirm: () => {
                    const popup = Swal.getPopup();
                    const visitaEstendida = popup.querySelector('#editar-visita-estendida').checked;
                    const horaPrevista = popup.querySelector('#editar-hora-prevista').value;
                    if (!visitaEstendida && !horaPrevista) {
                        Swal.showValidationMessage('Informe a previs칚o de sa칤da ou marque visita estendida');
                        return false;
                    }
                    return { visitaEstendida, horaPrevista };
                }
            });

            if (!resultado.isConfirmed || !resultado.value) {
                return;
            }

            const { visitaEstendida, horaPrevista } = resultado.value;
            const dados = {
                id: armario.idPlanilha || armario.id,
                numero: armario.numero,
                horaPrevista: visitaEstendida ? '' : horaPrevista,
                visitaEstendida,
                usuarioResponsavel: obterDescricaoResponsavelAtual()
            };

            const overlay = mostrarOverlayCarregamento('Atualizando hor치rio do arm치rio...');
            try {
                const resposta = await callGoogleScript('atualizarHorarioVisitante', dados);
                if (resposta.success) {
                    const atualizacoes = {
                        horaPrevista: visitaEstendida ? '' : horaPrevista,
                        visitaEstendida
                    };
                    const atualizado = atualizarArmarioLocal(armario.id, atualizacoes);
                    if (!atualizado) {
                        console.warn('Arm치rio n칚o encontrado para atualiza칞칚o local imediata:', armario.id);
                    }
                    atualizarResumoDashboardLocal();
                    atualizarInterface();
                    carregarDadosTabelas({ recarregarArmarios: false }).catch(erro => {
                        console.error('Erro ao atualizar tabelas ap칩s edi칞칚o de hor치rio:', erro);
                    });
                    mostrarSucesso('Hor치rio atualizado com sucesso');
                } else {
                    notificarErroPadrao(resposta, 'N칚o foi poss칤vel atualizar o hor치rio');
                }
            } finally {
                overlay();
            }
        }
        // Abrir modal para novo arm치rio
        async function abrirModalNovoArmario(tipo) {
            // Buscar arm치rios livres do tipo especificado
            await carregarArmarios({ forcarAtualizacao: true });
            if (!estado.armariosCarregados) {
                mostrarErro('Erro ao buscar arm치rios');
                return;
            }
            const tipoNormalizado = normalizarTexto(tipo);
            const armarioLivre = estado.armarios
                .filter(a => normalizarTexto(a.tipo) === tipoNormalizado)
                .find(a => a.status === 'livre');
            if (armarioLivre) {
                abrirModalArmario(armarioLivre);
            } else {
                await Swal.fire({
                    title: 'Sem arm치rios dispon칤veis',
                    text: `N칚o h치 arm치rios ${tipo === 'visitante' ? 'de visitantes' : 'de acompanhantes'} dispon칤veis no momento.`,
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
            }
        }
        // Abrir modal para novo arm치rio f칤sico
        async function abrirModalNovoArmarioFisico() {
            if (!estado.unidades.length) {
                await Swal.fire({
                    title: 'Nenhuma unidade cadastrada',
                    text: 'Cadastre uma unidade antes de adicionar novos arm치rios.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }
            const opcoesUnidades = estado.unidades.map(unidade => {
                const nomeLimpo = (unidade.nome || '').trim();
                const selecionada = normalizarTexto(estado.unidadeAtual) === normalizarTexto(nomeLimpo) ? 'selected' : '';
                return `<option value="${nomeLimpo}" ${selecionada}>${nomeLimpo}</option>`;
            }).join('');
            const resultado = await Swal.fire({
                title: 'Cadastro de Arm치rios F칤sicos',
                html: `
                    <div class="swal-form-grid">
                        <div class="swal-form-section">
                            <div class="swal-form-section-title"><i class="fas fa-info-circle"></i>Informa칞칫es gerais</div>
                            <div class="swal-form-fields">
                                <div class="swal-form-group">
                                    <label for="tipo-armario">Tipo de arm치rio</label>
                                    <select id="tipo-armario" class="swal2-input">
                                        <option value="visitante">Visitante</option>
                                        <option value="acompanhante">Acompanhante</option>
                                    </select>
                                </div>
                                <div class="swal-form-group">
                                    <label for="unidade-armario">Unidade respons치vel</label>
                                    <select id="unidade-armario" class="swal2-input">
                                        ${opcoesUnidades}
                                    </select>
                                </div>
                                <div class="swal-form-group">
                                    <label for="localizacao-armario">Localiza칞칚o f칤sica</label>
                                    <input type="text" id="localizacao-armario" class="swal2-input" placeholder="Ex.: Bloco A - T칠rreo ou Sala 102">
                                </div>
                            </div>
                        </div>
                        <div class="swal-form-section">
                            <div class="swal-form-section-title"><i class="fas fa-list-ol"></i>Numera칞칚o dos arm치rios</div>
                            <div class="swal-form-fields two-columns">
                                <div class="swal-form-group">
                                    <label for="quantidade-armarios">Quantidade a cadastrar</label>
                                    <input type="number" id="quantidade-armarios" class="swal2-input" min="1" value="1" placeholder="Quantidade de arm치rios">
                                </div>
                                <div class="swal-form-group">
                                    <label for="numero-armario">N칰mero 칰nico</label>
                                    <input type="text" id="numero-armario" class="swal2-input" placeholder="Informe apenas se cadastrar 1 arm치rio">
                                </div>
                                <div class="swal-form-group">
                                    <label for="prefixo-armario">Prefixo</label>
                                    <input type="text" id="prefixo-armario" class="swal2-input" placeholder="Ex.: UIB-V (usado para lotes)">
                                </div>
                                <div class="swal-form-group">
                                    <label for="inicio-armario">In칤cio da numera칞칚o</label>
                                    <input type="number" id="inicio-armario" class="swal2-input" min="1" value="1" placeholder="Primeiro n칰mero do lote">
                                </div>
                            </div>
                            <div class="swal-form-hint">
                                Para cadastrar apenas um arm치rio, preencha <strong>N칰mero 칰nico</strong>. Para criar v치rios de uma vez, informe a <strong>Quantidade</strong>, o <strong>Prefixo</strong> e o <strong>In칤cio da numera칞칚o</strong>.
                            </div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Cadastrar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const popup = Swal.getPopup();
                    const tipo = popup.querySelector('#tipo-armario').value;
                    const unidade = popup.querySelector('#unidade-armario').value;
                    const localizacao = popup.querySelector('#localizacao-armario').value.trim();
                    const quantidadeValor = parseInt(popup.querySelector('#quantidade-armarios').value, 10);
                    const numero = popup.querySelector('#numero-armario').value.trim();
                    const prefixo = popup.querySelector('#prefixo-armario').value.trim();
                    const inicioValor = parseInt(popup.querySelector('#inicio-armario').value, 10);
                    if (!unidade) {
                        Swal.showValidationMessage('Selecione a unidade');
                        return false;
                    }
                    if (!localizacao) {
                        Swal.showValidationMessage('Informe a localiza칞칚o dos arm치rios');
                        return false;
                    }
                    const quantidade = Number.isNaN(quantidadeValor) ? 1 : Math.max(1, quantidadeValor);
                    const numeroInicial = Number.isNaN(inicioValor) ? 1 : Math.max(1, inicioValor);
                    if (quantidade > 1 && !prefixo) {
                        Swal.showValidationMessage('Informe um prefixo para gerar v치rios arm치rios');
                        return false;
                    }
                    if (quantidade === 1 && !numero && !prefixo) {
                        Swal.showValidationMessage('Informe o n칰mero ou um prefixo para gerar a numera칞칚o');
                        return false;
                    }
                    return { tipo, unidade, localizacao, quantidade, numero, prefixo, numeroInicial };
                }
            });
            if (!resultado.isConfirmed || !resultado.value) {
                return;
            }
            const dados = resultado.value;
            const cadastroResultado = await callGoogleScript('cadastrarArmarioFisico', dados);
            if (cadastroResultado.success) {
                // Recarregar dados
                await carregarArmarios({ forcarAtualizacao: true });
                await carregarEstatisticas();
                atualizarInterface();
                carregarDadosTabelas();
                await Swal.fire({
                    title: 'Sucesso!',
                    text: `${cadastroResultado.numeros.length} arm치rio(s) cadastrados: ${cadastroResultado.numeros.join(', ')}`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                notificarErroPadrao(cadastroResultado);
            }
        }
        // Abrir modal para novo usu치rio
        function abrirModalNovoUsuario() {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem cadastrar usu치rios.');
                return;
            }
            elementos.usuarioForm.reset();
            elementos.usuarioForm.dataset.id = '';
            if (elementos.usuarioModalTitle) {
                elementos.usuarioModalTitle.textContent = 'Cadastrar Usu치rio';
            }
            if (elementos.usuarioStatus) {
                elementos.usuarioStatus.value = 'ativo';
            }
            if (elementos.usuarioUnidades) {
                renderizarOpcoesUnidadesFormulario();
            }
            if (elementos.usuarioModal.style.display !== 'flex') {
                travaRolagem.aplicar();
            }
            elementos.usuarioModal.style.display = 'flex';
        }
        // Fechar modais
        function fecharModalArmario() {
            limparRascunhoArmario();
            if (elementos.armarioModal.style.display === 'flex') {
                travaRolagem.remover();
            }
            elementos.armarioModal.style.display = 'none';
        }
        function fecharModalUsuario() {
            if (elementos.usuarioModal.style.display === 'flex') {
                travaRolagem.remover();
            }
            elementos.usuarioModal.style.display = 'none';
            if (elementos.usuarioForm) {
                elementos.usuarioForm.dataset.id = '';
            }
        }
        // Salvar arm치rio (cadastro)
        async function salvarArmario() {
            const botaoSalvar = document.getElementById('btn-salvar');
            const finalizarLoading = iniciarLoadingBotao(botaoSalvar);
            try {
                const idPlanilhaBruto = elementos.armarioForm.dataset.idPlanilha || elementos.armarioForm.dataset.id || '';
                const idPlanilha = normalizarIdentificador(idPlanilhaBruto);
                const armarioChave = normalizarIdentificador(elementos.armarioForm.dataset.armarioId || '');
                const tipo = elementos.armarioForm.dataset.tipo || 'visitante';
                const numeroArmario = elementos.armarioForm.dataset.numero || '';
                let volumesInformados = parseInt(document.getElementById('volumes').value, 10);
                if (Number.isNaN(volumesInformados) || volumesInformados < 0) {
                    volumesInformados = 0;
                }
                const visitaEstendida = tipo === 'visitante'
                    ? Boolean(elementos.visitaEstendidaInput && elementos.visitaEstendidaInput.checked)
                    : false;
                const dados = {
                    idPlanilha,
                    id: idPlanilha,
                    numero: numeroArmario,
                    nomeVisitante: document.getElementById('nome-visitante').value.trim(),
                    nomePaciente: document.getElementById('nome-paciente').value.trim(),
                    leito: document.getElementById('leito').value.trim(),
                    whatsapp: document.getElementById('whatsapp-contato').value.trim(),
                    volumes: volumesInformados,
                    horaPrevista: tipo === 'visitante' ? document.getElementById('hora-prevista').value : '',
                    visitaEstendida: visitaEstendida,
                    tipo: tipo,
                    usuarioResponsavel: obterDescricaoResponsavelAtual()
                };
                if (visitaEstendida) {
                    dados.horaPrevista = '';
                }
                if (tipo === 'acompanhante') {
                    termoPreCadastro = {
                        id: idPlanilha,
                        nomeVisitante: dados.nomeVisitante,
                        nomePaciente: dados.nomePaciente,
                        leito: dados.leito,
                        volumes: volumesInformados,
                        whatsapp: dados.whatsapp
                    };
                    termoCadastroArmario = {
                        id: idPlanilha,
                        nomeVisitante: dados.nomeVisitante,
                        nomePaciente: dados.nomePaciente,
                        leito: dados.leito,
                        whatsapp: dados.whatsapp
                    };
                    let ocultarOverlay = () => {};
                    try {
                        ocultarOverlay = mostrarOverlayCarregamento('Preparando termo de responsabilidade...');
                        let chaveArmario = armarioChave;
                        if (!chaveArmario) {
                            const armarioEstado = estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === idPlanilha);
                            chaveArmario = armarioEstado ? armarioEstado.id : '';
                        }
                        await abrirTermoWizard(chaveArmario || idPlanilha);
                        fecharModalArmario();
                        limparRascunhoArmario();
                    } catch (erroTermo) {
                        termoPreCadastro = null;
                        termoCadastroArmario = null;
                        notificarErroPadrao({ error: erroTermo.message || erroTermo.toString() });
                    } finally {
                        ocultarOverlay();
                    }
                } else {
                    const resultado = await callGoogleScript('cadastrarArmario', dados);
                    if (resultado.success) {
                        fecharModalArmario();
                        limparRascunhoArmario();

                        let idParaAtualizacao = armarioChave;
                        if (!idParaAtualizacao && idPlanilha) {
                            const armarioEstado = estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === idPlanilha);
                            if (armarioEstado) {
                                idParaAtualizacao = armarioEstado.id;
                            }
                        }

                        if (idParaAtualizacao) {
                            const agora = new Date();
                            const horaInicioLocal = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            const atualizacoesLocais = {
                                status: 'em-uso',
                                nomeVisitante: dados.nomeVisitante,
                                nomePaciente: dados.nomePaciente,
                                leito: dados.leito,
                                volumes: volumesInformados,
                                whatsapp: dados.whatsapp,
                                horaInicio: horaInicioLocal,
                                horaPrevista: dados.horaPrevista || '',
                                visitaEstendida: visitaEstendida,
                                dataRegistro: agora.toISOString(),
                                tipo: tipo
                            };
                            const atualizado = atualizarArmarioLocal(idParaAtualizacao, atualizacoesLocais);
                            if (!atualizado) {
                                console.warn('Arm치rio n칚o encontrado no estado local para atualiza칞칚o imediata:', idParaAtualizacao);
                            }
                        }

                        atualizarResumoDashboardLocal();
                        atualizarInterface();
                        carregarDadosTabelas({ recarregarArmarios: false }).catch(erro => {
                            console.error('Erro ao atualizar tabelas localmente ap칩s cadastro:', erro);
                        });

                        mostrarSucesso('Arm치rio cadastrado com sucesso');
                        sincronizarDadosArmariosEmSegundoPlano({ recarregarArmariosNasTabelas: true });
                    } else {
                        notificarErroPadrao(resultado);
                    }
                }
            } finally {
                finalizarLoading();
            }
        }
        // Salvar usu치rio
        async function salvarUsuario() {
            if (!perfilAtualEhAdmin()) {
                mostrarErro('Apenas administradores podem salvar usu치rios.');
                return;
            }
            const botaoSalvar = document.getElementById('usuario-btn-salvar');
            const finalizarLoading = iniciarLoadingBotao(botaoSalvar);
            const usuarioId = elementos.usuarioForm.dataset.id;
            const dados = {
                id: usuarioId,
                nome: document.getElementById('usuario-nome').value.trim(),
                email: document.getElementById('usuario-email').value.trim(),
                senha: elementos.usuarioSenha ? elementos.usuarioSenha.value.trim() : '',
                perfil: document.getElementById('usuario-perfil').value,
                status: elementos.usuarioStatus ? elementos.usuarioStatus.value : 'ativo',
                acessoVisitantes: document.getElementById('acesso-visitantes').checked,
                acessoAcompanhantes: document.getElementById('acesso-acompanhantes').checked,
                unidades: obterUnidadesSelecionadasFormulario()
            };
            try {
                if (!dados.unidades.length && dados.perfil !== 'admin') {
                    mostrarErro('Selecione ao menos uma unidade para o usu치rio.');
                    return;
                }
                const acao = usuarioId ? 'atualizarUsuario' : 'cadastrarUsuario';
                const resultado = await callGoogleScript(acao, dados);
                if (resultado.success) {
                    fecharModalUsuario();
                    mostrarSucesso(usuarioId ? 'Usu치rio atualizado com sucesso' : 'Usu치rio cadastrado com sucesso');
                    await carregarUsuarios();
                    carregarTabelaUsuarios();
                } else {
                    notificarErroPadrao(resultado);
                }
            } finally {
                finalizarLoading();
            }
        }
        // Liberar arm치rio
        async function liberarArmario(id, tipoPreferencial) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Arm치rio n칚o encontrado. Atualize a lista e tente novamente.');
                return;
            }
            const identificadores = montarIdentificadoresArmario(armario);
            const payload = montarPayloadAcaoArmario(armario, {
                tipo: tipoPreferencial || identificadores.tipo
            });
            payload.numero = identificadores.numeroArmario;

            const resultado = await callGoogleScript('liberarArmario', payload);
            if (resultado.success) {
                garantirArmarioLiberadoLocal(id);
                atualizarResumoDashboardLocal();
                atualizarInterface();
                carregarDadosTabelas({ recarregarArmarios: false }).catch(erro => {
                    console.error('Erro ao atualizar tabelas localmente ap칩s libera칞칚o:', erro);
                });

                mostrarSucesso('Arm치rio liberado com sucesso');
                sincronizarDadosArmariosEmSegundoPlano({ recarregarArmariosNasTabelas: true });
                return;
            }

            const mensagemErro = (resultado.error || '').toString();
            const mensagemNormalizada = mensagemErro.toLowerCase();

            if (mensagemNormalizada.includes('j치 est치 livre')) {
                mostrarErro('Este arm치rio j치 est치 livre. Atualize a lista para confirmar a situa칞칚o.');
                return;
            }

            if (mensagemNormalizada.includes('n칚o encontrado')) {
                mostrarErro('N칚o encontramos este arm치rio. Atualize a lista e tente novamente.');
                return;
            }

            notificarErroPadrao(resultado);
        }
        function formatarStatusArmario(status) {
            switch (status) {
                case 'em-uso':
                    return 'Em uso';
                case 'proximo':
                    return 'Pr칩ximo do hor치rio';
                case 'vencido':
                    return 'Vencido';
                case 'contingencia':
                    return 'Conting칡ncia';
                default:
                    return 'Livre';
            }
        }
        function formatarStatusTermo(status) {
            const normalizado = normalizarTexto(status);
            if (normalizado === 'finalizado') {
                return 'Finalizado';
            }
            if (normalizado === 'em andamento') {
                return 'Em andamento';
            }
            return 'Pendente';
        }
        function formatarData(valor) {
            if (!valor) return '-';
            if (typeof valor === 'string') {
                const texto = valor.trim();
                if (!texto) return '-';
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(texto)) {
                    return texto;
                }
            }
            try {
                const data = new Date(valor);
                if (Number.isNaN(data.getTime())) {
                    return valor;
                }
                return data.toLocaleDateString('pt-BR');
            } catch {
                return valor;
            }
        }
        function tentarConverterParaData(valor) {
            if (!valor) return null;
            if (valor instanceof Date && !Number.isNaN(valor.getTime())) {
                return new Date(valor.getTime());
            }
            if (typeof valor === 'number' && Number.isFinite(valor)) {
                const dataNumerica = new Date(valor);
                return Number.isNaN(dataNumerica.getTime()) ? null : dataNumerica;
            }
            const texto = String(valor).trim();
            if (!texto) return null;
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(texto)) {
                const [dia, mes, ano] = texto.split('/').map(Number);
                if (!Number.isNaN(dia) && !Number.isNaN(mes) && !Number.isNaN(ano)) {
                    const dataLocal = new Date(ano, mes - 1, dia);
                    return Number.isNaN(dataLocal.getTime()) ? null : dataLocal;
                }
            }
            const normalizado = texto.replace(' ', 'T');
            const data = new Date(normalizado);
            return Number.isNaN(data.getTime()) ? null : data;
        }
        function obterDiaSemanaFormatado(valor) {
            const dataObj = tentarConverterParaData(valor);
            if (!dataObj) return '';
            try {
                return new Intl.DateTimeFormat('pt-BR', { weekday: 'long' }).format(dataObj);
            } catch {
                return '';
            }
        }
        function formatarDataComDiaSemana(valor) {
            const dataFormatada = formatarData(valor);
            if (!valor || dataFormatada === '-') {
                return dataFormatada;
            }
            const diaSemana = obterDiaSemanaFormatado(valor);
            if (!diaSemana) {
                return dataFormatada;
            }
            return `${dataFormatada} (${diaSemana})`;
        }
        function expandirAnoDoisDigitos(anoTexto) {
            const numero = parseInt(anoTexto, 10);
            if (Number.isNaN(numero) || numero < 0) {
                return '';
            }
            const anoAtual = new Date().getFullYear() % 100;
            const seculoBase = numero <= anoAtual ? 2000 : 1900;
            return String(seculoBase + numero).padStart(4, '0');
        }
        function validarPartesData(dia, mes, ano) {
            const diaNum = Number(dia);
            const mesNum = Number(mes);
            const anoNum = Number(ano);
            if (!Number.isInteger(diaNum) || !Number.isInteger(mesNum) || !Number.isInteger(anoNum)) {
                return false;
            }
            if (mesNum < 1 || mesNum > 12) {
                return false;
            }
            if (diaNum < 1 || diaNum > 31) {
                return false;
            }
            if (anoNum < 1900) {
                return false;
            }
            return true;
        }
        function converterDataTextoParaISO(valor) {
            if (!valor) return '';
            const texto = valor.toString().trim();
            if (!texto) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(texto)) {
                return texto;
            }
            const isoCompleto = texto.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (isoCompleto) {
                const [, anoIso, mesIso, diaIso] = isoCompleto;
                return `${anoIso}-${mesIso}-${diaIso}`;
            }
            let apenasDigitos = texto.replace(/\D/g, '');
            if (apenasDigitos.length < 6) {
                return '';
            }
            apenasDigitos = apenasDigitos.slice(0, 8);
            const dia = apenasDigitos.slice(0, 2);
            const mes = apenasDigitos.slice(2, 4);
            let ano = '';
            if (apenasDigitos.length >= 8) {
                ano = apenasDigitos.slice(4, 8);
            } else {
                ano = expandirAnoDoisDigitos(apenasDigitos.slice(4, 6));
            }
            if (!ano || !validarPartesData(dia, mes, ano)) {
                return '';
            }
            const data = new Date(Number(ano), Number(mes) - 1, Number(dia));
            if (Number.isNaN(data.getTime())) {
                return '';
            }
            const diaValidado = String(data.getDate()).padStart(2, '0');
            const mesValidado = String(data.getMonth() + 1).padStart(2, '0');
            const anoValidado = String(data.getFullYear()).padStart(4, '0');
            if (diaValidado !== dia || mesValidado !== mes || anoValidado !== ano) {
                return '';
            }
            return `${ano}-${mes}-${dia}`;
        }
        function formatarDataParaCampoNascimento(valor) {
            if (!valor) return '';
            const texto = valor.toString().trim();
            if (!texto) return '';
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(texto)) {
                return texto;
            }
            if (/^\d{2}\/\d{2}\/\d{2}$/.test(texto)) {
                const [diaCurto, mesCurto, anoCurto] = texto.split('/');
                const anoCompleto = expandirAnoDoisDigitos(anoCurto);
                if (!anoCompleto) {
                    return '';
                }
                return `${diaCurto}/${mesCurto}/${anoCompleto}`;
            }
            if (/^\d{4}-\d{2}-\d{2}$/.test(texto)) {
                const [ano, mes, dia] = texto.split('-');
                return `${dia}/${mes}/${ano}`;
            }
            const data = new Date(texto);
            if (Number.isNaN(data.getTime())) {
                return '';
            }
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = String(data.getFullYear()).padStart(4, '0');
            return `${dia}/${mes}/${ano}`;
        }
        function aplicarMascaraDataNascimento(campo) {
            if (!campo) return;
            const digitos = campo.value.replace(/\D/g, '').slice(0, 8);
            const partes = [];
            if (digitos.length > 0) {
                partes.push(digitos.slice(0, Math.min(2, digitos.length)));
            }
            if (digitos.length > 2) {
                partes.push(digitos.slice(2, Math.min(4, digitos.length)));
            }
            if (digitos.length > 4) {
                partes.push(digitos.slice(4));
            }
            const formatado = partes.join('/');
            const posicaoFinal = formatado.length;
            campo.value = formatado;
            if (typeof campo.setSelectionRange === 'function') {
                campo.setSelectionRange(posicaoFinal, posicaoFinal);
            }
        }
        function normalizarCampoDataNascimento(campo) {
            if (!campo) return;
            aplicarMascaraDataNascimento(campo);
            const iso = converterDataTextoParaISO(campo.value);
            if (iso) {
                campo.dataset.isoValue = iso;
                campo.closest('.wizard-field')?.classList.remove('invalid');
            } else {
                delete campo.dataset.isoValue;
            }
        }
        function finalizarCampoDataNascimento(campo) {
            if (!campo) return;
            const iso = converterDataTextoParaISO(campo.value);
            if (iso) {
                campo.value = formatarDataParaCampoNascimento(iso);
                campo.dataset.isoValue = iso;
            }
        }
        function formatarDataHora(valor) {
            if (!valor) return '-';
            try {
                const data = new Date(valor);
                if (Number.isNaN(data.getTime())) {
                    return valor;
                }
                return `${data.toLocaleDateString('pt-BR')} ${data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
            } catch {
                return valor;
            }
        }
        function obterArmarioPorId(id) {
            const alvo = normalizarIdentificador(id);
            return estado.armarios.find(a => normalizarIdentificador(a.id) === alvo);
        }
        function usarArmario(id) {
            const armario = obterArmarioPorId(id);
            if (armario) {
                abrirModalArmario(armario);
            }
        }
        function abrirTermoDireto(id) {
            abrirTermoWizard(id);
        }
        function setEstadoCarregamentoTermo(ativo, mensagem = 'Carregando dados do termo...') {
            if (elementos.termoLoading) {
                elementos.termoLoading.classList.toggle('active', Boolean(ativo));
            }
            if (elementos.termoLoadingText && mensagem) {
                elementos.termoLoadingText.textContent = mensagem;
            }
            if (elementos.termoModal) {
                elementos.termoModal.setAttribute('aria-busy', ativo ? 'true' : 'false');
            }
        }
        function preencherCamposTermo(armario, termoDados, preCadastro, opcoes = {}) {
            if (!armario) return;
            const { restaurarAssinatura = true } = opcoes;
            document.getElementById('termo-paciente').value = termoDados?.paciente || preCadastro?.nomePaciente || armario.nomePaciente || '';
            document.getElementById('termo-prontuario').value = termoDados?.prontuario || '';
            if (elementos.termoNascimento) {
                const origemNascimento = termoDados?.nascimento || preCadastro?.nascimento || '';
                const valorNascimento = formatarDataParaCampoNascimento(origemNascimento);
                elementos.termoNascimento.value = valorNascimento;
                if (valorNascimento) {
                    const isoNascimento = converterDataTextoParaISO(valorNascimento);
                    if (isoNascimento) {
                        elementos.termoNascimento.dataset.isoValue = isoNascimento;
                    } else {
                        delete elementos.termoNascimento.dataset.isoValue;
                    }
                } else {
                    delete elementos.termoNascimento.dataset.isoValue;
                }
            }
            definirSetorTermo(termoDados?.setor || preCadastro?.setor || '');
            document.getElementById('termo-leito').value = aplicarMascaraLeito(termoDados?.leito || preCadastro?.leito || armario.leito || '');
            document.getElementById('termo-resp-nome').value = termoDados?.acompanhante || preCadastro?.nomeVisitante || armario.nomeVisitante || '';
            document.getElementById('termo-resp-telefone').value = termoDados?.telefone || '';
            document.getElementById('termo-resp-doc').value = termoDados?.documento || '';
            document.getElementById('termo-resp-parentesco').value = termoDados?.parentesco || '';
            if (termoDados?.consciente) {
                const radio = document.querySelector(`input[name="termo-consciente"][value="${termoDados.consciente}"]`);
                if (radio) radio.checked = true;
            } else {
                document.querySelectorAll('input[name="termo-consciente"]').forEach(r => (r.checked = false));
            }
            ['ori1', 'ori2', 'ori3'].forEach(chave => {
                const checkbox = document.getElementById(`termo-${chave}`);
                if (checkbox) {
                    checkbox.checked = termoDados?.orientacoes?.includes(chave) || false;
                }
            });
            prepararVolumesTermo(Array.isArray(termoDados?.volumes) && termoDados.volumes.length ? termoDados.volumes : []);
            restaurarRascunhoTermo();
            mostrarPassoTermo(termoPassoAtual || 0);
            const assinaturaInicial = termoDados?.assinaturas?.inicial || termoDados?.assinaturaBase64 || '';
            if (restaurarAssinatura && assinaturaInicial && !termoAssinaturaDesenhada) {
                restaurarAssinaturaTermo(assinaturaInicial);
            }
        }
        async function abrirTermoWizard(id) {
            let armario = obterArmarioPorId(id);
            if (!armario) {
                armario = estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(id));
            }
            if (!armario) return;
            const identificadores = montarIdentificadoresArmario(armario);
            ajustarObrigatoriedadeCamposPaciente(identificadores?.tipo || armario.tipo || '');
            termoArmarioAtual = id;
            termoPassoAtual = 0;
            elementos.termoArmario.textContent = identificadores?.numeroArmario || armario.numero || '';
            elementos.termoForm.reset();
            elementos.termoForm.querySelectorAll('.wizard-field').forEach(field => field.classList.remove('invalid'));
            limparAssinaturaTermo(true);
            if (elementos.termoNascimento) {
                delete elementos.termoNascimento.dataset.isoValue;
            }
            setEstadoCarregamentoTermo(true, 'Carregando dados do termo...');
            const preCadastro = termoPreCadastro && identificadores && normalizarIdentificador(termoPreCadastro.id) === identificadores.idPlanilha
                ? termoPreCadastro
                : null;
            if (elementos.termoModal.style.display !== 'flex') {
                travaRolagem.aplicar();
            }
            elementos.termoModal.style.display = 'flex';
            await aguardarProximoFrame();
            inicializarCanvasAssinatura();
            preencherCamposTermo(armario, null, preCadastro, { restaurarAssinatura: false });
            (async () => {
                let termoDados = null;
                try {
                    const resposta = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: false }));
                    if (resposta.success) {
                        termoDados = resposta.data;
                    } else if (resposta.error && resposta.error !== 'Termo n칚o encontrado') {
                        notificarErroPadrao(resposta);
                    }
                } catch (erro) {
                    console.warn('Falha ao carregar termo existente:', erro);
                } finally {
                    preencherCamposTermo(armario, termoDados, preCadastro);
                    setEstadoCarregamentoTermo(false);
                }
            })();
        }
        function mostrarPassoTermo(indice) {
            termoSteps.forEach((step, idx) => step.classList.toggle('active', idx === indice));
            termoPassoAtual = indice;
            const passoAtual = termoSteps[indice];
            if (passoAtual?.contains(elementos.termoAssinaturaCanvas)) {
                requestAnimationFrame(() => inicializarCanvasAssinatura());
            }
            const total = termoSteps.length;
            elementos.termoBtnVoltar.disabled = indice === 0;
            elementos.termoBtnAvancar.textContent = indice === total - 1 ? 'Concluir etapa inicial' : 'Avan칞ar';
            const progresso = ((indice + 1) / total) * 100;
            elementos.termoProgress.style.width = `${progresso}%`;
            elementos.termoProgressLabel.textContent = `Passo ${indice + 1} de ${total}`;
            salvarRascunhoTermo();
        }
        function marcarCampoTermoInvalido(elemento) {
            const field = elemento.closest('.wizard-field') || elemento.closest('.wizard-chip')?.closest('.wizard-field');
            if (field) {
                field.classList.add('invalid');
            }
        }
        function validarPassoTermo(indice) {
            const step = termoSteps[indice];
            if (!step) return true;
            step.querySelectorAll('.wizard-field').forEach(field => field.classList.remove('invalid'));
            const inputs = step.querySelectorAll('input[required], textarea[required], select[required]');
            let valido = true;
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    const radios = step.querySelectorAll(`input[type="radio"][name="${input.name}"]`);
                    const algumMarcado = Array.from(radios).some(radio => radio.checked);
                    if (!algumMarcado) {
                        marcarCampoTermoInvalido(input);
                        valido = false;
                    }
                } else if (input.type === 'checkbox') {
                    if (!input.checked) {
                        marcarCampoTermoInvalido(input);
                        valido = false;
                    }
                } else {
                    if (!input.value.trim()) {
                        marcarCampoTermoInvalido(input);
                        valido = false;
                    }
                    if (input.id === 'termo-nascimento') {
                        const iso = converterDataTextoParaISO(input.value);
                        if (!iso) {
                            delete input.dataset.isoValue;
                            marcarCampoTermoInvalido(input);
                            valido = false;
                        } else {
                            input.dataset.isoValue = iso;
                        }
                    }
                }
            });
            if (step.contains(elementos.termoVolumesField) && !validarVolumesTermo()) {
                valido = false;
            }
            if (step.contains(elementos.termoAssinaturaCanvas) && !termoAssinaturaDesenhada) {
                elementos.termoAssinaturaCanvas.closest('.wizard-field')?.classList.add('invalid');
                valido = false;
            }
            return valido;
        }
        function prepararVolumesTermo(volumes = []) {
            if (!elementos.termoVolumesList) return;
            elementos.termoVolumesList.innerHTML = '';
            if (Array.isArray(volumes) && volumes.length) {
                volumes.forEach(volume => adicionarVolumeTermo(volume));
            } else {
                adicionarVolumeTermo();
            }
            atualizarRemocaoVolumesTermo();
            elementos.termoVolumesField?.classList.remove('invalid');
        }
        function criarVolumeItemTermo(dados = {}) {
            const item = document.createElement('div');
            item.className = 'wizard-volume-item';
            const grid = document.createElement('div');
            grid.className = 'wizard-volume-grid';
            const colQtd = document.createElement('div');
            colQtd.className = 'wizard-volume-col';
            const labelQtd = document.createElement('label');
            labelQtd.textContent = 'Quantidade';
            const inputQtd = document.createElement('input');
            inputQtd.type = 'number';
            inputQtd.min = '1';
            inputQtd.placeholder = 'Qtd.';
            inputQtd.className = 'wizard-input termo-volume-qty';
            if (dados.quantidade !== undefined && dados.quantidade !== null && dados.quantidade !== '') {
                inputQtd.value = dados.quantidade;
            }
            const colDesc = document.createElement('div');
            colDesc.className = 'wizard-volume-col';
            const labelDesc = document.createElement('label');
            labelDesc.textContent = 'Descri칞칚o';
            const inputDesc = document.createElement('input');
            inputDesc.type = 'text';
            inputDesc.placeholder = 'Ex.: mochila azul';
            inputDesc.className = 'wizard-input termo-volume-desc';
            inputDesc.setAttribute('list', 'termo-itens-sugestoes');
            if (dados.descricao) {
                inputDesc.value = dados.descricao;
            }
            const actions = document.createElement('div');
            actions.className = 'wizard-volume-actions';
            const remover = document.createElement('button');
            remover.type = 'button';
            remover.className = 'btn btn-secondary btn-remove-volume';
            remover.textContent = 'Remover';
            actions.appendChild(remover);
            colQtd.appendChild(labelQtd);
            colQtd.appendChild(inputQtd);
            colDesc.appendChild(labelDesc);
            colDesc.appendChild(inputDesc);
            grid.appendChild(colQtd);
            grid.appendChild(colDesc);
            grid.appendChild(actions);
            item.appendChild(grid);
            return item;
        }
        function adicionarVolumeTermo(dados = {}) {
            if (!elementos.termoVolumesList) return null;
            const item = criarVolumeItemTermo(dados);
            elementos.termoVolumesList.appendChild(item);
            atualizarRemocaoVolumesTermo();
            elementos.termoVolumesField?.classList.remove('invalid');
            return item;
        }
        function removerVolumeTermo(item) {
            if (!item || !elementos.termoVolumesList) return;
            item.remove();
            if (!elementos.termoVolumesList.querySelector('.wizard-volume-item')) {
                adicionarVolumeTermo();
            }
            atualizarRemocaoVolumesTermo();
            salvarRascunhoTermo();
        }
        function atualizarRemocaoVolumesTermo() {
            if (!elementos.termoVolumesList) return;
            const itens = Array.from(elementos.termoVolumesList.querySelectorAll('.wizard-volume-item'));
            itens.forEach(item => {
                const botao = item.querySelector('.btn-remove-volume');
                if (botao) {
                    botao.style.display = itens.length === 1 ? 'none' : '';
                }
                const campoQtd = item.querySelector('.termo-volume-qty');
                const campoDesc = item.querySelector('.termo-volume-desc');
                if (campoQtd && !campoQtd.hasAttribute('required')) {
                    campoQtd.setAttribute('required', 'required');
                }
                if (campoDesc && !campoDesc.hasAttribute('required')) {
                    campoDesc.setAttribute('required', 'required');
                }
            });
        }
        function obterVolumesTermo() {
            if (!elementos.termoVolumesList) return [];
            return Array.from(elementos.termoVolumesList.querySelectorAll('.wizard-volume-item')).map(item => {
                const quantidadeValor = item.querySelector('.termo-volume-qty')?.value || '';
                const descricaoValor = item.querySelector('.termo-volume-desc')?.value.trim() || '';
                const quantidade = quantidadeValor ? parseInt(quantidadeValor, 10) : 0;
                return {
                    quantidade: Number.isNaN(quantidade) ? 0 : quantidade,
                    descricao: descricaoValor
                };
            });
        }
        function validarVolumesTermo() {
            if (!elementos.termoVolumesField) return true;
            const volumes = obterVolumesTermo();
            const todosValidos = volumes.length > 0 && volumes.every(volume => volume.quantidade > 0 && volume.descricao);
            if (!todosValidos) {
                elementos.termoVolumesField.classList.add('invalid');
                return false;
            }
            elementos.termoVolumesField.classList.remove('invalid');
            return true;
        }
        function limparAssinaturaTermo(silencioso = false) {
            const canvas = elementos.termoAssinaturaCanvas;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            termoAssinaturaDesenhada = false;
            termoDesenhandoAssinatura = false;
            const campo = canvas.closest('.wizard-field');
            if (!campo) return;
            if (silencioso) {
                campo.classList.remove('invalid');
            } else {
                campo.classList.add('invalid');
            }
            salvarRascunhoTermo();
        }
        function restaurarAssinaturaTermo(base64) {
            if (!base64) return;
            const canvas = elementos.termoAssinaturaCanvas;
            if (!canvas) return;
            const dataUrl = base64.startsWith('data:') ? base64 : `data:image/png;base64,${base64}`;
            restaurarDesenhoCanvas(canvas, dataUrl);
            termoAssinaturaDesenhada = true;
            termoDesenhandoAssinatura = false;
            canvas.closest('.wizard-field')?.classList.remove('invalid');
        }
        function obterPosicaoAssinaturaTermo(evento) {
            const canvas = elementos.termoAssinaturaCanvas;
            if (!canvas) return { x: 0, y: 0 };
            const rect = canvas.getBoundingClientRect();
            return {
                x: evento.clientX - rect.left,
                y: evento.clientY - rect.top
            };
        }
        function iniciarAssinaturaTermo(evento) {
            if (!elementos.termoAssinaturaCanvas) return;
            evento.preventDefault();
            termoDesenhandoAssinatura = true;
            const ctx = elementos.termoAssinaturaCanvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#0b1324';
            const pos = obterPosicaoAssinaturaTermo(evento);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
        function desenharAssinaturaTermo(evento) {
            if (!termoDesenhandoAssinatura || !elementos.termoAssinaturaCanvas) return;
            evento.preventDefault();
            const ctx = elementos.termoAssinaturaCanvas.getContext('2d');
            const pos = obterPosicaoAssinaturaTermo(evento);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            termoAssinaturaDesenhada = true;
            elementos.termoAssinaturaCanvas.closest('.wizard-field')?.classList.remove('invalid');
        }
        function finalizarAssinaturaTermo(evento) {
            if (!termoDesenhandoAssinatura) return;
            evento.preventDefault();
            termoDesenhandoAssinatura = false;
            termoAssinaturaDesenhada = true;
            elementos.termoAssinaturaCanvas?.closest('.wizard-field')?.classList.remove('invalid');
            salvarRascunhoTermo();
        }
        function navegarPassoTermo(delta) {
            const novoIndice = termoPassoAtual + delta;
            if (novoIndice >= 0 && novoIndice < termoSteps.length) {
                mostrarPassoTermo(novoIndice);
            }
        }
        async function avancarOuAplicarTermo(evento) {
            if (!validarPassoTermo(termoPassoAtual)) {
                return;
            }
            if (termoPassoAtual < termoSteps.length - 1) {
                mostrarPassoTermo(termoPassoAtual + 1);
                return;
            }
            const botao = evento?.currentTarget || elementos.termoBtnAvancar;
            const finalizar = iniciarLoadingBotao(botao);
            try {
                await aplicarTermo();
            } finally {
                finalizar();
            }
        }

        async function aplicarTermo() {
            if (termoArmarioAtual === null) return;
            const armarioAtual = obterArmarioPorId(termoArmarioAtual) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(termoArmarioAtual));
            if (!armarioAtual) {
                mostrarErro('Arm치rio n칚o encontrado para registrar o termo.');
                return;
            }
            const identificadores = montarIdentificadoresArmario(armarioAtual);
            // Capturar a assinatura do canvas
            const canvas = elementos.termoAssinaturaCanvas;
            const assinaturaBase64 = canvas ? canvas.toDataURL('image/png').replace('data:image/png;base64,', '') : '';
            const volumes = obterVolumesTermo();
            const descricaoVolumes = volumes.map(v => `${v.quantidade}x ${v.descricao}`).join('; ');
            const nascimentoCampo = elementos.termoNascimento;
            const nascimentoIso = nascimentoCampo ? converterDataTextoParaISO(nascimentoCampo.value) : '';
            const dadosTermo = {
                armarioId: identificadores?.idPlanilha || '',
                numeroArmario: identificadores?.numeroArmario || document.getElementById('termo-armario').textContent,
                paciente: document.getElementById('termo-paciente').value.trim(),
                prontuario: document.getElementById('termo-prontuario').value.trim(),
                nascimento: nascimentoIso,
                setor: (elementos.termoSetor?.value || '').toString().trim(),
                leito: document.getElementById('termo-leito').value.trim(),
                consciente: document.querySelector('input[name="termo-consciente"]:checked')?.value || '',
                acompanhante: document.getElementById('termo-resp-nome').value.trim(),
                telefone: document.getElementById('termo-resp-telefone').value.trim(),
                documento: document.getElementById('termo-resp-doc').value.trim(),
                parentesco: document.getElementById('termo-resp-parentesco').value.trim(),
                orientacoes: ['ori1', 'ori2', 'ori3'].filter(chave => document.getElementById(`termo-${chave}`).checked),
                volumes: volumes,
                descricaoVolumes: descricaoVolumes,
                assinaturaBase64: assinaturaBase64
            };
            if (termoCadastroArmario && identificadores && normalizarIdentificador(termoCadastroArmario.id) === identificadores.idPlanilha) {
                dadosTermo.cadastroArmario = {
                    id: identificadores.idPlanilha,
                    nomeVisitante: dadosTermo.acompanhante,
                    nomePaciente: dadosTermo.paciente,
                    leito: dadosTermo.leito,
                    whatsapp: termoCadastroArmario.whatsapp || ''
                };
            }
            dadosTermo.tipo = identificadores?.tipo || 'acompanhante';
            const resultado = await callGoogleScript('salvarTermoCompleto', dadosTermo);
            if (resultado.success) {
                fecharTermoModal();
                await atualizarDadosPosOperacao('Atualizando informa칞칫es do arm치rio...');
                mostrarSucesso('Etapa inicial do termo registrada. Finalize o termo ao encerrar o arm치rio.');
            } else {
                notificarErroPadrao(resultado);
            }
        }
        function fecharTermoModal() {
            if (elementos.termoModal.style.display === 'flex') {
                travaRolagem.remover();
            }
            elementos.termoModal.style.display = 'none';
            termoArmarioAtual = null;
            termoPreCadastro = null;
            termoCadastroArmario = null;
            termoUltimoProntuarioBuscado = '';
            termoBuscaProntuarioId = 0;
            mostrarPassoTermo(0);
            elementos.termoForm.reset();
            elementos.termoForm.querySelectorAll('.wizard-field').forEach(field => field.classList.remove('invalid'));
            if (elementos.termoNascimento) {
                delete elementos.termoNascimento.dataset.isoValue;
            }
            ajustarObrigatoriedadeCamposPaciente(null);
            prepararVolumesTermo();
            limparAssinaturaTermo(true);
            limparRascunhoTermo();
        }
        function criarControladorAssinaturaFinalizacao(canvas, field) {
            if (!canvas) return null;
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const areaAssinatura = canvas.parentElement;
            const areaRect = areaAssinatura ? areaAssinatura.getBoundingClientRect() : rect;
            const largura = areaRect.width || rect.width || canvas.clientWidth || 0;
            const altura = areaRect.height || rect.height || canvas.clientHeight || 160;
            canvas.width = largura;
            canvas.height = altura;
            canvas.style.width = '100%';
            canvas.style.height = `${altura}px`;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#0b1324';
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let desenhando = false;
            let assinou = false;

            const obterPosicao = (evento) => {
                const bounds = canvas.getBoundingClientRect();
                return {
                    x: evento.clientX - bounds.left,
                    y: evento.clientY - bounds.top
                };
            };

            const iniciar = (evento) => {
                evento.preventDefault();
                desenhando = true;
                const posicao = obterPosicao(evento);
                ctx.beginPath();
                ctx.moveTo(posicao.x, posicao.y);
                canvas.setPointerCapture?.(evento.pointerId);
                field?.classList.remove('invalid');
            };

            const desenhar = (evento) => {
                if (!desenhando) return;
                evento.preventDefault();
                const posicao = obterPosicao(evento);
                ctx.lineTo(posicao.x, posicao.y);
                ctx.stroke();
                assinou = true;
                field?.classList.remove('invalid');
            };

            const finalizar = (evento) => {
                if (!desenhando) return;
                evento.preventDefault();
                desenhando = false;
                canvas.releasePointerCapture?.(evento.pointerId);
            };

            const limpar = (mostrarErro = true) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                assinou = false;
                if (mostrarErro) {
                    field?.classList.add('invalid');
                }
            };

            const removerEventos = () => {
                canvas.removeEventListener('pointerdown', iniciar);
                canvas.removeEventListener('pointermove', desenhar);
                canvas.removeEventListener('pointerup', finalizar);
                canvas.removeEventListener('pointerleave', finalizar);
                canvas.removeEventListener('pointercancel', finalizar);
            };

            canvas.addEventListener('pointerdown', iniciar);
            canvas.addEventListener('pointermove', desenhar);
            canvas.addEventListener('pointerup', finalizar);
            canvas.addEventListener('pointerleave', finalizar);
            canvas.addEventListener('pointercancel', finalizar);
            field?.classList.add('invalid');

            return {
                limpar,
                possuiAssinatura: () => assinou,
                obterImagem: () => canvas.toDataURL('image/png'),
                destruir: removerEventos
            };
        }
        async function coletarAssinaturaEncerramento(nomeAcompanhante) {
            const nomeTratado = (nomeAcompanhante || '').toString().trim();
            const textoAssinante = nomeTratado ? `<strong>${nomeTratado}</strong>` : 'o acompanhante';
            let controlador = null;
            let botaoLimpar = null;
            let limparHandler = null;

            const resultado = await Swal.fire({
                title: 'Assinatura de encerramento',
                html: `
                    <div class="final-signature-dialog">
                        <p>Solicite que ${textoAssinante} assine abaixo para concluir o encerramento.</p>
                        <div class="wizard-field" id="final-signature-field">
                            <label class="wizard-required" for="final-signature-canvas">Assinatura do acompanhante</label>
                            <div class="wizard-signature-area">
                                <canvas id="final-signature-canvas" class="wizard-signature-canvas" aria-label="츼rea para assinatura de encerramento"></canvas>
                                <div class="wizard-signature-actions">
                                    <button type="button" class="btn btn-secondary" id="final-signature-clear">Limpar assinatura</button>
                                </div>
                                <div class="wizard-signature-hint">A assinatura ser치 anexada ao termo de responsabilidade.</div>
                            </div>
                            <div class="wizard-error">Colha a assinatura para finalizar o arm치rio.</div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                width: '720px',
                customClass: {
                    popup: 'swal2-final-signature'
                },
                confirmButtonText: 'Finalizar encerramento',
                cancelButtonText: 'Cancelar',
                didOpen: () => {
                    const canvas = document.getElementById('final-signature-canvas');
                    const field = document.getElementById('final-signature-field');
                    botaoLimpar = document.getElementById('final-signature-clear');
                    const inicializar = () => {
                        if (!canvas) {
                            return;
                        }
                        controlador = criarControladorAssinaturaFinalizacao(canvas, field);
                        if (botaoLimpar) {
                            limparHandler = (evento) => {
                                evento.preventDefault();
                                controlador?.limpar();
                            };
                            botaoLimpar.addEventListener('click', limparHandler);
                        }
                    };
                    if (typeof requestAnimationFrame === 'function') {
                        requestAnimationFrame(inicializar);
                    } else {
                        setTimeout(inicializar, 0);
                    }
                },
                willClose: () => {
                    if (botaoLimpar && limparHandler) {
                        botaoLimpar.removeEventListener('click', limparHandler);
                    }
                    if (controlador) {
                        controlador.destruir();
                        controlador = null;
                    }
                },
                preConfirm: () => {
                    const field = document.getElementById('final-signature-field');
                    if (!controlador || !controlador.possuiAssinatura()) {
                        field?.classList.add('invalid');
                        Swal.showValidationMessage('Colha a assinatura para finalizar o arm치rio.');
                        return false;
                    }
                    const imagem = controlador.obterImagem();
                    return imagem.replace('data:image/png;base64,', '');
                }
            });

            return resultado.isConfirmed ? resultado.value : null;
        }
        async function abrirMovimentacoes(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) return;
            movimentacaoArmarioAtual = id;
            elementos.movimentacaoModalTitle.textContent = `Movimenta칞칫es - Arm치rio ${armario.numero}`;
            elementos.movimentacaoForm.reset();
            atualizarResponsavelMovimentacaoInfo();
            const padraoLocal = obterDataHoraLocalPadrao();
            elementos.movData.value = padraoLocal.data;
            elementos.movHora.value = padraoLocal.hora;
            if (elementos.movimentacaoModal.style.display !== 'flex') {
                travaRolagem.aplicar();
            }
            elementos.movimentacaoModal.style.display = 'flex';
            mostrarLoadingMovimentacoes();
            await renderizarMovimentacoes(id);
        }

        function fecharMovimentacaoModal() {
            if (elementos.movimentacaoModal.style.display === 'flex') {
                travaRolagem.remover();
            }
            elementos.movimentacaoModal.style.display = 'none';
            movimentacaoArmarioAtual = null;
        }
        function mostrarLoadingMovimentacoes() {
            if (!elementos.movimentacoesList) return;
            elementos.movimentacoesList.innerHTML = `
                <div class="loading-state">
                    <span class="loading-spinner"></span>
                    Carregando movimenta칞칫es...
                </div>
            `;
        }
        function formatarTituloMovimento(tipo) {
            const mapa = {
                entrada: 'Entrada de pertences',
                saida: 'Sa칤da de pertences',
                conferencia: 'Confer칡ncia'
            };
            return mapa[tipo] || tipo;
        }
        function aplicarMascaraLeito(valor) {
            const texto = (valor || '').toString();
            const somenteAlfanumerico = texto.replace(/[^A-Za-z0-9]/g, '');

            const prefixoEncontrado = somenteAlfanumerico.match(/^[A-Za-z]+/);
            const prefixo = prefixoEncontrado ? prefixoEncontrado[0].toUpperCase() : '';
            const digitos = somenteAlfanumerico.slice(prefixo.length).replace(/\D/g, '');

            const primeiraParte = digitos.slice(0, 3);
            const restante = digitos.slice(3);

            let formatado = prefixo ? `${prefixo}-` : '';
            formatado += primeiraParte;

            if (restante) {
                formatado += `/${restante}`;
            }

            return formatado;
        }
        function aplicarMascaraLeitoCampo(campo) {
            if (!campo) return;
            const aplicarMascara = () => {
                const formatado = aplicarMascaraLeito(campo.value);
                if (campo.value !== formatado) {
                    campo.value = formatado;
                    try {
                        const pos = formatado.length;
                        campo.setSelectionRange(pos, pos);
                    } catch (erro) {
                        console.warn('N칚o foi poss칤vel ajustar o cursor do campo de leito.', erro);
                    }
                }
            };
            campo.addEventListener('input', aplicarMascara);
            aplicarMascara();
        }
        async function renderizarMovimentacoes(id) {
            if (!elementos.movimentacoesList) return;
            const armario = obterArmarioPorId(id) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(id));
            if (!armario) {
                elementos.movimentacoesList.innerHTML = '';
                const erro = document.createElement('div');
                erro.className = 'info-box';
                erro.textContent = 'Arm치rio n칚o encontrado para carregar movimenta칞칫es.';
                elementos.movimentacoesList.appendChild(erro);
                return;
            }
            const parametros = montarPayloadTermo(armario);
            const resultado = await callGoogleScript('getMovimentacoes', parametros);
            if (!resultado.success) {
                elementos.movimentacoesList.innerHTML = '';
                const erro = document.createElement('div');
                erro.className = 'info-box';
                erro.textContent = 'N칚o foi poss칤vel carregar as movimenta칞칫es.';
                elementos.movimentacoesList.appendChild(erro);
                notificarErroPadrao(resultado);
                return;
            }
            const lista = resultado.data;
            elementos.movimentacoesList.innerHTML = '';
            if (!lista.length) {
                const vazio = document.createElement('div');
                vazio.className = 'info-box';
                vazio.textContent = 'Nenhuma movimenta칞칚o registrada at칠 o momento.';
                elementos.movimentacoesList.appendChild(vazio);
                return;
            }
            lista.forEach(item => {
                const bloco = document.createElement('div');
                bloco.className = 'movimentacao-item';
                const responsavelTexto = item.responsavel ? item.responsavel : 'N칚o informado';
                bloco.innerHTML = `
                    <div class="movimentacao-header">
                        <span>${formatarTituloMovimento(item.tipo)}</span>
                        <span>${formatarData(item.data)} ${item.hora}</span>
                    </div>
                    <div class="movimentacao-meta">
                        <span><strong>Descri칞칚o:</strong> ${item.descricao}</span>
                        <span><strong>Respons치vel:</strong> ${responsavelTexto}</span>
                    </div>
                `;
                elementos.movimentacoesList.appendChild(bloco);
            });
        }

        async function salvarMovimentacao() {
            if (!movimentacaoArmarioAtual) return;
            if (movimentacaoEmProgresso) return;
            movimentacaoEmProgresso = true;
            try {
                const armario = obterArmarioPorId(movimentacaoArmarioAtual) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(movimentacaoArmarioAtual));
                if (!armario) {
                    mostrarErro('Arm치rio n칚o encontrado para registrar movimenta칞칚o.');
                    return;
                }
                const responsavelRegistro = obterDescricaoResponsavelAtual();
                if (!responsavelRegistro) {
                    mostrarErro('N칚o foi poss칤vel identificar o usu치rio respons치vel. Fa칞a login novamente para registrar movimenta칞칫es.');
                    return;
                }
                const identificadores = montarIdentificadoresArmario(armario);
                const tipoSelecionado = normalizarTexto(elementos.movTipo.value);
                const dados = {
                    armarioId: identificadores?.idPlanilha || '',
                    numeroArmario: identificadores?.numeroArmario || '',
                    tipo: tipoSelecionado || identificadores?.tipo || '',
                    tipoArmario: identificadores?.tipo || '',
                    descricao: elementos.movDescricao.value.trim(),
                    responsavel: responsavelRegistro,
                    data: elementos.movData.value,
                    hora: elementos.movHora.value
                };
                const resultado = await callGoogleScript('salvarMovimentacao', dados);
                if (resultado.success) {
                    await renderizarMovimentacoes(movimentacaoArmarioAtual);
                    mostrarSucesso('Movimenta칞칚o registrada com sucesso');
                    elementos.movimentacaoForm.reset();
                    elementos.movTipo.value = '';
                    const padraoLocal = obterDataHoraLocalPadrao();
                    elementos.movData.value = padraoLocal.data;
                    elementos.movHora.value = padraoLocal.hora;
                } else {
                    notificarErroPadrao(resultado);
                }
            } finally {
                movimentacaoEmProgresso = false;
            }
        }
        async function tratarAcaoTermo(evento) {
            const elementoAcao = evento.target.closest('[data-action]');
            if (!elementoAcao) return;
            const acao = elementoAcao.dataset.action;
            const id = extrairIdDataset(elementoAcao);
            if (!id) return;

            let finalizarLoading = () => {};
            if (elementoAcao.tagName === 'BUTTON') {
                finalizarLoading = iniciarLoadingBotao(elementoAcao);
            }

            try {
                switch (acao) {
                    case 'ver':
                        await exibirResumoTermo(id);
                        break;
                    case 'mov':
                        await abrirMovimentacoes(id);
                        break;
                    case 'encerrar':
                        await confirmarLiberacaoAcompanhante(id);
                        break;
                    case 'ver-pdf':
                        evento.preventDefault();
                        await verPDFTermo(id);
                        break;
                    case 'aplicar':
                        await abrirTermoWizard(id);
                        break;
                    case 'continuar':
                        await abrirTermoWizard(id);
                        break;
                    default:
                        break;
                }
            } finally {
                finalizarLoading();
            }
        }

        async function exibirResumoTermo(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Arm치rio n칚o encontrado');
                return;
            }
            // Buscar detalhes do termo
            const resultado = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: true }));
            if (!resultado.success) {
                mostrarErro('Termo n칚o encontrado');
                return;
            }
            const termo = resultado.data;
            const metodoFinalNormalizado = normalizarTexto(termo.metodoFinal);
            let metodoEncerramentoHtml = '';
            if (termo.metodoFinal) {
                let descricaoMetodo = 'Assinatura digital';
                if (metodoFinalNormalizado === 'cpf') {
                    descricaoMetodo = `Confirma칞칚o por CPF (${termo.cpfConfirmacao || ''})`;
                } else if (metodoFinalNormalizado === 'manual') {
                    descricaoMetodo = 'Finaliza칞칚o manual (sem assinatura digital)';
                }
                metodoEncerramentoHtml = `<p><strong>M칠todo de encerramento:</strong> ${descricaoMetodo}</p>`;
            }

            const html = `
                <p><strong>Paciente:</strong> ${termo.paciente}</p>
                <p><strong>Prontu치rio:</strong> ${termo.prontuario}</p>
                <p><strong>Setor:</strong> ${termo.setor}</p>
                <p><strong>Leito:</strong> ${termo.leito}</p>
                <p><strong>Acompanhante:</strong> ${termo.acompanhante}</p>
                ${termo.telefone ? `<p><strong>Telefone:</strong> ${termo.telefone}</p>` : ''}
                ${termo.documento ? `<p><strong>Documento:</strong> ${termo.documento}</p>` : ''}
                ${termo.parentesco ? `<p><strong>Parentesco:</strong> ${termo.parentesco}</p>` : ''}
                <p><strong>Volumes:</strong> ${termo.descricaoVolumes}</p>
                <p><strong>Aplicado em:</strong> ${formatarDataHora(termo.aplicadoEm)}</p>
                ${termo.finalizadoEm ? `<p><strong>Finalizado em:</strong> ${formatarDataHora(termo.finalizadoEm)}</p>` : '<p><strong>Status:</strong> Em andamento</p>'}
                ${metodoEncerramentoHtml}
            `;
            Swal.fire({
                title: `Termo - Arm치rio ${armario.numero}`,
                html,
                icon: 'info',
                confirmButtonText: 'Fechar'
            });
        }
        async function verPDFTermo(id) {
            const armario = obterArmarioPorId(id) || estado.armarios.find(item => normalizarIdentificador(item.idPlanilha) === normalizarIdentificador(id));
            if (!armario) {
                mostrarErro('Arm치rio n칚o encontrado');
                return;
            }
            const resultado = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: true }));
            if (resultado.success && resultado.data.pdfUrl) {
                window.open(resultado.data.pdfUrl, '_blank');
            } else {
                mostrarErro('PDF n칚o dispon칤vel para este termo');
            }
        }
        async function confirmarLiberacaoVisitante(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Arm치rio n칚o encontrado para libera칞칚o.');
                return;
            }
            const resumoHtml = `
                <div class="info-box" style="text-align:left;">
                    <p><strong>Visitante:</strong> ${armario.nomeVisitante || '-'}</p>
                    <p><strong>Paciente:</strong> ${armario.nomePaciente || '-'}</p>
                    <p><strong>Leito:</strong> ${armario.leito || '-'}</p>
                    <p><strong>Volumes:</strong> ${armario.volumes || '-'}</p>
                    <p><strong>In칤cio:</strong> ${armario.horaInicio || '-'}</p>
                    ${armario.visitaEstendida
                        ? '<p><strong>Visita:</strong> Estendida</p>'
                        : (armario.horaPrevista ? `<p><strong>Previs칚o de sa칤da:</strong> ${armario.horaPrevista}</p>` : '')}
                    ${armario.whatsapp ? `<p><strong>WhatsApp:</strong> ${armario.whatsapp}</p>` : ''}
                </div>
            `;
            const resultado = await Swal.fire({
                title: `Encerrar arm치rio ${armario.numero}?`,
                html: `${resumoHtml}<p style="margin-top:12px; color:#4b5563;">Confirme que as informa칞칫es est칚o corretas para finalizar o arm치rio do visitante.</p>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Confirmo a libera칞칚o',
                cancelButtonText: 'Cancelar',
                focusConfirm: false
            });
            if (!resultado.isConfirmed) {
                return;
            }
            await liberarArmario(id, 'visitante');
        }
        async function confirmarLiberacaoAcompanhante(id) {
            const armario = obterArmarioPorId(id);
            if (!armario) {
                mostrarErro('Arm치rio n칚o encontrado para libera칞칚o.');
                return;
            }
            const identificadores = montarIdentificadoresArmario(armario);

            const finalizarPreparacao = mostrarOverlayCarregamento('Preparando libera칞칚o do arm치rio...');
            let termoDados = null;
            try {
                const respostaTermo = await callGoogleScript('getTermo', montarPayloadTermo(armario, { incluirFinalizados: true }));
                if (respostaTermo.success && respostaTermo.data) {
                    termoDados = respostaTermo.data;
                } else if (respostaTermo.error && respostaTermo.error !== 'Termo n칚o encontrado') {
                    mostrarErro('N칚o foi poss칤vel carregar as informa칞칫es do termo. Atualize a lista e tente novamente.');
                    return;
                }
            } catch (erroBuscaTermo) {
                console.error('Erro ao buscar termo para libera칞칚o:', erroBuscaTermo);
                mostrarErro('N칚o foi poss칤vel carregar as informa칞칫es do termo. Tente novamente.');
                return;
            } finally {
                finalizarPreparacao();
            }

            if (termoDados) {
                armario.nomeVisitante = termoDados.acompanhante || armario.nomeVisitante;
                armario.nomePaciente = termoDados.paciente || armario.nomePaciente;
                armario.leito = termoDados.leito || armario.leito;
                if (termoDados.telefone) {
                    armario.whatsapp = termoDados.telefone;
                }
            }

            const paciente = termoDados?.paciente || armario.nomePaciente || '-';
            const prontuario = (termoDados?.prontuario || '').toString().trim();
            const setor = (termoDados?.setor || '').toString().trim();
            const leito = termoDados?.leito || armario.leito || '';
            const acompanhante = termoDados?.acompanhante || armario.nomeVisitante || '-';
            const telefone = (termoDados?.telefone || armario.whatsapp || '').toString().trim();
            const documento = (termoDados?.documento || '').toString().trim();
            const parentesco = (termoDados?.parentesco || '').toString().trim();
            const inicioUso = (armario.horaInicio || '').toString().trim();
            const aplicadoEmBruto = termoDados?.aplicadoEm ? formatarDataHora(termoDados.aplicadoEm) : '';
            const aplicadoEm = aplicadoEmBruto && aplicadoEmBruto !== '-' ? aplicadoEmBruto : '';
            const setorLeito = [setor, leito].map(valor => (valor || '').toString().trim()).filter(Boolean).join('  ');
            const volumesResumo = (() => {
                if (termoDados?.descricaoVolumes) {
                    return termoDados.descricaoVolumes;
                }
                if (Array.isArray(termoDados?.volumes) && termoDados.volumes.length) {
                    return termoDados.volumes
                        .map(volume => {
                            const quantidadeNumero = Number(volume.quantidade);
                            const quantidadeTexto = Number.isFinite(quantidadeNumero) && quantidadeNumero > 0
                                ? `${quantidadeNumero}x`
                                : '';
                            const descricaoTexto = (volume.descricao || '').toString().trim();
                            return [quantidadeTexto, descricaoTexto].filter(Boolean).join(' ');
                        })
                        .filter(Boolean)
                        .join('; ');
                }
                const valorBruto = armario.volumes;
                if (valorBruto !== undefined && valorBruto !== null && valorBruto !== '') {
                    const numero = Number(valorBruto);
                    if (!Number.isNaN(numero)) {
                        return numero > 0 ? `${numero} volume(s)` : 'Nenhum volume informado';
                    }
                    return valorBruto;
                }
                return 'N칚o informado';
            })();

            const resumoHtml = `
                <div class="info-box" style="text-align:left;">
                    <p><strong>Acompanhante:</strong> ${acompanhante}</p>
                    <p><strong>Paciente:</strong> ${paciente}</p>
                    ${prontuario ? `<p><strong>Prontu치rio:</strong> ${prontuario}</p>` : ''}
                    ${setorLeito ? `<p><strong>Setor/Leito:</strong> ${setorLeito}</p>` : ''}
                    <p><strong>Volumes declarados:</strong> ${volumesResumo}</p>
                    ${inicioUso ? `<p><strong>In칤cio:</strong> ${inicioUso}</p>` : ''}
                    ${aplicadoEm ? `<p><strong>Aplicado em:</strong> ${aplicadoEm}</p>` : ''}
                    ${telefone ? `<p><strong>Contato:</strong> ${telefone}</p>` : ''}
                    ${documento ? `<p><strong>Documento:</strong> ${documento}</p>` : ''}
                    ${parentesco ? `<p><strong>Parentesco:</strong> ${parentesco}</p>` : ''}
                </div>
            `;

            const resultadoConfirmacao = await Swal.fire({
                title: `Encerrar arm치rio ${armario.numero}?`,
                html: `${resumoHtml}<p style="margin-top:12px; color:#4b5563;">Confirme que as informa칞칫es est칚o corretas para finalizar o arm치rio do acompanhante.</p>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Confirmo a libera칞칚o',
                cancelButtonText: 'Cancelar',
                focusConfirm: false
            });

            if (!resultadoConfirmacao.isConfirmed) {
                return;
            }

            const assinaturaFinalBase64 = await coletarAssinaturaEncerramento(acompanhante);
            if (!assinaturaFinalBase64) {
                await Swal.fire({
                    title: 'Libera칞칚o cancelada',
                    text: 'A assinatura de encerramento n칚o foi coletada. O arm치rio permanecer치 ativo.',
                    icon: 'info',
                    confirmButtonText: 'Entendi'
                });
                return;
            }

            const metodo = 'assinatura';
            const confirmacao = '';
            let mensagemSucesso = 'Termo finalizado e arm치rio liberado com sucesso';
            const usuarioResponsavel = obterDescricaoResponsavelAtual();

            const progressoHtml = `
                <div class="liberacao-progress" aria-label="Progresso da libera칞칚o do arm치rio">
                    <div class="liberacao-step is-active" data-step="termo">
                        <div class="liberacao-step-icon" aria-hidden="true">
                            <span class="liberacao-step-spinner"></span>
                            <i class="fas fa-check"></i>
                            <i class="fas fa-circle-exclamation"></i>
                        </div>
                        <div>
                            <div class="liberacao-step-title">Finalizando termo</div>
                            <div class="liberacao-step-subtitle">Registrando o encerramento com seguran칞a.</div>
                        </div>
                    </div>
                    <div class="liberacao-step" data-step="armario">
                        <div class="liberacao-step-icon" aria-hidden="true">
                            <span class="liberacao-step-spinner"></span>
                            <i class="fas fa-check"></i>
                            <i class="fas fa-circle-exclamation"></i>
                        </div>
                        <div>
                            <div class="liberacao-step-title">Liberando arm치rio</div>
                            <div class="liberacao-step-subtitle">Atualizando a disponibilidade para o pr칩ximo uso.</div>
                        </div>
                    </div>
                </div>
            `;

            const atualizarEtapa = (etapa, estado) => {
                const container = Swal.getHtmlContainer();
                if (!container) return;
                const elemento = container.querySelector(`[data-step="${etapa}"]`);
                if (!elemento) return;
                elemento.classList.remove('is-active', 'is-complete', 'is-error');
                switch (estado) {
                    case 'ativa':
                        elemento.classList.add('is-active');
                        break;
                    case 'concluida':
                        elemento.classList.add('is-complete');
                        break;
                    case 'erro':
                        elemento.classList.add('is-error');
                        break;
                    default:
                        break;
                }
            };
            const aguardarTransicao = (tempo = 25) => new Promise(resolve => setTimeout(resolve, tempo));

            Swal.fire({
                title: 'Concluindo a libera칞칚o do arm치rio...',
                html: progressoHtml,
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    const container = Swal.getHtmlContainer();
                    if (container) {
                        container.setAttribute('aria-live', 'assertive');
                    }
                    atualizarEtapa('termo', 'ativa');
                }
            });

            let etapaAtual = 'termo';

            try {
                const resultadoFinalizacao = await callGoogleScript('finalizarTermo', {
                    armarioId: identificadores?.idPlanilha || '',
                    numeroArmario: identificadores?.numeroArmario || '',
                    metodo,
                    assinaturaFinal: assinaturaFinalBase64,
                    confirmacao,
                    usuarioResponsavel,
                    tipo: identificadores?.tipo || ''
                });

                if (!resultadoFinalizacao.success) {
                    const mensagemErro = (resultadoFinalizacao.error || '').toString();
                    const erroNormalizado = mensagemErro.toLowerCase();
                    const erroSemAcento = erroNormalizado.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    const termoNaoEncontrado = erroNormalizado.includes('termo n칚o localizado')
                        || erroSemAcento.includes('termo nao localizado');

                    if (!termoNaoEncontrado) {
                        atualizarEtapa('termo', 'erro');
                        await aguardarTransicao();
                        Swal.close();
                        notificarErroPadrao(resultadoFinalizacao, 'N칚o foi poss칤vel finalizar o termo.');
                        return;
                    }

                    mensagemSucesso = 'Arm치rio liberado com sucesso. Termo n칚o localizado para finaliza칞칚o.';
                }

                atualizarEtapa('termo', 'concluida');
                etapaAtual = 'armario';
                atualizarEtapa('armario', 'ativa');

                const resultadoLiberacao = await callGoogleScript('liberarArmario', {
                    id: identificadores?.idPlanilha || '',
                    tipo: 'acompanhante',
                    numero: identificadores?.numeroArmario || ''
                });

                if (!resultadoLiberacao.success) {
                    atualizarEtapa('armario', 'erro');
                    await aguardarTransicao();
                    Swal.close();
                    notificarErroPadrao(resultadoLiberacao);
                    return;
                }

                atualizarEtapa('armario', 'concluida');
                await aguardarTransicao();
                Swal.close();

                await atualizarDadosPosOperacao('Atualizando status do arm치rio...', () => {
                    garantirArmarioLiberadoLocal(id, metodo, confirmacao);
                    atualizarResumoDashboardLocal();
                });
                mostrarSucesso(mensagemSucesso);
            } catch (erro) {
                console.error('Erro ao liberar arm치rio de acompanhante:', erro);
                atualizarEtapa(etapaAtual, 'erro');
                await aguardarTransicao();
                Swal.close();
                mostrarErro('N칚o foi poss칤vel concluir a libera칞칚o. Tente novamente.');
            }
        }
        // Atualizar painel de notifica칞칫es
        function atualizarPainelNotificacoes() {
            const notificationList = elementos.notificationPanel.querySelector('.notification-list');
            notificationList.innerHTML = '';
           
            estado.notificacoes.forEach(notificacao => {
                const item = document.createElement('div');
                item.className = 'notification-item';
               
                item.innerHTML = `
                    <div class="notification-icon ${notificacao.tipo}">
                        <i class="fas ${notificacao.tipo === 'danger' ? 'fa-exclamation' : 'fa-clock'}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notificacao.titulo}</div>
                        <div class="notification-time">${notificacao.tempo}</div>
                    </div>
                `;
               
                notificationList.appendChild(item);
            });
        }
       
        // Fun칞칫es globais para uso nos eventos HTML
        window.abrirModalArmario = abrirModalArmario;
        window.liberarArmario = liberarArmario;
        window.usarArmario = usarArmario;
        window.abrirTermoDireto = abrirTermoDireto;
        window.abrirMovimentacoes = abrirMovimentacoes;
    </script>
